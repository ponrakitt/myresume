<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultra Secure Password Manager (Auto Sync & Merge)</title>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Crypto JS for Encryption -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <!-- OTPAuth (For 2FA Logic) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/otpauth/9.1.4/otpauth.umd.min.js"></script>
    <!-- QRious (For generating QR Code) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-[#0f172a] min-h-screen flex items-center justify-center p-4 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-slate-800 via-slate-900 to-black text-slate-800 overflow-hidden">

    <div id="root" class="w-full max-w-5xl h-[85vh] flex flex-col relative z-10"></div>
    
    <div class="fixed top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-0">
        <div class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-indigo-600/20 rounded-full blur-[120px]"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-emerald-600/10 rounded-full blur-[120px]"></div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons ---
        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Icons = {
            Lock: (p) => <IconBase {...p}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></IconBase>,
            Unlock: (p) => <IconBase {...p}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 9.9-1"></path></IconBase>,
            Eye: (p) => <IconBase {...p}><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></IconBase>,
            EyeOff: (p) => <IconBase {...p}><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07-2.3 2.3"></path><line x1="1" y1="1" x2="23" y2="23"></line></IconBase>,
            RefreshCw: (p) => <IconBase {...p}><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></IconBase>,
            Search: (p) => <IconBase {...p}><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></IconBase>,
            Plus: (p) => <IconBase {...p}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></IconBase>,
            Trash2: (p) => <IconBase {...p}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></IconBase>,
            Cloud: (p) => <IconBase {...p}><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></IconBase>,
            CloudOff: (p) => <IconBase {...p}><path d="M22.61 16.95A5 5 0 0 0 18 10h-1.26a8 8 0 0 0-7.05-6M5 5a8 8 0 0 0 4 15h9a5 5 0 0 0 1.7-.3"></path><line x1="1" y1="1" x2="23" y2="23"></line></IconBase>,
            ShieldCheck: (p) => <IconBase {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><polyline points="9 12 11 14 15 10"></polyline></IconBase>,
            Key: (p) => <IconBase {...p}><path d="m21 16-2 2-2-2-3 3-5.25-5.25a3.75 3.75 0 1 0-1.5 1.5L12 15l2-2 2 2 2-2 3 3"></path></IconBase>,
            LogOut: (p) => <IconBase {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></IconBase>,
            Clock: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></IconBase>,
            AlertTriangle: (p) => <IconBase {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></IconBase>,
            Smartphone: (p) => <IconBase {...p}><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></IconBase>,
            QrCode: (p) => <IconBase {...p}><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></IconBase>,
            Globe: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></IconBase>,
            CreditCard: (p) => <IconBase {...p}><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></IconBase>,
            Hash: (p) => <IconBase {...p}><line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line></IconBase>,
            DownloadCloud: (p) => <IconBase {...p}><polyline points="8 17 12 21 16 17"></polyline><line x1="12" y1="12" x2="12" y2="21"></line><path d="M20.88 18.09A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.29"></path></IconBase>,
            CheckCircle: (p) => <IconBase {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></IconBase>,
            RotateCw: (p) => <IconBase {...p}><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path></IconBase>
        };
        const { Lock, Unlock, Eye, EyeOff, Save, RefreshCw, Search, Plus, Trash2, Cloud, CloudOff, ShieldCheck, Key, LogOut, Clock, AlertTriangle, Smartphone, QrCode, Globe, CreditCard, Hash, DownloadCloud, CheckCircle, RotateCw } = Icons;

        // --- Security Utils ---
        const deriveKey = (password, salt) => CryptoJS.PBKDF2(password, salt, { keySize: 256 / 32, iterations: 10000 });
        const encryptData = (data, password) => {
            try {
                const salt = CryptoJS.lib.WordArray.random(128 / 8);
                const key = deriveKey(password, salt);
                const iv = CryptoJS.lib.WordArray.random(128 / 8);
                const encrypted = CryptoJS.AES.encrypt(JSON.stringify(data), key, { iv: iv, padding: CryptoJS.pad.Pkcs7, mode: CryptoJS.mode.CBC });
                return JSON.stringify({ s: salt.toString(CryptoJS.enc.Hex), iv: iv.toString(CryptoJS.enc.Hex), ct: encrypted.ciphertext.toString(CryptoJS.enc.Base64) });
            } catch (e) { return null; }
        };
        const decryptData = (packedJson, password) => {
            try {
                let packet; try { packet = JSON.parse(packedJson); } catch(e) { return null; }
                if (!packet.s || !packet.iv || !packet.ct) return null;
                const salt = CryptoJS.enc.Hex.parse(packet.s);
                const iv = CryptoJS.enc.Hex.parse(packet.iv);
                const ciphertext = CryptoJS.enc.Base64.parse(packet.ct);
                const key = deriveKey(password, salt);
                const decrypted = CryptoJS.AES.decrypt({ ciphertext: ciphertext }, key, { iv: iv, padding: CryptoJS.pad.Pkcs7, mode: CryptoJS.mode.CBC });
                const decryptedStr = decrypted.toString(CryptoJS.enc.Utf8);
                return decryptedStr ? JSON.parse(decryptedStr) : null;
            } catch (e) { return null; }
        };

        // --- Helper: Merge Logic ---
        const mergeDatasets = (localData, cloudData) => {
            const localEntries = localData.entries || [];
            const cloudEntries = cloudData.entries || [];
            const mergedMap = new Map();
            // Start with all local
            localEntries.forEach(e => mergedMap.set(e.id, e));
            // Merge cloud: if exists, pick newer. if not, add.
            cloudEntries.forEach(cloudE => {
                if (mergedMap.has(cloudE.id)) {
                    const localE = mergedMap.get(cloudE.id);
                    if (new Date(cloudE.updatedAt) > new Date(localE.updatedAt)) {
                        mergedMap.set(cloudE.id, cloudE);
                    }
                } else {
                    mergedMap.set(cloudE.id, cloudE);
                }
            });
            // Priority to cloud settings if 2FA enabled
            const mergedSettings = cloudData.settings?.is2FAEnabled ? cloudData.settings : (localData.settings || {});
            return { entries: Array.from(mergedMap.values()), settings: mergedSettings };
        };

        // --- Password Generator ---
        const PasswordGenerator = ({ onSelect }) => {
            const [length, setLength] = useState(16);
            const [generated, setGenerated] = useState('');
            const [options, setOptions] = useState({ uppercase: true, numbers: true, symbols: true });
            const generate = () => {
                const chars = "abcdefghijklmnopqrstuvwxyz" + (options.uppercase ? "ABCDEFGHIJKLMNOPQRSTUVWXYZ" : "") + (options.numbers ? "0123456789" : "") + (options.symbols ? "!@#$%^&*()_+-=[]{}|;:,.<>?" : "");
                let pass = "";
                for (let i = 0; i < length; i++) pass += chars.charAt(Math.floor(Math.random() * chars.length));
                setGenerated(pass);
            };
            useEffect(() => { generate(); }, [length, options]);
            return (
                <div className="bg-slate-50/50 p-4 rounded-xl mb-4 border border-slate-200/60">
                    <h3 className="font-semibold text-slate-700 mb-2 flex items-center gap-2 text-xs uppercase tracking-wider"><Key size={14} className="text-indigo-500" /> สร้างรหัสผ่าน</h3>
                    <div className="flex gap-2 mb-2"><input type="text" readOnly value={generated} className="flex-1 p-2 bg-white border border-slate-200 rounded font-mono text-center tracking-wider text-slate-700 shadow-sm outline-none" /><button onClick={generate} className="p-2 bg-white text-indigo-600 border border-indigo-100 rounded hover:bg-indigo-50"><RefreshCw size={18} /></button></div>
                    <div className="flex flex-wrap items-center gap-3 text-xs mb-2 text-slate-600">
                        <label className="flex items-center gap-1 cursor-pointer"><input type="checkbox" checked={options.uppercase} onChange={e => setOptions({...options, uppercase: e.target.checked})} /> A-Z</label>
                        <label className="flex items-center gap-1 cursor-pointer"><input type="checkbox" checked={options.numbers} onChange={e => setOptions({...options, numbers: e.target.checked})} /> 0-9</label>
                        <label className="flex items-center gap-1 cursor-pointer"><input type="checkbox" checked={options.symbols} onChange={e => setOptions({...options, symbols: e.target.checked})} /> !@#</label>
                        <div className="flex items-center gap-1 ml-auto"><span className="text-slate-400">Len: {length}</span><input type="range" min="8" max="32" value={length} onChange={e => setLength(parseInt(e.target.value))} className="w-16" /></div>
                    </div>
                    <button onClick={() => onSelect(generated)} className="w-full py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 font-medium transition text-sm">ใช้รหัสนี้</button>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [masterKey, setMasterKey] = useState(null);
            const [inputKey, setInputKey] = useState('');
            const [isLocked, setIsLocked] = useState(true);
            const [dataStore, setDataStore] = useState({ entries: [], settings: { twoFactorSecret: null, is2FAEnabled: false } });
            
            const [view, setView] = useState('list');
            const [search, setSearch] = useState('');
            const [formData, setFormData] = useState({ site: '', username: '', password: '', notes: '', expiryDays: 90, category: 'website' });
            const [editId, setEditId] = useState(null);
            const [showPass, setShowPass] = useState(false);
            const [syncUrl, setSyncUrl] = useState(localStorage.getItem('pass_manager_sync_url') || 'https://script.google.com/macros/s/AKfycbzTtIAykLNYDOFbUWzo0n3BZ9AddpUu8CsuA93uvhZIkUe3zfSGwByarTsF51yvKaw_fg/exec');
            const [isSyncing, setIsSyncing] = useState(false);
            const [syncStatus, setSyncStatus] = useState('');

            const [is2FAChallenging, setIs2FAChallenging] = useState(false);
            const [twoFACode, setTwoFACode] = useState('');
            const [setup2FASecret, setSetup2FASecret] = useState(null);
            const [setup2FACode, setSetup2FACode] = useState('');

            // --- SMART SYNC & ACTION HANDLER ---
            // This function handles ALL modifications (Add/Edit/Delete) by:
            // 1. Fetching latest cloud data
            // 2. Merging
            // 3. Applying the specific user action
            // 4. Saving and Pushing
            const performSafeAction = async (actionCallback) => {
                setIsSyncing(true);
                setSyncStatus('กำลังซิงค์ข้อมูลล่าสุด...');
                
                let currentData = { ...dataStore };

                // 1. Fetch & Merge first (if online)
                if (syncUrl) {
                    try {
                        const response = await fetch(`${syncUrl}?action=get`);
                        const json = await response.json();
                        if (json.data) {
                            const decryptedCloud = decryptData(json.data, masterKey);
                            if (decryptedCloud) {
                                // Merge cloud data into current local state
                                currentData = mergeDatasets(currentData, decryptedCloud);
                            }
                        }
                    } catch (e) { console.warn("Fetch failed, working offline first", e); }
                }

                // 2. Apply User Action (Add/Delete/Update) on the Merged Data
                const newData = actionCallback(currentData);

                // 3. Save to Local
                setDataStore(newData);
                const encrypted = encryptData(newData, masterKey);
                localStorage.setItem('pass_manager_data', encrypted);

                // 4. Push Result to Cloud
                if (syncUrl) {
                    setSyncStatus('กำลังบันทึกไปยัง Cloud...');
                    try {
                        await fetch(syncUrl, { 
                            method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' }, 
                            body: JSON.stringify({ action: 'save', data: encrypted }) 
                        });
                        setSyncStatus('บันทึกเรียบร้อย');
                    } catch (e) { setSyncStatus('บันทึกในเครื่องแล้ว (Offline)'); }
                } else {
                    setSyncStatus('บันทึกในเครื่องเรียบร้อย');
                }
                
                setTimeout(() => setSyncStatus(''), 2000);
                setIsSyncing(false);
            };

            const handleUnlock = async () => {
                if (!inputKey) return;
                
                // Attempt to load local first for speed
                const storedData = localStorage.getItem('pass_manager_data');
                let localDecrypted = storedData ? decryptData(storedData, inputKey) : null;
                
                if (!localDecrypted) {
                    // Try fetch from cloud if local fails (fresh device)
                    if (syncUrl) {
                        try {
                            setIsSyncing(true);
                            const response = await fetch(`${syncUrl}?action=get`);
                            const json = await response.json();
                            if (json.data) {
                                localDecrypted = decryptData(json.data, inputKey);
                            }
                        } catch(e) {} finally { setIsSyncing(false); }
                    }
                }

                if (localDecrypted) {
                    const parsedData = localDecrypted.entries ? localDecrypted : { entries: localDecrypted, settings: { twoFactorSecret: null, is2FAEnabled: false } };
                    
                    if (parsedData.settings?.is2FAEnabled) {
                        setDataStore(parsedData);
                        setMasterKey(inputKey);
                        setIs2FAChallenging(true);
                    } else {
                        setDataStore(parsedData);
                        setMasterKey(inputKey);
                        setIsLocked(false);
                        // Trigger background sync after unlock
                        setTimeout(() => performSafeAction(d => d), 500); 
                    }
                } else {
                    if (confirm("รหัสผิด หรือไม่พบข้อมูล\nสร้างฐานข้อมูลใหม่ด้วยรหัสนี้?")) {
                        setMasterKey(inputKey);
                        setIsLocked(false);
                        setDataStore({ entries: [], settings: { is2FAEnabled: false } });
                    }
                }
            };

            const handle2FAVerify = (e) => {
                e.preventDefault();
                const totp = new OTPAuth.TOTP({ algorithm: 'SHA1', digits: 6, period: 30, secret: OTPAuth.Secret.fromBase32(dataStore.settings.twoFactorSecret) });
                if (totp.validate({ token: twoFACode, window: 1 }) !== null) {
                    setIs2FAChallenging(false);
                    setIsLocked(false);
                    setTwoFACode('');
                    // Background sync after login
                    setTimeout(() => performSafeAction(d => d), 500);
                } else { alert("รหัส 2FA ไม่ถูกต้อง"); }
            };

            // --- CRUD ---
            const handleDelete = (id) => {
                if (confirm("ยืนยันการลบ? ข้อมูลจะถูกลบจาก Cloud ด้วย")) {
                    performSafeAction((currentData) => {
                        const newEntries = currentData.entries.filter(e => e.id !== id);
                        return { ...currentData, entries: newEntries };
                    });
                }
            };

            const handleSaveEntry = () => {
                if (!formData.site || !formData.password) return alert("กรุณากรอกข้อมูล");
                performSafeAction((currentData) => {
                    const now = new Date().toISOString();
                    let newEntries = [...currentData.entries];
                    if (editId) {
                        newEntries = newEntries.map(e => e.id === editId ? { ...formData, id: editId, updatedAt: now } : e);
                    } else {
                        newEntries.push({ ...formData, id: Date.now(), updatedAt: now });
                    }
                    return { ...currentData, entries: newEntries };
                });
                setFormData({ site: '', username: '', password: '', notes: '', expiryDays: 90, category: 'website' });
                setEditId(null);
                setView('list');
            };

            // --- 2FA Settings ---
            const confirm2FASetup = () => {
                const totp = new OTPAuth.TOTP({ algorithm: 'SHA1', digits: 6, period: 30, secret: OTPAuth.Secret.fromBase32(setup2FASecret) });
                if (totp.validate({ token: setup2FACode, window: 1 }) !== null) {
                    performSafeAction((currentData) => {
                        return { ...currentData, settings: { is2FAEnabled: true, twoFactorSecret: setup2FASecret } };
                    });
                    setSetup2FASecret(null);
                    setSetup2FACode('');
                    alert("เปิดใช้งาน 2FA และซิงค์การตั้งค่าเรียบร้อยแล้ว");
                } else { alert("รหัสไม่ถูกต้อง"); }
            };

            const disable2FA = () => {
                if(confirm("ปิด 2FA?")) {
                    performSafeAction((currentData) => {
                        return { ...currentData, settings: { is2FAEnabled: false, twoFactorSecret: null } };
                    });
                }
            };

            // --- UI Helpers ---
            const openEdit = (entry) => { setFormData({ ...entry, expiryDays: entry.expiryDays || 90, category: entry.category || 'website' }); setEditId(entry.id); setView('add'); };
            const checkExpiry = (updatedAt, days) => { if (!days || days === '0') return { expired: false, daysLeft: null }; const diff = Math.ceil((new Date(new Date(updatedAt).getTime() + (parseInt(days)*86400000)) - new Date()) / 86400000); return { expired: diff <= 0, daysLeft: diff }; };
            const getCategoryStyle = (cat) => {
                switch(cat) {
                    case 'app': return { icon: <Smartphone size={24} />, color: 'bg-indigo-100 text-indigo-600', label: 'App' };
                    case 'banking': return { icon: <CreditCard size={24} />, color: 'bg-emerald-100 text-emerald-600', label: 'Bank' };
                    case 'other': return { icon: <Hash size={24} />, color: 'bg-slate-100 text-slate-600', label: 'Other' };
                    default: return { icon: <Globe size={24} />, color: 'bg-blue-100 text-blue-600', label: 'Web' };
                }
            };

            // --- Views ---
            if (isLocked) {
                return (
                    <div className="flex flex-col items-center justify-center h-full w-full fade-in">
                        <div className="glass-panel p-10 rounded-3xl shadow-2xl w-full max-w-md mx-auto text-center border border-white/40 relative">
                            {is2FAChallenging ? (
                                <>
                                    <div className="bg-indigo-50 w-20 h-20 rounded-2xl flex items-center justify-center mx-auto mb-6"><Smartphone className="text-indigo-600" size={40} /></div>
                                    <h1 className="text-2xl font-bold mb-2">Two-Factor Auth</h1>
                                    <form onSubmit={handle2FAVerify}>
                                        <input type="text" className="w-full p-4 rounded-xl border border-indigo-200 text-center text-2xl tracking-[1em] mb-6" maxLength="6" value={twoFACode} onChange={e => setTwoFACode(e.target.value)} autoFocus />
                                        <button className="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl hover:bg-indigo-700">Verify</button>
                                        <button type="button" onClick={() => { setIs2FAChallenging(false); setInputKey(''); }} className="mt-4 text-sm text-slate-400">Cancel</button>
                                    </form>
                                </>
                            ) : (
                                <>
                                    <div className="bg-slate-50 w-20 h-20 rounded-2xl flex items-center justify-center mx-auto mb-8"><ShieldCheck className="text-indigo-600" size={40} /></div>
                                    <h1 className="text-3xl font-bold mb-8 text-slate-800">My Vault</h1>
                                    <input type="password" value={inputKey} onChange={(e) => setInputKey(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleUnlock()} placeholder="Master Password" className="w-full p-4 rounded-xl border border-slate-200 text-center text-lg mb-6" />
                                    <button onClick={handleUnlock} disabled={isSyncing} className="w-full bg-slate-900 text-white font-semibold py-4 rounded-xl hover:bg-slate-800 flex justify-center items-center gap-2">
                                        {isSyncing ? <RotateCw className="spin" size={20}/> : <Unlock size={20} />} Unlock
                                    </button>
                                </>
                            )}
                        </div>
                    </div>
                );
            }

            const filtered = (dataStore.entries || []).filter(e => e.site.toLowerCase().includes(search.toLowerCase()) || e.username.toLowerCase().includes(search.toLowerCase()));

            return (
                <div className="bg-white/90 backdrop-blur-xl rounded-3xl shadow-2xl overflow-hidden h-full flex flex-col border border-white/20 fade-in">
                    <header className="bg-white/50 border-b border-slate-200/60 p-5 flex justify-between items-center z-20">
                        <div className="flex items-center gap-3">
                            <div className="bg-indigo-600 p-2 rounded-lg shadow-lg"><ShieldCheck size={24} className="text-white" /></div>
                            <div>
                                <h1 className="font-bold text-xl text-slate-800">My Vault</h1>
                                <p className="text-xs text-slate-500 font-medium mt-0.5 flex items-center gap-1">{dataStore.settings.is2FAEnabled ? <span className="text-emerald-600 flex items-center gap-0.5"><Smartphone size={10}/> 2FA On</span> : "2FA Off"}</p>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => performSafeAction(d => d)} className="p-2.5 rounded-xl hover:bg-indigo-50 text-indigo-600" title="Sync Now"><RotateCw size={20} className={isSyncing ? "spin" : ""} /></button>
                            <button onClick={() => { setView('settings'); setSetup2FASecret(null); }} className={`p-2.5 rounded-xl hover:bg-slate-100 ${view === 'settings' ? 'bg-indigo-50 text-indigo-600' : 'text-slate-500'}`}><Cloud size={20} /></button>
                            <button onClick={handleLogout} className="p-2.5 rounded-xl hover:bg-red-50 text-slate-400 hover:text-red-500"><LogOut size={20} /></button>
                        </div>
                    </header>

                    {view !== 'settings' && (
                        <div className="px-6 py-4 bg-slate-50/50 flex flex-col sm:flex-row gap-4 justify-between items-center z-10">
                            <div className="relative w-full sm:w-72"><Search className="absolute left-3.5 top-3 text-slate-400" size={18} /><input type="text" placeholder="Search..." value={search} onChange={(e) => setSearch(e.target.value)} className="w-full pl-11 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white outline-none" /></div>
                            <div className="flex gap-2 w-full sm:w-auto">
                                <button onClick={() => { setEditId(null); setFormData({site:'', username:'', password:'', notes:'', expiryDays: 90, category: 'website'}); setView('add'); }} className="flex-1 bg-indigo-600 text-white px-5 py-2.5 rounded-xl shadow-lg hover:-translate-y-0.5 transition flex items-center gap-2 font-medium justify-center"><Plus size={18} /> New</button>
                                {view === 'add' && <button onClick={() => setView('list')} className="px-5 py-2.5 text-slate-600 hover:bg-slate-200 rounded-xl">Cancel</button>}
                            </div>
                        </div>
                    )}

                    <main className="flex-1 p-6 overflow-y-auto bg-slate-50/30">
                        {view === 'settings' && (
                            <div className="max-w-xl mx-auto space-y-6">
                                <div className="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm">
                                    <h2 className="font-bold text-slate-800 mb-4 flex items-center gap-2"><Cloud className="text-blue-500"/> Connection</h2>
                                    <input type="text" value={syncUrl} onChange={(e) => { setSyncUrl(e.target.value); localStorage.setItem('pass_manager_sync_url', e.target.value); }} className="w-full p-3 rounded-lg border border-slate-200 text-sm font-mono mb-2" placeholder="Script URL" />
                                    <p className="text-xs text-slate-400">Status: {syncUrl ? "Connected (Auto-Sync Active)" : "Offline Mode"}</p>
                                </div>
                                <div className="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm">
                                    <h2 className="font-bold text-slate-800 mb-4 flex items-center gap-2"><Smartphone className="text-indigo-500"/> 2FA Setup</h2>
                                    {!dataStore.settings.is2FAEnabled ? (
                                        !setup2FASecret ? <button onClick={() => { const s = new OTPAuth.Secret({size:20}); setSetup2FASecret(s.base32); setTimeout(() => new QRious({element:document.getElementById('qr'), value: new OTPAuth.TOTP({issuer:"MyVault",label:"User",algorithm:"SHA1",digits:6,period:30,secret:s}).toString(), size:200}), 100); }} className="bg-indigo-600 text-white px-4 py-2 rounded-lg">Setup 2FA</button> : 
                                        <div className="text-center"><canvas id="qr" className="mx-auto mb-4 border rounded"></canvas><div className="flex gap-2 justify-center"><input placeholder="Code" className="border p-2 rounded w-32 text-center" maxLength="6" onChange={e => setSetup2FACode(e.target.value)} /><button onClick={confirm2FASetup} className="bg-emerald-500 text-white px-4 rounded">Confirm</button></div></div>
                                    ) : <div className="flex justify-between items-center"><span className="text-emerald-600 font-bold">Active</span><button onClick={disable2FA} className="text-red-500 border border-red-200 px-3 py-1 rounded">Disable</button></div>}
                                </div>
                                <button onClick={() => setView('list')} className="w-full text-center text-slate-400 hover:text-slate-600">Back</button>
                            </div>
                        )}

                        {view === 'add' && (
                            <div className="max-w-xl mx-auto bg-white p-8 rounded-2xl shadow-xl border border-slate-100">
                                <h2 className="text-xl font-bold mb-6 text-slate-800">{editId ? 'Edit Entry' : 'New Entry'}</h2>
                                <div className="space-y-4">
                                    <div className="grid grid-cols-4 gap-2">
                                        {[{id:'website',l:'Web',i:<Globe/>},{id:'app',l:'App',i:<Smartphone/>},{id:'banking',l:'Bank',i:<CreditCard/>},{id:'other',l:'Other',i:<Hash/>}].map(c => (
                                            <button key={c.id} onClick={() => setFormData({...formData, category: c.id})} className={`p-2 flex flex-col items-center rounded border ${formData.category === c.id ? 'bg-slate-800 text-white' : 'hover:bg-slate-50'}`}>{c.i}<span className="text-xs">{c.l}</span></button>
                                        ))}
                                    </div>
                                    <input className="w-full p-3 border rounded-lg" placeholder="Name" value={formData.site} onChange={e => setFormData({...formData, site: e.target.value})} />
                                    <input className="w-full p-3 border rounded-lg" placeholder="Username" value={formData.username} onChange={e => setFormData({...formData, username: e.target.value})} />
                                    <div className="relative"><input type={showPass?"text":"password"} className="w-full p-3 border rounded-lg pr-10 font-mono" placeholder="Password" value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} /><button onClick={()=>setShowPass(!showPass)} className="absolute right-3 top-3 text-slate-400">{showPass?<EyeOff/>:<Eye/>}</button></div>
                                    <div className="flex gap-2 items-center text-sm text-slate-500"><Clock size={14}/> Alert in: {[30,90,180].map(d => <button key={d} onClick={()=>setFormData({...formData, expiryDays:d})} className={`px-2 py-1 border rounded ${formData.expiryDays===d?'bg-indigo-600 text-white':''}`}>{d}</button>)} <button onClick={()=>setFormData({...formData, expiryDays:0})} className={`px-2 py-1 border rounded ${formData.expiryDays===0?'bg-indigo-600 text-white':''}`}>None</button></div>
                                    <PasswordGenerator onSelect={p => setFormData({...formData, password: p})} />
                                    <textarea className="w-full p-3 border rounded-lg h-20" placeholder="Notes" value={formData.notes} onChange={e => setFormData({...formData, notes: e.target.value})}></textarea>
                                    <button onClick={handleSaveEntry} className="w-full bg-slate-900 text-white py-3 rounded-lg font-bold shadow-lg">Save</button>
                                </div>
                            </div>
                        )}

                        {view === 'list' && (
                            <div className="grid gap-4 grid-cols-1 md:grid-cols-2 lg:grid-cols-3 pb-10">
                                {filtered.length === 0 && <div className="col-span-full text-center py-20 text-slate-400"><Search size={48} className="mx-auto mb-4 opacity-20"/><p>No entries found</p></div>}
                                {filtered.map(e => {
                                    const { expired, daysLeft } = checkExpiry(e.updatedAt, e.expiryDays);
                                    const style = getCategoryStyle(e.category);
                                    return (
                                        <div key={e.id} className="bg-white p-5 rounded-2xl border shadow-sm hover:shadow-md transition group relative">
                                            {e.expiryDays > 0 && <div className={`absolute top-3 right-3 text-[10px] font-bold px-2 py-1 rounded flex items-center gap-1 ${expired?'bg-red-100 text-red-600':'bg-slate-100 text-slate-500'}`}>{expired?<AlertTriangle size={10}/>:<Clock size={10}/>} {expired?'Expired':`${daysLeft} days`}</div>}
                                            <div className="flex justify-between items-start mb-3">
                                                <div className={`p-3 rounded-xl ${style.color}`}>{style.icon}</div>
                                                <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition">
                                                    <button onClick={() => openEdit(e)} className="p-2 text-slate-400 hover:text-indigo-600"><Key size={16}/></button>
                                                    <button onClick={() => handleDelete(e.id)} className="p-2 text-slate-400 hover:text-red-500"><Trash2 size={16}/></button>
                                                </div>
                                            </div>
                                            <h3 className="font-bold text-lg truncate">{e.site}</h3>
                                            <p className="text-sm text-slate-500 mb-3 truncate">{e.username}</p>
                                            <button onClick={() => navigator.clipboard.writeText(e.password)} className="w-full py-2 bg-slate-50 text-slate-600 text-xs font-bold rounded hover:bg-slate-100">COPY PASSWORD</button>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                        
                        {/* Sync Status Toast */}
                        {syncStatus && (
                            <div className="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 z-50 animate-bounce">
                                {isSyncing ? <RotateCw className="spin text-blue-400" size={20}/> : <CheckCircle className="text-emerald-400" size={20}/>}
                                <span className="font-medium text-sm">{syncStatus}</span>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
