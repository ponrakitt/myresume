<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultra Secure Password Manager + Auto Sync</title>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Crypto JS for Encryption -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <!-- OTPAuth (For 2FA Logic) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/otpauth/9.1.4/otpauth.umd.min.js"></script>
    <!-- QRious (For generating QR Code) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-[#0f172a] min-h-screen flex items-center justify-center p-4 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-slate-800 via-slate-900 to-black text-slate-800 overflow-hidden">

    <div id="root" class="w-full max-w-5xl h-[85vh] flex flex-col relative z-10"></div>
    
    <!-- Background Decoration -->
    <div class="fixed top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-0">
        <div class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-indigo-600/20 rounded-full blur-[120px]"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-emerald-600/10 rounded-full blur-[120px]"></div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons Components ---
        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );

        const Icons = {
            Lock: (props) => <IconBase {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></IconBase>,
            Unlock: (props) => <IconBase {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 9.9-1"></path></IconBase>,
            Eye: (props) => <IconBase {...props}><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></IconBase>,
            EyeOff: (props) => <IconBase {...props}><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07-2.3 2.3"></path><line x1="1" y1="1" x2="23" y2="23"></line></IconBase>,
            RefreshCw: (props) => <IconBase {...props}><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></IconBase>,
            Search: (props) => <IconBase {...props}><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></IconBase>,
            Plus: (props) => <IconBase {...props}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></IconBase>,
            Trash2: (props) => <IconBase {...props}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></IconBase>,
            Cloud: (props) => <IconBase {...props}><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></IconBase>,
            CloudOff: (props) => <IconBase {...props}><path d="M22.61 16.95A5 5 0 0 0 18 10h-1.26a8 8 0 0 0-7.05-6M5 5a8 8 0 0 0 4 15h9a5 5 0 0 0 1.7-.3"></path><line x1="1" y1="1" x2="23" y2="23"></line></IconBase>,
            ShieldCheck: (props) => <IconBase {...props}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><polyline points="9 12 11 14 15 10"></polyline></IconBase>,
            Key: (props) => <IconBase {...props}><path d="m21 16-2 2-2-2-3 3-5.25-5.25a3.75 3.75 0 1 0-1.5 1.5L12 15l2-2 2 2 2-2 3 3"></path></IconBase>,
            LogOut: (props) => <IconBase {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></IconBase>,
            Clock: (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></IconBase>,
            AlertTriangle: (props) => <IconBase {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></IconBase>,
            Smartphone: (props) => <IconBase {...props}><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></IconBase>,
            QrCode: (props) => <IconBase {...props}><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></IconBase>,
            Globe: (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></IconBase>,
            CreditCard: (props) => <IconBase {...props}><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></IconBase>,
            Hash: (props) => <IconBase {...props}><line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line></IconBase>,
            DownloadCloud: (props) => <IconBase {...props}><polyline points="8 17 12 21 16 17"></polyline><line x1="12" y1="12" x2="12" y2="21"></line><path d="M20.88 18.09A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.29"></path></IconBase>,
            CheckCircle: (props) => <IconBase {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></IconBase>
        };

        const { Lock, Unlock, Eye, EyeOff, Save, RefreshCw, Search, Plus, Trash2, Cloud, CloudOff, ShieldCheck, Key, LogOut, Clock, AlertTriangle, Smartphone, QrCode, Globe, CreditCard, Hash, DownloadCloud, CheckCircle } = Icons;

        // --- ENHANCED SECURITY: PBKDF2 Key Derivation ---
        const deriveKey = (password, salt) => {
            return CryptoJS.PBKDF2(password, salt, {
                keySize: 256 / 32,
                iterations: 10000 
            });
        };

        const encryptData = (data, password) => {
            try {
                const salt = CryptoJS.lib.WordArray.random(128 / 8);
                const key = deriveKey(password, salt);
                const iv = CryptoJS.lib.WordArray.random(128 / 8);
                const encrypted = CryptoJS.AES.encrypt(JSON.stringify(data), key, { 
                    iv: iv, padding: CryptoJS.pad.Pkcs7, mode: CryptoJS.mode.CBC
                });
                return JSON.stringify({
                    s: salt.toString(CryptoJS.enc.Hex),
                    iv: iv.toString(CryptoJS.enc.Hex),
                    ct: encrypted.ciphertext.toString(CryptoJS.enc.Base64)
                });
            } catch (e) { console.error("Encryption failed:", e); return null; }
        };

        const decryptData = (packedJson, password) => {
            try {
                let packet;
                try { packet = JSON.parse(packedJson); } catch(e) { return null; }
                if (!packet.s || !packet.iv || !packet.ct) return null;
                const salt = CryptoJS.enc.Hex.parse(packet.s);
                const iv = CryptoJS.enc.Hex.parse(packet.iv);
                const ciphertext = CryptoJS.enc.Base64.parse(packet.ct);
                const key = deriveKey(password, salt);
                const decrypted = CryptoJS.AES.decrypt({ ciphertext: ciphertext }, key, { 
                    iv: iv, padding: CryptoJS.pad.Pkcs7, mode: CryptoJS.mode.CBC
                });
                const decryptedStr = decrypted.toString(CryptoJS.enc.Utf8);
                return decryptedStr ? JSON.parse(decryptedStr) : null;
            } catch (e) { console.error("Decryption failed:", e); return null; }
        };

        // --- Password Generator Component ---
        const PasswordGenerator = ({ onSelect }) => {
            const [length, setLength] = useState(16);
            const [generated, setGenerated] = useState('');
            const [options, setOptions] = useState({ uppercase: true, numbers: true, symbols: true });

            const generate = () => {
                const lower = "abcdefghijklmnopqrstuvwxyz";
                const upper = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
                const nums = "0123456789";
                const syms = "!@#$%^&*()_+-=[]{}|;:,.<>?";
                let chars = lower;
                if (options.uppercase) chars += upper;
                if (options.numbers) chars += nums;
                if (options.symbols) chars += syms;
                let pass = "";
                const required = [];
                if (options.uppercase) required.push(upper[Math.floor(Math.random() * upper.length)]);
                if (options.numbers) required.push(nums[Math.floor(Math.random() * nums.length)]);
                if (options.symbols) required.push(syms[Math.floor(Math.random() * syms.length)]);
                for (let i = 0; i < length - required.length; i++) pass += chars.charAt(Math.floor(Math.random() * chars.length));
                pass = required.join('') + pass;
                pass = pass.split('').sort(() => 0.5 - Math.random()).join('');
                setGenerated(pass);
            };
            useEffect(() => { generate(); }, [length, options]);
            return (
                <div className="bg-slate-50/50 p-5 rounded-xl mb-6 border border-slate-200/60 shadow-inner">
                    <h3 className="font-semibold text-slate-700 mb-3 flex items-center gap-2 text-sm uppercase tracking-wider">
                        <Key size={16} className="text-indigo-500" /> ระบบสร้างรหัสผ่าน
                    </h3>
                    <div className="flex gap-2 mb-4">
                        <input type="text" readOnly value={generated} className="flex-1 p-3 bg-white border border-slate-200 rounded-lg font-mono text-center tracking-wider text-lg text-slate-700 shadow-sm focus:ring-2 focus:ring-indigo-200 outline-none" />
                        <button onClick={generate} className="p-3 bg-white text-indigo-600 border border-indigo-100 rounded-lg hover:bg-indigo-50 hover:border-indigo-200 transition shadow-sm"><RefreshCw size={20} /></button>
                    </div>
                    <div className="flex flex-wrap items-center gap-4 text-sm mb-4 text-slate-600">
                        <label className="flex items-center gap-2 cursor-pointer"><input type="checkbox" className="accent-indigo-600" checked={options.uppercase} onChange={e => setOptions({...options, uppercase: e.target.checked})} /> A-Z</label>
                        <label className="flex items-center gap-2 cursor-pointer"><input type="checkbox" className="accent-indigo-600" checked={options.numbers} onChange={e => setOptions({...options, numbers: e.target.checked})} /> 0-9</label>
                        <label className="flex items-center gap-2 cursor-pointer"><input type="checkbox" className="accent-indigo-600" checked={options.symbols} onChange={e => setOptions({...options, symbols: e.target.checked})} /> !@#</label>
                        <div className="flex items-center gap-2 ml-auto bg-white px-3 py-1 rounded-full border border-slate-200 shadow-sm">
                            <span className="text-xs font-medium text-slate-400">Length: {length}</span>
                            <input type="range" min="8" max="64" value={length} onChange={e => setLength(parseInt(e.target.value))} className="accent-indigo-600 h-1 w-20" />
                        </div>
                    </div>
                    <button onClick={() => onSelect(generated)} className="w-full py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium transition shadow-lg shadow-indigo-200">เลือกใช้รหัสนี้</button>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [masterKey, setMasterKey] = useState(null);
            const [inputKey, setInputKey] = useState('');
            const [isLocked, setIsLocked] = useState(true);
            const [dataStore, setDataStore] = useState({ entries: [], settings: { twoFactorSecret: null, is2FAEnabled: false } });
            
            // UI States
            const [view, setView] = useState('list');
            const [search, setSearch] = useState('');
            const [formData, setFormData] = useState({ site: '', username: '', password: '', notes: '', expiryDays: 90, category: 'website' });
            const [editId, setEditId] = useState(null);
            const [showPass, setShowPass] = useState(false);
            // Default Sync URL updated
            const [syncUrl, setSyncUrl] = useState(localStorage.getItem('pass_manager_sync_url') || 'https://script.google.com/macros/s/AKfycbzTtIAykLNYDOFbUWzo0n3BZ9AddpUu8CsuA93uvhZIkUe3zfSGwByarTsF51yvKaw_fg/exec');
            const [isSyncing, setIsSyncing] = useState(false);
            const [syncStatus, setSyncStatus] = useState('');

            // 2FA States
            const [is2FAChallenging, setIs2FAChallenging] = useState(false);
            const [twoFACode, setTwoFACode] = useState('');
            const [setup2FASecret, setSetup2FASecret] = useState(null);
            const [setup2FACode, setSetup2FACode] = useState('');

            // --- Locking/Unlocking Flow ---
            const handleUnlock = () => {
                if (!inputKey) return;
                const storedData = localStorage.getItem('pass_manager_data');
                
                if (storedData) {
                    const decrypted = decryptData(storedData, inputKey);
                    if (decrypted) {
                        // Decrypted successfully
                        const parsedData = decrypted.entries ? decrypted : { entries: decrypted, settings: { twoFactorSecret: null, is2FAEnabled: false } }; // Backwards compatibility
                        
                        if (parsedData.settings && parsedData.settings.is2FAEnabled) {
                            // 2FA Enabled: Challenge User
                            setDataStore(parsedData); // Load data but don't show yet
                            setMasterKey(inputKey);
                            setIs2FAChallenging(true);
                        } else {
                            // No 2FA: Unlock directly
                            setDataStore(parsedData);
                            setMasterKey(inputKey);
                            setIsLocked(false);
                        }
                    } else {
                        alert("รหัสผ่านหลักไม่ถูกต้อง หรือข้อมูลเสียหาย");
                    }
                } else {
                    if (confirm("ไม่พบข้อมูลเดิม หรือเป็นการใช้งานครั้งแรก\nรหัสนี้จะถูกใช้เป็น Master Password ใหม่")) {
                        setMasterKey(inputKey);
                        setIsLocked(false);
                        setDataStore({ entries: [], settings: { is2FAEnabled: false } });
                    }
                }
            };

            // --- AUTO-SYNC SAVE FUNCTION ---
            const saveData = async (newDataStore) => {
                // 1. Update State & Local Storage immediately
                setDataStore(newDataStore);
                const encrypted = encryptData(newDataStore, masterKey);
                if (encrypted) {
                    localStorage.setItem('pass_manager_data', encrypted);
                
                    // 2. Auto-sync to Cloud (if URL is set)
                    if (syncUrl) {
                        setIsSyncing(true);
                        setSyncStatus('กำลังอัปเดต Google Sheet...');
                        try {
                            await fetch(syncUrl, { 
                                method: 'POST', 
                                mode: 'no-cors', 
                                headers: { 'Content-Type': 'text/plain' }, 
                                body: JSON.stringify({ action: 'save', data: encrypted }) 
                            });
                            setSyncStatus('อัปเดต Google Sheet เรียบร้อย');
                            setTimeout(() => setSyncStatus(''), 2500);
                        } catch (error) {
                            console.error(error);
                            setSyncStatus('Sync ล้มเหลว (บันทึกในเครื่องแล้ว)');
                        } finally {
                            setIsSyncing(false);
                        }
                    }
                }
            };

            const handleCloudRestore = async () => {
                if (!inputKey) return alert("กรุณาใส่ Master Password ที่ใช้เข้ารหัสข้อมูลก่อน");
                if (!syncUrl) return alert("ไม่พบ URL สำหรับ Sync");
                
                setIsSyncing(true);
                setSyncStatus('กำลังดึงข้อมูลจาก Cloud...');
                
                try {
                    const response = await fetch(`${syncUrl}?action=get`);
                    const json = await response.json();
                    
                    if (json.data) {
                        const decrypted = decryptData(json.data, inputKey);
                        if (decrypted) {
                             const parsedData = decrypted.entries ? decrypted : { entries: decrypted, settings: { twoFactorSecret: null, is2FAEnabled: false } };
                             
                             // Check 2FA immediately upon restore
                             if (parsedData.settings && parsedData.settings.is2FAEnabled) {
                                 setDataStore(parsedData);
                                 setMasterKey(inputKey);
                                 setIs2FAChallenging(true); // Challenge!
                                 saveData(parsedData); // Re-save to local + sync back
                             } else {
                                 saveData(parsedData);
                                 setMasterKey(inputKey);
                                 setIsLocked(false);
                                 alert("กู้คืนข้อมูลสำเร็จ!");
                             }
                        } else {
                            alert("Master Password ไม่ถูกต้อง หรือไฟล์บน Cloud เสียหาย");
                        }
                    } else {
                        alert("ไม่พบข้อมูลใน Cloud");
                    }
                } catch (e) {
                    console.error(e);
                    alert("เกิดข้อผิดพลาดในการเชื่อมต่อ: " + e.message);
                } finally {
                    setIsSyncing(false);
                    setSyncStatus('');
                }
            };

            const handle2FAVerify = (e) => {
                e.preventDefault();
                const totp = new OTPAuth.TOTP({
                    algorithm: 'SHA1',
                    digits: 6,
                    period: 30,
                    secret: OTPAuth.Secret.fromBase32(dataStore.settings.twoFactorSecret)
                });

                // Window 1 means allow +/- 30 seconds drift
                const delta = totp.validate({ token: twoFACode, window: 1 });

                if (delta !== null) {
                    setIs2FAChallenging(false);
                    setIsLocked(false);
                    setTwoFACode('');
                } else {
                    alert("รหัส 2FA ไม่ถูกต้อง กรุณาลองใหม่");
                }
            };

            const handleLogout = () => {
                setMasterKey(null);
                setInputKey('');
                setIsLocked(true);
                setIs2FAChallenging(false);
                setDataStore({ entries: [], settings: {} });
            };

            // --- CRUD Operations ---
            const handleDelete = (id) => {
                if (confirm("ยืนยันการลบรายการนี้? (ระบบจะลบใน Google Sheet ด้วย)")) {
                    const newEntries = dataStore.entries.filter(e => e.id !== id);
                    saveData({ ...dataStore, entries: newEntries });
                }
            };

            const handleSaveEntry = () => {
                if (!formData.site || !formData.password) return alert("กรุณากรอกชื่อเว็บไซต์และรหัสผ่าน");
                const now = new Date().toISOString();
                let newEntries = [...dataStore.entries];
                if (editId) {
                    newEntries = newEntries.map(e => e.id === editId ? { ...formData, id: editId, updatedAt: now } : e);
                } else {
                    newEntries.push({ ...formData, id: Date.now(), updatedAt: now });
                }
                saveData({ ...dataStore, entries: newEntries });
                setFormData({ site: '', username: '', password: '', notes: '', expiryDays: 90, category: 'website' });
                setEditId(null);
                setView('list');
            };

            const openEdit = (entry) => {
                setFormData({ ...entry, expiryDays: entry.expiryDays || 90, category: entry.category || 'website' });
                setEditId(entry.id);
                setView('add');
            };

            // --- 2FA Setup Logic ---
            const start2FASetup = () => {
                const secret = new OTPAuth.Secret({ size: 20 }); // Generate random secret
                setSetup2FASecret(secret.base32);
                
                // Render QR code after render
                setTimeout(() => {
                    const totp = new OTPAuth.TOTP({
                        issuer: "MyVault",
                        label: "User",
                        algorithm: "SHA1",
                        digits: 6,
                        period: 30,
                        secret: secret
                    });
                    new QRious({
                        element: document.getElementById('setup-qr'),
                        value: totp.toString(),
                        size: 200
                    });
                }, 100);
            };

            const confirm2FASetup = () => {
                const totp = new OTPAuth.TOTP({
                    algorithm: 'SHA1',
                    digits: 6,
                    period: 30,
                    secret: OTPAuth.Secret.fromBase32(setup2FASecret)
                });
                const delta = totp.validate({ token: setup2FACode, window: 1 });

                if (delta !== null) {
                    const newSettings = { is2FAEnabled: true, twoFactorSecret: setup2FASecret };
                    saveData({ ...dataStore, settings: newSettings });
                    setSetup2FASecret(null);
                    setSetup2FACode('');
                    alert("เปิดใช้งาน 2FA เรียบร้อยแล้ว! ข้อมูลการตั้งค่านี้ถูกซิงค์ไป Google Sheet แล้ว");
                } else {
                    alert("รหัสไม่ถูกต้อง");
                }
            };

            const disable2FA = () => {
                if(confirm("คุณแน่ใจหรือไม่ที่จะปิดระบบ 2FA? ความปลอดภัยจะลดลง")) {
                    const newSettings = { is2FAEnabled: false, twoFactorSecret: null };
                    saveData({ ...dataStore, settings: newSettings });
                }
            };

            // --- Sync Logic (Manual) ---
            const syncToCloud = async () => {
                if (!syncUrl) return alert("กรุณาตั้งค่า URL");
                if (!confirm("ยืนยันการส่งข้อมูลไป Google Sheet?")) return;
                // Reuse logic by just calling saveData with current data
                saveData(dataStore);
            };

            const loadFromCloud = async () => {
                 if (!syncUrl) return alert("กรุณาตั้งค่า URL");
                 setIsSyncing(true);
                 setSyncStatus('กำลังดึงข้อมูล...');
                 try {
                     const response = await fetch(`${syncUrl}?action=get`);
                     const json = await response.json();
                     if (json.data) {
                         const decrypted = decryptData(json.data, masterKey);
                         if (decrypted) {
                             const parsedData = decrypted.entries ? decrypted : { entries: decrypted, settings: { is2FAEnabled: false } };
                             saveData(parsedData); // This will update local + sync back to cloud (consistency)
                             setSyncStatus('ดึงข้อมูลสำเร็จ!');
                             setTimeout(() => setSyncStatus(''), 3000);
                         } else { setSyncStatus('ถอดรหัสไม่ได้'); }
                     } else { setSyncStatus('ไม่พบข้อมูล'); }
                 } catch (error) { setSyncStatus('เกิดข้อผิดพลาดในการดึงข้อมูล'); } finally { setIsSyncing(false); }
            };

            // --- Expiry Logic Helper ---
            const checkExpiry = (updatedAt, days) => {
                if (!days || days === '0') return { expired: false, daysLeft: null };
                const diffTime = new Date(new Date(updatedAt).getTime() + (parseInt(days)*86400000)) - new Date();
                const diffDays = Math.ceil(diffTime / (86400000));
                return { expired: diffDays <= 0, daysLeft: diffDays };
            };
            
            // --- Helper for Category Icons ---
            const getCategoryStyle = (cat) => {
                switch(cat) {
                    case 'app': return { icon: <Smartphone size={24} />, color: 'bg-indigo-100 text-indigo-600', label: 'App' };
                    case 'banking': return { icon: <CreditCard size={24} />, color: 'bg-emerald-100 text-emerald-600', label: 'Finance' };
                    case 'other': return { icon: <Hash size={24} />, color: 'bg-slate-100 text-slate-600', label: 'Other' };
                    default: return { icon: <Globe size={24} />, color: 'bg-blue-100 text-blue-600', label: 'Website' }; // website
                }
            };

            // --- RENDER ---
            
            // 1. LOCKED SCREEN
            if (isLocked) {
                return (
                    <div className="flex flex-col items-center justify-center h-full w-full fade-in">
                        <div className="glass-panel p-10 rounded-3xl shadow-2xl w-full max-w-md mx-auto text-center border border-white/40 relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-indigo-500 to-emerald-500"></div>
                            
                            {/* IF 2FA CHALLENGE */}
                            {is2FAChallenging ? (
                                <>
                                    <div className="bg-indigo-50 w-20 h-20 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-inner border border-indigo-100 animate-pulse">
                                        <Smartphone className="text-indigo-600" size={40} />
                                    </div>
                                    <h1 className="text-2xl font-bold mb-2 text-slate-800">Two-Factor Auth</h1>
                                    <p className="text-slate-500 mb-6 font-light">Enter code from Google Authenticator</p>
                                    <form onSubmit={handle2FAVerify}>
                                        <input 
                                            type="text" inputMode="numeric" pattern="[0-9]*" autoComplete="one-time-code"
                                            value={twoFACode} onChange={(e) => setTwoFACode(e.target.value)}
                                            className="w-full p-4 rounded-xl border border-indigo-200 bg-white text-center text-2xl tracking-[1em] font-mono text-indigo-800 shadow-sm focus:ring-2 focus:ring-indigo-500 outline-none mb-6"
                                            maxLength="6" autoFocus
                                        />
                                        <button type="submit" className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition shadow-lg">Verify</button>
                                        <button type="button" onClick={() => { setIs2FAChallenging(false); setInputKey(''); }} className="mt-4 text-sm text-slate-400 hover:text-slate-600">Cancel</button>
                                    </form>
                                </>
                            ) : (
                                /* NORMAL LOGIN */
                                <>
                                    <div className="bg-slate-50 w-20 h-20 rounded-2xl flex items-center justify-center mx-auto mb-8 shadow-inner border border-slate-100">
                                        <ShieldCheck className="text-indigo-600" size={40} />
                                    </div>
                                    <h1 className="text-3xl font-bold mb-2 text-slate-800 tracking-tight">Welcome Back</h1>
                                    <p className="text-slate-500 mb-8 font-light">Ultra Secure Vault</p>
                                    <input 
                                        type="password" value={inputKey} onChange={(e) => setInputKey(e.target.value)}
                                        onKeyDown={(e) => e.key === 'Enter' && handleUnlock()}
                                        placeholder="Enter Master Password"
                                        className="w-full p-4 rounded-xl border border-slate-200 bg-white/80 backdrop-blur focus:outline-none text-center text-lg shadow-sm"
                                    />
                                    <button onClick={handleUnlock} className="w-full mt-6 bg-slate-900 hover:bg-slate-800 text-white font-semibold py-4 rounded-xl transition-all shadow-xl hover:-translate-y-0.5 flex items-center justify-center gap-2">
                                        <Unlock size={18} /> Unlock Vault
                                    </button>
                                    
                                    {/* Cloud Restore Button for New Devices */}
                                    <button 
                                        onClick={handleCloudRestore}
                                        disabled={isSyncing}
                                        className="mt-6 text-slate-500 hover:text-indigo-600 text-sm flex items-center justify-center gap-1 w-full opacity-70 hover:opacity-100 transition-opacity"
                                    >
                                        {isSyncing ? <span className="animate-spin">⌛</span> : <DownloadCloud size={14} />} 
                                        {isSyncing ? 'กำลังกู้คืน...' : 'กู้คืนข้อมูลจาก Cloud (สำหรับเครื่องใหม่)'}
                                    </button>
                                </>
                            )}
                        </div>
                    </div>
                );
            }

            // 2. MAIN APP
            const filteredEntries = (dataStore.entries || []).filter(e => e.site.toLowerCase().includes(search.toLowerCase()) || e.username.toLowerCase().includes(search.toLowerCase()));

            return (
                <div className="bg-white/90 backdrop-blur-xl rounded-3xl shadow-2xl overflow-hidden h-full flex flex-col border border-white/20 relative fade-in">
                    {/* Header */}
                    <header className="bg-white/50 backdrop-blur-md border-b border-slate-200/60 p-5 flex justify-between items-center z-20">
                        <div className="flex items-center gap-3">
                            <div className="bg-indigo-600 p-2 rounded-lg shadow-lg shadow-indigo-500/30"><ShieldCheck size={24} className="text-white" /></div>
                            <div>
                                <h1 className="font-bold text-xl text-slate-800 tracking-tight leading-none">My Vault</h1>
                                <p className="text-xs text-slate-500 font-medium mt-0.5 flex items-center gap-1">
                                    {dataStore.settings.is2FAEnabled ? <span className="text-emerald-600 flex items-center gap-0.5"><Smartphone size={10}/> 2FA Active</span> : <span className="text-slate-400">2FA Inactive</span>}
                                </p>
                            </div>
                        </div>
                        <div className="flex gap-2">
                             <button onClick={() => { setView('settings'); setSetup2FASecret(null); }} className={`p-2.5 rounded-xl hover:bg-slate-100 transition ${view === 'settings' ? 'bg-indigo-50 text-indigo-600' : 'text-slate-500'}`}><Cloud size={20} /></button>
                            <button onClick={handleLogout} className="p-2.5 rounded-xl hover:bg-red-50 text-slate-400 hover:text-red-500 transition"><LogOut size={20} /></button>
                        </div>
                    </header>

                    {/* Toolbar */}
                    {view !== 'settings' && (
                        <div className="px-6 py-4 bg-slate-50/50 flex flex-col sm:flex-row gap-4 justify-between items-center z-10">
                            <div className="relative w-full sm:w-72 group">
                                <Search className="absolute left-3.5 top-3 text-slate-400 group-focus-within:text-indigo-500 transition-colors" size={18} />
                                <input type="text" placeholder="ค้นหารายการ..." value={search} onChange={(e) => setSearch(e.target.value)} className="w-full pl-11 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white focus:ring-2 focus:ring-indigo-100 outline-none transition shadow-sm" />
                            </div>
                            <div className="flex gap-2 w-full sm:w-auto">
                                <button onClick={() => { setEditId(null); setFormData({site:'', username:'', password:'', notes:'', expiryDays: 90, category: 'website'}); setView('add'); }} className="flex-1 sm:flex-none flex items-center justify-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-xl shadow-lg shadow-indigo-200 transition-all hover:-translate-y-0.5 font-medium"><Plus size={18} /> เพิ่มรายการ</button>
                                {view === 'add' && <button onClick={() => setView('list')} className="px-5 py-2.5 text-slate-600 hover:bg-slate-200 rounded-xl transition font-medium">ยกเลิก</button>}
                            </div>
                        </div>
                    )}

                    {/* Content */}
                    <main className="flex-1 p-6 overflow-y-auto bg-slate-50/30 scroll-smooth">
                        
                        {/* SETTINGS VIEW */}
                        {view === 'settings' && (
                            <div className="max-w-xl mx-auto space-y-8 fade-in pb-10">
                                
                                {/* 2FA SECTION */}
                                <div className="bg-white p-8 rounded-2xl shadow-xl shadow-slate-200/50 border border-slate-100 relative overflow-hidden">
                                    <div className="absolute top-0 right-0 p-4 opacity-10"><Smartphone size={100} /></div>
                                    <h2 className="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2"><Smartphone className="text-indigo-500"/> 2FA Security</h2>
                                    
                                    {!dataStore.settings.is2FAEnabled ? (
                                        !setup2FASecret ? (
                                            <div>
                                                <p className="text-slate-500 mb-4 text-sm">เพิ่มความปลอดภัยด้วยการยืนยันตัวตน 2 ขั้นตอนผ่านแอป Google Authenticator</p>
                                                <button onClick={start2FASetup} className="py-2 px-4 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700 transition">ตั้งค่า 2FA เดี๋ยวนี้</button>
                                            </div>
                                        ) : (
                                            <div className="bg-slate-50 p-6 rounded-xl border border-slate-200 text-center">
                                                <h3 className="font-bold text-slate-700 mb-4">สแกน QR Code ด้วยแอพ Authenticator</h3>
                                                <canvas id="setup-qr" className="mx-auto border-4 border-white rounded-lg shadow-sm mb-4"></canvas>
                                                <p className="text-xs text-slate-400 font-mono mb-4 break-all select-all bg-white p-2 rounded border">{setup2FASecret}</p>
                                                <div className="flex gap-2">
                                                    <input type="text" placeholder="ใส่รหัส 6 หลัก" value={setup2FACode} onChange={e => setSetup2FACode(e.target.value)} className="flex-1 p-2 border rounded-lg text-center" maxLength="6"/>
                                                    <button onClick={confirm2FASetup} className="bg-emerald-500 text-white px-4 rounded-lg font-medium">ยืนยัน</button>
                                                </div>
                                                <button onClick={() => setSetup2FASecret(null)} className="mt-2 text-xs text-red-400 underline">ยกเลิก</button>
                                            </div>
                                        )
                                    ) : (
                                        <div className="flex items-center justify-between">
                                            <div>
                                                <p className="text-emerald-600 font-bold flex items-center gap-2"><ShieldCheck size={18}/> 2FA เปิดใช้งานอยู่</p>
                                                <p className="text-xs text-slate-400 mt-1">บัญชีของคุณปลอดภัย</p>
                                            </div>
                                            <button onClick={disable2FA} className="py-2 px-4 border border-red-200 text-red-500 rounded-lg text-sm font-medium hover:bg-red-50 transition">ปิดใช้งาน</button>
                                        </div>
                                    )}
                                </div>

                                {/* CLOUD SYNC SECTION */}
                                <div className="bg-white p-8 rounded-2xl shadow-xl shadow-slate-200/50 border border-slate-100">
                                    <h2 className="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2"><Cloud className="text-blue-500"/> Cloud Sync</h2>
                                    <input type="text" value={syncUrl} onChange={(e) => { setSyncUrl(e.target.value); localStorage.setItem('pass_manager_sync_url', e.target.value); }} placeholder="Google Apps Script URL" className="w-full p-4 rounded-xl border border-slate-200 bg-slate-50 mb-4 text-sm font-mono focus:ring-2 focus:ring-indigo-100 outline-none" />
                                    <div className="flex gap-4">
                                        <button onClick={syncToCloud} disabled={isSyncing} className="flex-1 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 disabled:opacity-50 flex justify-center items-center gap-2 font-medium shadow-lg shadow-blue-200 transition"><Cloud size={18} /> Push (Manual)</button>
                                        <button onClick={loadFromCloud} disabled={isSyncing} className="flex-1 py-3 bg-emerald-500 text-white rounded-xl hover:bg-emerald-600 disabled:opacity-50 flex justify-center items-center gap-2 font-medium shadow-lg shadow-emerald-200 transition"><CloudOff size={18} /> Pull</button>
                                    </div>
                                    <p className="text-center text-xs text-slate-400 mt-2">* ระบบจะซิงค์ข้อมูลให้อัตโนมัติทุกครั้งที่มีการเปลี่ยนแปลง</p>
                                    {syncStatus && <p className="mt-4 text-center text-sm font-medium text-indigo-600 animate-pulse bg-indigo-50 py-2 rounded-lg">{syncStatus}</p>}
                                </div>
                                
                                <button onClick={() => setView('list')} className="text-slate-400 hover:text-slate-600 w-full text-center text-sm font-medium transition">Back to Dashboard</button>
                            </div>
                        )}

                        {/* ADD/EDIT FORM */}
                        {view === 'add' && (
                            <div className="max-w-xl mx-auto bg-white p-8 rounded-2xl shadow-xl shadow-slate-200/50 border border-slate-100 fade-in">
                                <h2 className="text-2xl font-bold mb-6 text-slate-800 flex items-center gap-2">
                                    {editId ? <span className="text-amber-500">แก้ไขข้อมูล</span> : <span className="text-indigo-500">เพิ่มรายการใหม่</span>}
                                </h2>
                                <div className="space-y-5">
                                    {/* Category Selection */}
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 uppercase tracking-wide">Category</label>
                                        <div className="grid grid-cols-4 gap-2 mt-1">
                                            {[
                                                {id: 'website', icon: <Globe size={18}/>, label: 'Website'},
                                                {id: 'app', icon: <Smartphone size={18}/>, label: 'App'},
                                                {id: 'banking', icon: <CreditCard size={18}/>, label: 'Bank'},
                                                {id: 'other', icon: <Hash size={18}/>, label: 'Other'}
                                            ].map(cat => (
                                                <button key={cat.id} onClick={() => setFormData({...formData, category: cat.id})} 
                                                    className={`py-2 flex flex-col items-center justify-center gap-1 rounded-lg text-xs font-medium border transition ${formData.category === cat.id ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50'}`}>
                                                    {cat.icon}
                                                    {cat.label}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    <div><label className="text-xs font-bold text-slate-500 uppercase tracking-wide">Name (Website/App Name)</label><input className="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl mt-1 focus:ring-2 focus:ring-indigo-100 outline-none" value={formData.site} onChange={e => setFormData({...formData, site: e.target.value})} placeholder="e.g. Facebook, KPlus" /></div>
                                    <div><label className="text-xs font-bold text-slate-500 uppercase tracking-wide">Username</label><input className="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl mt-1 focus:ring-2 focus:ring-indigo-100 outline-none" value={formData.username} onChange={e => setFormData({...formData, username: e.target.value})} /></div>
                                    <div><label className="text-xs font-bold text-slate-500 uppercase tracking-wide">Password</label><div className="relative mt-1"><input type={showPass ? "text" : "password"} className="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-100 outline-none pr-12 font-mono" value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} /><button onClick={() => setShowPass(!showPass)} className="absolute right-3 top-3.5 text-slate-400 hover:text-indigo-500">{showPass ? <EyeOff size={20} /> : <Eye size={20} />}</button></div></div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 uppercase tracking-wide flex items-center gap-2 mb-1"><Clock size={14}/> แจ้งเตือนเปลี่ยนรหัส</label>
                                        <div className="grid grid-cols-4 gap-2">
                                            {[30, 60, 90, 180].map(days => (
                                                <button key={days} onClick={() => setFormData({...formData, expiryDays: days})} className={`py-2 rounded-lg text-sm font-medium border transition ${formData.expiryDays === days ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'}`}>{days} วัน</button>
                                            ))}
                                            <button onClick={() => setFormData({...formData, expiryDays: 0})} className={`col-span-4 py-2 rounded-lg text-sm font-medium border transition ${formData.expiryDays === 0 ? 'bg-slate-600 text-white border-slate-600' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'}`}>ไม่แจ้งเตือน</button>
                                        </div>
                                    </div>
                                    <PasswordGenerator onSelect={(pass) => setFormData({...formData, password: pass})} />
                                    <div><label className="text-xs font-bold text-slate-500 uppercase tracking-wide">Notes</label><textarea className="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl mt-1 focus:ring-2 focus:ring-indigo-100 outline-none h-24 resize-none" value={formData.notes} onChange={e => setFormData({...formData, notes: e.target.value})}></textarea></div>
                                    <button onClick={handleSaveEntry} className="w-full bg-slate-900 text-white py-3.5 rounded-xl font-bold hover:bg-slate-800 shadow-lg transition">บันทึกข้อมูล</button>
                                </div>
                            </div>
                        )}

                        {/* LIST VIEW */}
                        {view === 'list' && (
                            <div className="grid gap-5 grid-cols-1 md:grid-cols-2 lg:grid-cols-3 fade-in">
                                {filteredEntries.length === 0 ? (
                                    <div className="col-span-full flex flex-col items-center justify-center py-20 text-slate-400"><div className="bg-slate-50 p-6 rounded-full mb-4"><Search size={48} className="opacity-20 text-slate-600" /></div><p className="text-lg font-medium">ไม่พบรายการ</p><p className="text-sm">กดปุ่ม "เพิ่มรายการ" เพื่อเริ่ม</p></div>
                                ) : (
                                    filteredEntries.map(entry => {
                                        const { expired, daysLeft } = checkExpiry(entry.updatedAt, entry.expiryDays);
                                        const catStyle = getCategoryStyle(entry.category);
                                        return (
                                            <div key={entry.id} className={`bg-white p-5 rounded-2xl border shadow-sm hover:shadow-xl transition-all duration-300 group hover:-translate-y-1 relative overflow-hidden ${expired ? 'border-red-300 ring-2 ring-red-100' : 'border-slate-100 hover:border-indigo-100'}`}>
                                                {entry.expiryDays > 0 && <div className={`absolute top-0 right-0 px-3 py-1 rounded-bl-xl text-[10px] font-bold tracking-wider flex items-center gap-1 ${expired ? 'bg-red-500 text-white' : (daysLeft <= 10 ? 'bg-amber-400 text-white' : 'bg-slate-100 text-slate-400')}`}>{expired ? <><AlertTriangle size={10} /> Expired</> : <><Clock size={10} /> {daysLeft} วัน</>}</div>}
                                                <div className="flex justify-between items-start mb-4 relative z-10 pt-2">
                                                    <div className={`p-2.5 rounded-xl border border-slate-100 transition flex items-center justify-center ${catStyle.color}`}>
                                                        {catStyle.icon}
                                                    </div>
                                                    <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-all duration-200 transform translate-x-2 group-hover:translate-x-0 mt-2">
                                                        <button onClick={() => openEdit(entry)} className="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition"><Key size={16} /></button>
                                                        <button onClick={() => handleDelete(entry.id)} className="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition"><Trash2 size={16} /></button>
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-2 mb-1">
                                                    <span className="text-[10px] uppercase font-bold tracking-wider text-slate-400 border border-slate-200 px-1.5 py-0.5 rounded">{catStyle.label}</span>
                                                </div>
                                                <h3 className="font-bold text-lg text-slate-800 truncate mb-1 pr-2 relative z-10">{entry.site}</h3>
                                                <p className="text-sm text-slate-500 mb-4 truncate relative z-10">{entry.username}</p>
                                                <div className="relative z-10 bg-slate-50 rounded-xl p-3 flex justify-between items-center group-hover:bg-white group-hover:shadow-inner border border-transparent group-hover:border-slate-100 transition">
                                                    <div className="flex-1 font-mono text-slate-400 text-sm tracking-widest">••••••••</div>
                                                    <button onClick={() => navigator.clipboard.writeText(entry.password)} className="text-xs font-bold text-indigo-600 hover:text-indigo-800 bg-indigo-50 hover:bg-indigo-100 px-3 py-1.5 rounded-lg transition">COPY</button>
                                                </div>
                                            </div>
                                        );
                                    })
                                )}
                            </div>
                        )}
                        
                        {/* Status Bar */}
                        {syncStatus && (
                            <div className="fixed bottom-4 right-4 bg-slate-900 text-white px-4 py-2 rounded-full text-sm font-medium shadow-lg animate-bounce flex items-center gap-2 z-50">
                                <CheckCircle size={16} className="text-emerald-400" />
                                {syncStatus}
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>