<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</title>
<style>
    * { box-sizing: border-box; }
    body {
        font-family: 'Sarabun', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        margin: 0; padding: 20px; min-height: 100vh;
    }
    .container { max-width: 1000px; margin: 0 auto; }
    h1 {
        text-align: center; color: white; font-size: 2.5rem; margin-bottom: 30px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3); font-weight: 700;
    }
    .form-container {
        background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
        border-radius: 20px; padding: 40px; box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        border: 1px solid rgba(255,255,255,0.2);
    }
    fieldset {
        border: 2px solid #e3f2fd; border-radius: 15px; padding: 25px; margin-bottom: 25px;
        background: linear-gradient(145deg, #ffffff, #f8f9ff);
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
    }
    legend {
        font-weight: 700; font-size: 1.3rem; color: #1976d2; padding: 0 15px; background: white;
        border-radius: 25px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    label { display:block; margin-top:15px; font-weight:600; color:#333; font-size:1.1rem; margin-bottom:8px; }
    input[type=text], input[type=number], input[type=date]{
        width:100%; padding:12px 16px; border-radius:12px; border:2px solid #e1e5e9;
        font-size:1rem; transition:all .3s ease; background:white;
    }
    input[type=text]:focus, input[type=number]:focus, input[type=date]:focus{
        outline:none; border-color:#1976d2; box-shadow:0 0 0 3px rgba(25,118,210,.1); transform: translateY(-2px);
    }
    #itemsContainer{
        margin-top:20px; border:2px solid #e3f2fd; border-radius:15px; background:linear-gradient(145deg,#fafbff,#f0f4ff); padding:20px;
    }
    .items-header{
        display:grid; grid-template-columns:5fr 1fr 2fr 2fr 1fr; gap:12px; margin-bottom:15px;
        font-weight:700; color:#1976d2; font-size:1rem; text-align:center;
    }
    .item-row{
        display:grid; grid-template-columns:5fr 1fr 2fr 2fr 1fr; gap:12px; align-items:center; margin-bottom:15px;
        padding:15px; background:white; border-radius:12px; box-shadow:0 4px 8px rgba(0,0,0,.08);
        transition: transform .2s ease, box-shadow .2s ease;
    }
    .item-row:hover{ transform: translateY(-2px); box-shadow:0 8px 16px rgba(0,0,0,.12); }
    .item-row input{ font-size:1rem; padding:10px 12px; border-radius:8px; border:1px solid #ddd; transition:all .2s ease; }
    .item-row input:focus{ border-color:#1976d2; box-shadow:0 0 0 2px rgba(25,118,210,.1); }
    .item-total{ background:#f8f9fa !important; font-weight:600; color:#1976d2; }
    .remove-item-btn{
        background:linear-gradient(145deg,#ff4757,#ff3742); border:none; color:white; font-weight:700;
        padding:10px; border-radius:50%; cursor:pointer; transition:all .3s ease; width:40px; height:40px; display:flex; align-items:center; justify-content:center;
        box-shadow:0 4px 8px rgba(255,71,87,.3);
    }
    #addItemBtn{
        margin-top:15px; background:linear-gradient(145deg,#2ed573,#2cb865); color:white; font-weight:700; padding:12px 24px; border:none; border-radius:12px; cursor:pointer; transition:all .3s ease; font-size:1.1rem; box-shadow:0 6px 12px rgba(46,213,115,.3);
        display:flex; align-items:center; gap:8px;
    }
    .button-container{ display:flex; gap:20px; justify-content:center; margin-top:40px; }
    .btn-primary{
        background:linear-gradient(145deg,#1976d2,#1565c0); color:white; font-weight:700; font-size:1.2rem; padding:15px 30px; border:none; border-radius:15px; cursor:pointer; transition:all .3s ease; box-shadow:0 8px 16px rgba(25,118,210,.3);
        display:flex; align-items:center; gap:10px;
    }
    .btn-secondary{
        background:linear-gradient(145deg,#ff6b6b,#ee5253); color:white; font-weight:700; font-size:1.2rem; padding:15px 30px; border:none; border-radius:15px; cursor:pointer; transition:all .3s ease; box-shadow:0 8px 16px rgba(255,107,107,.3);
        display:flex; align-items:center; gap:10px;
    }

    /* ===== ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‚Äú‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‚Äù ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏ó‡∏ô‡∏Ç‡∏≤‡∏ß‡∏î‡∏≥ (‡∏ï‡∏≠‡∏ô‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß/‡∏™‡∏£‡πâ‡∏≤‡∏á PDF) ===== */
    .receipt-container{ max-width:900px; margin:0 auto; background:#fff; padding:40px; border-radius:0; font-family:'Sarabun',sans-serif; color:#000; position:relative; }
    .receipt-header{ text-align:center; border-bottom:2px solid #000; padding-bottom:20px; margin-bottom:30px; }
    .receipt-header h3{ font-size:2rem; color:#000; margin:0 0 10px 0; }
    .receipt-header p{ margin:5px 0; font-size:1.05rem; color:#000; }
    .receipt-title{ background:#f2f2f2; color:#000; padding:12px 15px; border-radius:6px; border:1px solid #000; font-size:1.6rem; font-weight:700; text-align:center; margin:18px 0; }
    .receipt-details{ display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:24px; padding:16px; background:#fafafa; border:1px solid #000; border-radius:6px; }
    .receipt-details p{ margin:6px 0; font-size:1.05rem; color:#000; }
    .receipt-table{ width:100%; border-collapse:collapse; margin-bottom:24px; border:1px solid #000; border-radius:6px; overflow:hidden; }
    .receipt-table th{ background:#e6e6e6; color:#000; padding:12px; font-size:1rem; font-weight:700; text-align:left; border-bottom:1px solid #000; }
    .receipt-table td{ padding:10px 12px; border-bottom:1px solid #ccc; font-size:1rem; color:#000; }
    .receipt-table tr:nth-child(even){ background:#fafafa; }
    .text-right{ text-align:right; }
    .total-row{ font-weight:700; font-size:1.1rem; background:#e0e0e0 !important; }
    .total-text{ font-weight:700; padding:14px; font-size:1.15rem; background:#f6f6f6; border-radius:6px; text-align:center; border:1px solid #000; color:#000; }
    .footer-note{ text-align:center; font-size:1.05rem; color:#000; border-top:1px dashed #000; padding-top:16px; margin-top:22px; font-style:italic; }
    .signature-section{ display:flex; justify-content:space-around; margin-top:36px; padding-top:18px; border-top:1px dashed #000; }
    .signature-box{ text-align:center; width:45%; color:#000; }
    .signature-line{ border-bottom:1px solid #000; width:80%; margin:0 auto 8px auto; height:1px; }
    .signature-label{ font-size:1rem; font-weight:600; color:#000; }
    .ref-code { font-size:.85rem; color:#000; margin-top:6px; text-align:left; }

    /* Modal/Verify (‡πÄ‡∏î‡∏¥‡∏°) */
    .modal-backdrop{ position: fixed; inset: 0; background: rgba(0,0,0,.4); display:none; align-items:center; justify-content:center; z-index:9999; }
    .modal{ width:min(920px,95vw); background:#fff; border-radius:16px; box-shadow:0 20px 40px rgba(0,0,0,.25); overflow:hidden; }
    .modal-header{ background: linear-gradient(145deg,#1976d2,#1565c0); color:#fff; padding:16px 20px; display:flex; align-items:center; justify-content:space-between; }
    .modal-body{ padding:16px 20px; max-height:70vh; overflow:auto; background:#f7f9ff; }
    .modal-footer{ padding:12px 20px; display:flex; justify-content:flex-end; gap:8px; background:#f1f4fb; }
    .close-btn{ background:transparent; color:#fff; border:none; font-size:1.1rem; cursor:pointer; }
    .table{ width:100%; border-collapse:collapse; background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 1px 4px rgba(0,0,0,.08); }
    .table th,.table td{ padding:12px 10px; border-bottom:1px solid #e9eff8; font-size:.95rem; }
    .table th{ background:#e9f2ff; text-align:left; font-weight:700; color:#245fae; }
    .row-actions{ display:flex; gap:8px; }
    .btn-mini{ border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
    .btn-view{ background:#1976d2; color:#fff; }
    .btn-pdf{ background:#00b894; color:#fff; }
    .search-row{ display:flex; gap:8px; margin-bottom:12px; }
    .search-row input{ flex:1; border:1px solid #d6deeb; border-radius:10px; padding:10px 12px; }

    .verify-row{ display:flex; gap:10px; align-items:center; }
    .verify-result{ margin-top:12px; }
    .verify-box{ border-radius:10px; padding:12px 14px; border:1px solid #e5e7eb; background:#fff; box-shadow:0 1px 3px rgba(0,0,0,.06); }
    .verify-box.success{ border-color:#16a34a; background:#f0fdf4; }
    .verify-box.fail{ border-color:#dc2626; background:#fef2f2; }
    .verify-box.warn{ border-color:#d97706; background:#fffbeb; }
    .verify-box p{ margin:.2rem 0; }
    .tag{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:.85rem; font-weight:700; }
    .tag.ok{ background:#16a34a; color:#fff; }
    .tag.no{ background:#dc2626; color:#fff; }
    .tag.warn{ background:#d97706; color:#fff; }

    @media (max-width: 768px){
        .form-container{ padding:20px; }
        .item-row, .items-header{ grid-template-columns:1fr; gap:8px; }
        .receipt-details{ grid-template-columns:1fr; gap:15px; }
        .button-container{ flex-direction:column; }
        .signature-section{ flex-direction:column; gap:30px; }
        .signature-box{ width:100%; }
    }
</style>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>

<div class="container">
    <h1><i class="fa-solid fa-file-invoice"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h1>

    <div class="form-container">
        <form id="invoiceForm">
            <fieldset>
                <legend><i class="fa-solid fa-building"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</legend>
                <label for="companyName">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</label>
                <input type="text" id="companyName" required value="wanflorist.net" />
                <label for="companyAddress">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</label>
                <input type="text" id="companyAddress" required value="698 ‡∏ñ‡∏ô‡∏ô ‡∏ö‡∏≤‡∏á‡πÅ‡∏Ñ ‡πÅ‡∏Ç‡∏ß‡∏á‡∏ö‡∏≤‡∏á‡πÅ‡∏Ñ ‡∏ö‡∏≤‡∏á‡πÅ‡∏Ñ ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£ 10160" />
                <label for="companyPhone">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                <input type="text" id="companyPhone" value="02-455-4747" />
                <label for="companyTaxId">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ</label>
                <input type="text" id="companyTaxId" value="-" />
            </fieldset>

            <fieldset>
                <legend><i class="fa-solid fa-user"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</legend>
                <label for="customerName">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
                <input type="text" id="customerName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" />
                <label for="customerAddress">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
                <input type="text" id="customerAddress" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" />
                <label for="customerTaxId">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                <input type="text" id="customerTaxId" placeholder="‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ" />
            </fieldset>

            <fieldset>
                <legend><i class="fa-solid fa-file-invoice"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</legend>
                <label for="invoiceNumber">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</label>
                <input type="text" id="invoiceNumber" required placeholder="‡πÄ‡∏ä‡πà‡∏ô INV001" />
                <label for="invoiceDate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</label>
                <input type="date" id="invoiceDate" required />
                <label for="dueDate">‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                <input type="date" id="dueDate" />
                <label for="payeeName">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</label>
                <input type="text" id="payeeName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô" required />
            </fieldset>

            <fieldset>
                <legend><i class="fa-solid fa-cart-shopping"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</legend>
                <div class="items-header">
                    <div>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>
                    <div>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</div>
                    <div>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢</div>
                    <div>‡∏£‡∏ß‡∏°</div>
                    <div>‡∏•‡∏ö</div>
                </div>
                <div id="itemsContainer">
                    <div class="item-row">
                        <input type="text" class="item-description" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£" required />
                        <input type="number" class="item-quantity" min="1" step="1" value="1" required />
                        <input type="number" class="item-price" min="0" step="0.01" value="0.00" required />
                        <input type="text" class="item-total" readonly placeholder="0.00" />
                        <button type="button" class="remove-item-btn" title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£"><i class="fa-solid fa-times"></i></button>
                    </div>
                </div>
                <button type="button" id="addItemBtn">
                    <i class="fa-solid fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                </button>
            </fieldset>

            <div class="button-container">
                <button type="submit" class="btn-primary">
                    <i class="fa-solid fa-eye"></i> ‡∏î‡∏π‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
                </button>
                <button type="button" id="generatePdfBtn" class="btn-secondary">
                    <i class="fa-solid fa-file-pdf"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF
                </button>
                <button type="button" id="historyBtn" class="btn-primary" style="background:linear-gradient(145deg,#0ea5e9,#0284c7);">
                    <i class="fa-solid fa-clock-rotate-left"></i> ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤
                </button>
            </div>
            <div style="margin-top: 20px; text-align: right;">
                <label style="font-size: 1.05rem; color: #1976d2; font-weight: 600;">
                    <input type="checkbox" id="copyReceipt" style="transform: scale(1.2); margin-right: 8px;" /> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏ô‡∏≤‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
                </label>
            </div>

            <!-- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ -->
            <fieldset>
                <legend><i class="fa-solid fa-shield-check"></i> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á</legend>
                <label for="verifyRefInput">‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (15 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£-‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)</label>
                <div class="verify-row">
                    <input type="text" id="verifyRefInput" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2A9F4Q7H3K8MD1 ‡∏´‡∏£‡∏∑‡∏≠ 2A9F-4Q7H-3K8M-D1" maxlength="32" />
                    <button type="button" id="verifyRefBtn" class="btn-primary"><i class="fa-solid fa-magnifying-glass"></i> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</button>
                </div>
                <div id="verifyResult" class="verify-result"></div>
                <div style="color:#6b7280;font-size:.95rem;margin-top:8px;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà <b>‡∏≠‡∏≠‡∏Å‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á</b> (‡∏Å‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á PDF) ‡πÅ‡∏•‡∏∞ <b>‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 90 ‡∏ß‡∏±‡∏ô</b></div>
            </fieldset>
        </form>
    </div>
</div>

<!-- Modal: ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤ -->
<div id="historyModal" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="historyTitle">
    <div class="modal-header">
      <h3 id="historyTitle"><i class="fa-solid fa-clock-rotate-left"></i> ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏ó‡∏≥ (‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 90 ‡∏ß‡∏±‡∏ô)</h3>
      <button class="close-btn" id="historyClose"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="modal-body">
      <div class="search-row">
        <input type="text" id="historySearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à / ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤..." />
      </div>
      <table class="table" id="historyTable">
        <thead>
          <tr>
            <th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å</th>
            <th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
            <th class="text-right">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</th>
            <th>‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th>
          </tr>
        </thead>
        <tbody id="historyTbody"></tbody>
      </table>
    </div>
    <div class="modal-footer">
      <button class="btn-mini" id="historyClose2">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>
</div>

<script>
// ===== helper: ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡πà‡∏≤‡∏ô checkbox ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏ô‡∏≤ =====
function isCopyOptionChecked() {
  const el = document.getElementById('copyReceipt');
  return !!(el && el.checked);
}

// ===== ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏•‡∏Ç‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏ó‡∏¢ =====
function convertNumberToThaiText(amount) {
    const txtnum = ["‡∏®‡∏π‡∏ô‡∏¢‡πå","‡∏´‡∏ô‡∏∂‡πà‡∏á","‡∏™‡∏≠‡∏á","‡∏™‡∏≤‡∏°","‡∏™‡∏µ‡πà","‡∏´‡πâ‡∏≤","‡∏´‡∏Å","‡πÄ‡∏à‡πá‡∏î","‡πÅ‡∏õ‡∏î","‡πÄ‡∏Å‡πâ‡∏≤"];
    const txtdigit = ["","‡∏™‡∏¥‡∏ö","‡∏£‡πâ‡∏≠‡∏¢","‡∏û‡∏±‡∏ô","‡∏´‡∏°‡∏∑‡πà‡∏ô","‡πÅ‡∏™‡∏ô","‡∏•‡πâ‡∏≤‡∏ô"];
    if (typeof amount !== 'number') amount = parseFloat(amount);
    if (isNaN(amount)) return "";
    amount = amount.toFixed(2);
    const [integerPart, decimalPart] = amount.split('.');
    let bahtText = "";
    let len = integerPart.length;
    for (let i = 0; i < len; i++) {
        const digit = parseInt(integerPart.charAt(i));
        const position = len - i - 1;
        if (digit !== 0) {
            if (position === 0 && digit === 1 && len > 1) bahtText += "‡πÄ‡∏≠‡πá‡∏î";
            else if (position === 1 && digit === 2) bahtText += "‡∏¢‡∏µ‡πà";
            else if (position === 1 && digit === 1) bahtText += "";
            else bahtText += txtnum[digit];
            bahtText += txtdigit[position] || "";
        }
    }
    if (bahtText === "") bahtText = txtnum[0];
    bahtText += "‡∏ö‡∏≤‡∏ó";
    if (decimalPart === "00") {
        bahtText += "‡∏ñ‡πâ‡∏ß‡∏ô";
    } else {
        let satangText = "";
        const d1 = parseInt(decimalPart.charAt(0));
        const d2 = parseInt(decimalPart.charAt(1));
        if (d1 !== 0) {
            if (d1 === 1) satangText += "‡∏™‡∏¥‡∏ö";
            else if (d1 === 2) satangText += "‡∏¢‡∏µ‡πà‡∏™‡∏¥‡∏ö";
            else satangText += txtnum[d1] + "‡∏™‡∏¥‡∏ö";
        }
        if (d2 !== 0) {
            if (d2 === 1 && d1 !== 0) satangText += "‡πÄ‡∏≠‡πá‡∏î";
            else satangText += txtnum[d2];
        }
        bahtText += satangText + "‡∏™‡∏ï‡∏≤‡∏á‡∏Ñ‡πå";
    }
    return bahtText;
}

/* ===== localStorage & ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á ===== */
const LS_REGISTRY_KEY = 'invoice_registry_v1';
const LS_INVOICE_PREFIX = 'invoice_v1_';
const LS_REF_INDEX_KEY = 'invoice_ref_index_v1';
const KEEP_DAYS = 90;
const MS_PER_DAY = 24*60*60*1000;

function nowTs(){ return Date.now(); }
function loadRegistry(){ try{ return JSON.parse(localStorage.getItem(LS_REGISTRY_KEY)) || { used:{} }; }catch(_){ return { used:{} }; } }
function saveRegistry(reg){ localStorage.setItem(LS_REGISTRY_KEY, JSON.stringify(reg)); }

function refIndexLoad(){ try{ return JSON.parse(localStorage.getItem(LS_REF_INDEX_KEY)) || {}; }catch(_){ return {}; } }
function refIndexSave(map){ localStorage.setItem(LS_REF_INDEX_KEY, JSON.stringify(map)); }
function refIndexSet(ref, inv){ if(!ref || !inv) return; const idx=refIndexLoad(); idx[ref]=inv; refIndexSave(idx); }
function refIndexRemove(ref){ if(!ref) return; const idx=refIndexLoad(); if(idx[ref]){ delete idx[ref]; refIndexSave(idx);} }

function genRefCode(len=15){
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let out=''; for(let i=0;i<len;i++){ out+=chars[Math.floor(Math.random()*chars.length)]; }
  return out;
}
function ensureRefCodeFor(invNo){
  if(!invNo) return '';
  const key = LS_INVOICE_PREFIX + invNo;
  const data = getInvoice(invNo) || { invoiceNumber: invNo, createdAt: nowTs() };
  if(!data.refCode){ data.refCode = genRefCode(15); data.updatedAt = nowTs(); }
  localStorage.setItem(key, JSON.stringify(data));
  if(data.refCode) refIndexSet(data.refCode, invNo);
  return data.refCode;
}

function cleanupExpired(){
  const reg = loadRegistry();
  const keys = [];
  for(let i=0;i<localStorage.length;i++){ keys.push(localStorage.key(i)); }
  keys.forEach(k=>{
    if(!k || !k.startsWith(LS_INVOICE_PREFIX)) return;
    try{
      const data = JSON.parse(localStorage.getItem(k));
      if(!data || !data.createdAt) return;
      const ageDays = (nowTs() - data.createdAt)/MS_PER_DAY;
      if(ageDays > KEEP_DAYS){
        if(data.invoiceNumber){
          reg.used[data.invoiceNumber] = reg.used[data.invoiceNumber] || data.finalizedAt || data.createdAt || nowTs();
        }
        if(data.refCode){ refIndexRemove(data.refCode); }
        localStorage.removeItem(k);
      }
    }catch(_){}
  });
  saveRegistry(reg);
}

function isNumberUsed(invNo){ return !!loadRegistry().used[invNo]; }
function getInvoice(invNo){ try{ return JSON.parse(localStorage.getItem(LS_INVOICE_PREFIX + invNo)); }catch(_){ return null; } }
function saveDraft(data){
  if(!data.invoiceNumber) return;
  const key = LS_INVOICE_PREFIX + data.invoiceNumber;
  const prev = getInvoice(data.invoiceNumber);
  const payload = { ...prev, ...data, createdAt: prev?.createdAt || nowTs(), updatedAt: nowTs(), finalizedAt: prev?.finalizedAt || null };
  if(!payload.refCode) payload.refCode = genRefCode(15);
  localStorage.setItem(key, JSON.stringify(payload));
  refIndexSet(payload.refCode, data.invoiceNumber);
}
function finalizeInvoice(invNo){
  if(!invNo) return;
  const key = LS_INVOICE_PREFIX + invNo;
  const data = getInvoice(invNo) || { invoiceNumber: invNo, createdAt: nowTs() };
  const finalizedAt = nowTs();
  if(!data.refCode) data.refCode = genRefCode(15);
  data.finalizedAt = finalizedAt;
  localStorage.setItem(key, JSON.stringify(data));
  const reg = loadRegistry(); reg.used[invNo] = reg.used[invNo] || finalizedAt; saveRegistry(reg);
  refIndexSet(data.refCode, invNo);
}

function getFormData(){
  const itemRows = document.querySelectorAll('.item-row');
  const items = [];
  itemRows.forEach(r=>{
    items.push({
      description: r.querySelector('.item-description')?.value?.trim() || '',
      quantity: parseFloat(r.querySelector('.item-quantity')?.value || '0') || 0,
      price: parseFloat(r.querySelector('.item-price')?.value || '0') || 0
    });
  });
  return {
    companyName: document.getElementById('companyName').value.trim(),
    companyAddress: document.getElementById('companyAddress').value.trim(),
    companyPhone: document.getElementById('companyPhone').value.trim(),
    companyTaxId: document.getElementById('companyTaxId').value.trim(),
    customerName: document.getElementById('customerName').value.trim(),
    customerAddress: document.getElementById('customerAddress').value.trim(),
    customerTaxId: document.getElementById('customerTaxId').value.trim(),
    invoiceNumber: document.getElementById('invoiceNumber').value.trim(),
    invoiceDate: document.getElementById('invoiceDate').value,
    dueDate: document.getElementById('dueDate').value,
    payeeName: document.getElementById('payeeName').value.trim(),
    items
  };
}
function setFormFromData(data){
  if(!data) return;
  document.getElementById('companyName').value = data.companyName || '';
  document.getElementById('companyAddress').value = data.companyAddress || '';
  document.getElementById('companyPhone').value = data.companyPhone || '';
  document.getElementById('companyTaxId').value = data.companyTaxId || '';
  document.getElementById('customerName').value = data.customerName || '';
  document.getElementById('customerAddress').value = data.customerAddress || '';
  document.getElementById('customerTaxId').value = data.customerTaxId || '';
  document.getElementById('invoiceNumber').value = data.invoiceNumber || '';
  document.getElementById('invoiceDate').value = data.invoiceDate || '';
  document.getElementById('dueDate').value = data.dueDate || '';
  document.getElementById('payeeName').value = data.payeeName || '';
  const itemsContainer = document.getElementById('itemsContainer');
  itemsContainer.innerHTML = '';
  (data.items && data.items.length ? data.items : [{description:'',quantity:1,price:0}]).forEach(item=>{
    const row = document.createElement('div'); row.className='item-row';
    row.innerHTML = `
      <input type="text" class="item-description" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£" required value="${item.description ?? ''}"/>
      <input type="number" class="item-quantity" min="1" step="1" value="${item.quantity ?? 1}" required />
      <input type="number" class="item-price" min="0" step="0.01" value="${(typeof item.price==='number'?item.price.toFixed(2):item.price||0)}" required />
      <input type="text" class="item-total" readonly placeholder="0.00" />
      <button type="button" class="remove-item-btn" title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£"><i class="fa-solid fa-times"></i></button>
    `;
    itemsContainer.appendChild(row);
  });
}
function toggleActionButtons(disabled, reason=''){
  const submitBtn = document.querySelector('button[type="submit"].btn-primary');
  const pdfBtn = document.getElementById('generatePdfBtn');
  submitBtn.disabled = !!disabled; pdfBtn.disabled = !!disabled;
  submitBtn.title = disabled ? reason : ''; pdfBtn.title = disabled ? reason : '';
}

/* ===== HTML ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (‡∏Ç‡∏≤‡∏ß‡∏î‡∏≥) ===== */
function generateReceiptHTML(isCopy = false) {
    const companyName = document.getElementById('companyName').value.trim();
    const companyAddress = document.getElementById('companyAddress').value.trim();
    const companyPhone = document.getElementById('companyPhone').value.trim();
    const companyTaxId = document.getElementById('companyTaxId').value.trim();

    const customerName = document.getElementById('customerName').value.trim() || '-';
    const customerAddress = document.getElementById('customerAddress').value.trim() || '-';
    const customerTaxId = document.getElementById('customerTaxId').value.trim() || '-';

    const invoiceNumber = document.getElementById('invoiceNumber').value.trim();
    const invoiceDate = document.getElementById('invoiceDate').value;
    const dueDate = document.getElementById('dueDate').value || '-';
    const payeeName = document.getElementById('payeeName').value.trim() || '-';

    const refCode = invoiceNumber ? ensureRefCodeFor(invoiceNumber) : '';

    const now = new Date();
    const printDate = now.toLocaleDateString('th-TH', { year: 'numeric', month: '2-digit', day: '2-digit' });
    const printDateTime = `‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${printDate}`;
    const copyMark = isCopy ? '<div style="position:absolute;top:30px;right:40px;color:#000;font-size:1.2rem;font-weight:700;">(‡∏™‡∏≥‡πÄ‡∏ô‡∏≤)</div>' : '';

    const itemRows = document.querySelectorAll('.item-row');
    let itemsHtml = '';
    let totalAmount = 0;
    itemRows.forEach(row => {
        const desc = row.querySelector('.item-description').value.trim();
        const qty = parseFloat(row.querySelector('.item-quantity').value) || 0;
        const price = parseFloat(row.querySelector('.item-price').value) || 0;
        const amount = qty * price;
        totalAmount += amount;
        itemsHtml += `
            <tr>
                <td>${desc}</td>
                <td class="text-right">${qty}</td>
                <td class="text-right">${price.toFixed(2)}</td>
                <td class="text-right">${amount.toFixed(2)}</td>
            </tr>`;
    });

    return `
        <!DOCTYPE html>
        <html lang="th">
        <head>
            <meta charset="UTF-8" />
            <title>‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô${isCopy ? ' (‡∏™‡∏≥‡πÄ‡∏ô‡∏≤)' : ''}</title>
            <style>
                body { font-family: 'Sarabun', sans-serif; padding: 40px; background: #fff; color: #000; line-height: 1.4; }
                .receipt-container { max-width: 900px; margin: 0 auto; background: #fff; padding: 40px; border-radius: 0; position: relative; color:#000; }
                .receipt-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 20px; margin-bottom: 30px; }
                .receipt-header h3 { font-size: 2rem; color: #000; margin: 0 0 10px 0; }
                .receipt-header p { margin: 5px 0; font-size: 1.05rem; color:#000; }
                .receipt-title { background: #f2f2f2; color: #000; padding: 12px 15px; border-radius: 6px; border:1px solid #000; font-size: 1.6rem; font-weight: 700; text-align: center; margin: 18px 0; }
                .receipt-details { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; padding: 16px; background: #fafafa; border:1px solid #000; border-radius:6px; }
                .receipt-details p { margin: 6px 0; font-size: 1.05rem; color:#000; }
                .receipt-table { width: 100%; border-collapse: collapse; margin-bottom: 24px; border:1px solid #000; border-radius:6px; overflow:hidden; }
                .receipt-table th { background:#e6e6e6; color:#000; padding: 12px; font-size: 1rem; font-weight:700; text-align:left; border-bottom:1px solid #000; }
                .receipt-table td { padding: 10px 12px; border-bottom: 1px solid #ccc; font-size:1rem; color:#000; }
                .receipt-table tr:nth-child(even) { background:#fafafa; }
                .text-right { text-align: right; }
                .total-row { font-weight: 700; font-size: 1.1rem; background: #e0e0e0 !important; }
                .total-text { font-weight: 700; padding: 14px; font-size: 1.15rem; background: #f6f6f6; border-radius: 6px; text-align: center; border:1px solid #000; color:#000; }
                .footer-note { text-align: center; font-size: 1.05rem; color: #000; border-top: 1px dashed #000; padding-top: 16px; margin-top: 22px; font-style: italic; }
                .signature-section { display: flex; justify-content: space-around; margin-top: 36px; padding-top: 18px; border-top: 1px dashed #000; }
                .signature-box { text-align: center; width: 45%; color:#000; }
                .signature-line { border-bottom: 1px solid #000; width: 80%; margin: 0 auto 8px auto; height: 1px; }
                .signature-label { font-size: 1rem; font-weight: 600; color:#000; }
                .ref-code { font-size:.85rem; color:#000; margin-top:6px; text-align:left; }
            </style>
            <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet" />
        </head>
        <body>
            <div class="receipt-container">
                ${copyMark}
                <div class="receipt-header">
                    <h3>${companyName}</h3>
                    <p>${companyAddress}</p>
                    <p>‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå: ${companyPhone || '-'}</p>
                    <p>‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ: ${companyTaxId || '-'}</p>
                </div>

                <div class="receipt-title">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</div>

                <div class="receipt-details">
                    <div>
                        <p><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</strong> ${customerName}</p>
                        <p><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</strong> ${customerAddress}</p>
                        <p><strong>‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</strong> ${customerTaxId}</p>
                    </div>
                    <div>
                        <p><strong>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à:</strong> ${invoiceNumber}</p>
                        <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à:</strong> ${invoiceDate}</p>
                        <p><strong>‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞:</strong> ${dueDate}</p>
                    </div>
                </div>

                <table class="receipt-table">
                    <thead>
                        <tr>
                            <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</th>
                            <th style="width: 80px; text-align:right;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                            <th style="width: 120px; text-align:right;">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢ (‡∏ö‡∏≤‡∏ó)</th>
                            <th style="width: 140px; text-align:right;">‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHtml}
                        <tr class="total-row">
                            <td colspan="3" class="text-right">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</td>
                            <td class="text-right">${totalAmount.toFixed(2)}</td>
                        </tr>
                    </tbody>
                </table>

                <div class="total-text">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô: ${convertNumberToThaiText(totalAmount)}</div>

                <div class="signature-section">
                    <div class="signature-box">
                        <div class="signature-line"></div>
                        <p class="signature-label">(‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô${payeeName ? ' : ' + payeeName : ''})</p>
                        <p class="signature-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${invoiceDate}</p>
                    </div>
                    <div class="signature-box">
                        <div class="signature-line"></div>
                        <p class="signature-label">(‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô)</p>
                        <p class="signature-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ..............................</p>
                    </div>
                </div>

                <div class="footer-note">‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
                <div style="text-align: right; color: #000; font-size: 0.95rem; margin-top: 10px;">${printDateTime}‡∏û‡∏¥‡∏°‡∏û‡πå‡πÇ‡∏î‡∏¢ ${payeeName ? ' : ' + payeeName : ''}</div>
                <div style="text-align: right; color: #000; font-size: 0.95rem; margin-top: 10px;">(Designed by Ponrakit)</div>
                ${refCode ? `<div class="ref-code">‡∏£‡∏´‡∏±‡∏™‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: ${refCode}</div>` : ''}
            </div>
        </body>
        </html>
    `;
}

/* ===== ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á & ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ===== */
function normalizeRef(input){
  return (input || '').toUpperCase().replace(/[^A-Z0-9]/g, '').trim();
}
function verifyByRef(ref){
  const code = normalizeRef(ref);
  if(!code) return { ok:false, reason:'empty' };
  const idx = refIndexLoad();
  let inv = idx[code] || null;
  let data = null;
  if(inv){ data = getInvoice(inv); }
  if(!data){
    for(let i=0;i<localStorage.length;i++){
      const k = localStorage.key(i);
      if(k && k.startsWith(LS_INVOICE_PREFIX)){
        try{
          const d = JSON.parse(localStorage.getItem(k));
          if(d && normalizeRef(d.refCode) === code){ data = d; inv = d.invoiceNumber; break; }
        }catch(_){}
      }
    }
  }
  if(!data) return { ok:false, reason:'notfound' };
  const ageDays = (nowTs() - (data.createdAt||nowTs()))/MS_PER_DAY;
  if(ageDays > KEEP_DAYS) return { ok:false, reason:'expired' };
  if(!data.finalizedAt) return { ok:false, reason:'notfinal' };
  return { ok:true, data };
}
function renderVerifyResult(result){
  const box = document.getElementById('verifyResult');
  const searchedAt = new Date().toLocaleString('th-TH', { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit' });
  if(result.ok){
    const d = result.data;
    box.innerHTML = `
      <div class="verify-box success">
        <p><strong>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:</strong> <span class="tag ok">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏à‡∏£‡∏¥‡∏á</span></p>
        <p>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à: <b>${d.invoiceNumber||'-'}</b></p>
        <p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à: <b>${d.invoiceDate||'-'}</b></p>
        <p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: <b>${searchedAt}</b></p>
      </div>`;
  }else{
    let note = '';
    let tag = '<span class="tag no">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</span>';
    let cls = 'fail';
    if(result.reason === 'empty'){ note = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö'; }
    else if(result.reason === 'expired'){ tag = '<span class="tag warn">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏Å‡∏¥‡∏ô 90 ‡∏ß‡∏±‡∏ô</span>'; cls='warn'; note='‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏ï‡∏≤‡∏°‡∏£‡∏≠‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'; }
    else if(result.reason === 'notfinal'){ tag = '<span class="tag warn">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏ö (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á PDF)</span>'; cls='warn'; }
    box.innerHTML = `
      <div class="verify-box ${cls}">
        <p><strong>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:</strong> ${tag}</p>
        <p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: <b>${searchedAt}</b></p>
        ${note ? `<p style="color:#6b7280;">${note}</p>` : ''}
      </div>`;
  }
}

/* ===== MAIN ===== */
document.addEventListener('DOMContentLoaded', function() {
    const itemsContainer = document.getElementById('itemsContainer');
    const addItemBtn = document.getElementById('addItemBtn');
    const generatePdfBtn = document.getElementById('generatePdfBtn');

    // history modal
    const historyBtn = document.getElementById('historyBtn');
    const historyModal = document.getElementById('historyModal');
    const historyClose = document.getElementById('historyClose');
    const historyClose2 = document.getElementById('historyClose2');
    const historyTbody = document.getElementById('historyTbody');
    const historySearch = document.getElementById('historySearch');

    // verify
    const verifyRefBtn = document.getElementById('verifyRefBtn');
    const verifyRefInput = document.getElementById('verifyRefInput');

    cleanupExpired();

    // default date today
    document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];

    function updateItemTotal(row) {
        const qty = parseFloat(row.querySelector('.item-quantity').value) || 0;
        const price = parseFloat(row.querySelector('.item-price').value) || 0;
        row.querySelector('.item-total').value = (qty * price).toFixed(2);
    }
    function removeItemRow(e) {
        const btn = e.target.closest('.remove-item-btn') || e.target;
        if (itemsContainer.children.length > 1) btn.closest('.item-row').remove();
        else alert("‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
        const d = getFormData(); if(d.invoiceNumber) saveDraft(d);
    }
    function createItemRow() {
        const div = document.createElement('div');
        div.className = 'item-row';
        div.innerHTML = `
            <input type="text" class="item-description" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£" required />
            <input type="number" class="item-quantity" min="1" step="1" value="1" required />
            <input type="number" class="item-price" min="0" step="0.01" value="0.00" required />
            <input type="text" class="item-total" readonly placeholder="0.00" />
            <button type="button" class="remove-item-btn" title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£"><i class="fa-solid fa-times"></i></button>
        `;
        return div;
    }
    function attachRowListeners(row){
        row.querySelector('.item-quantity').addEventListener('input', ()=>{
            updateItemTotal(row);
            const d = getFormData(); if(d.invoiceNumber) saveDraft(d);
        });
        row.querySelector('.item-price').addEventListener('input', ()=>{
            updateItemTotal(row);
            const d = getFormData(); if(d.invoiceNumber) saveDraft(d);
        });
        row.querySelector('.remove-item-btn').addEventListener('click', removeItemRow);
        updateItemTotal(row);
    }
    itemsContainer.querySelectorAll('.item-row').forEach(attachRowListeners);
    addItemBtn.addEventListener('click', () => {
        const newRow = createItemRow();
        itemsContainer.appendChild(newRow);
        attachRowListeners(newRow);
        const d = getFormData(); if(d.invoiceNumber) saveDraft(d);
    });

    // autosave
    [
      '#companyName','#companyAddress','#companyPhone','#companyTaxId',
      '#customerName','#customerAddress','#customerTaxId',
      '#invoiceNumber','#invoiceDate','#dueDate','#payeeName'
    ].forEach(sel=>{
      const el = document.querySelector(sel);
      el.addEventListener('input', ()=>{
        const data = getFormData();
        if(data.invoiceNumber){ saveDraft(data); }
      });
    });

    // ‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à: ‡πÇ‡∏´‡∏•‡∏î‡∏£‡πà‡∏≤‡∏á + ‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß
    document.getElementById('invoiceNumber').addEventListener('blur', ()=>{
        const invNo = document.getElementById('invoiceNumber').value.trim();
        if(!invNo){ toggleActionButtons(false); return; }
        ensureRefCodeFor(invNo);
        const stored = getInvoice(invNo);
        if(stored){ setFormFromData(stored); }
        if(isNumberUsed(invNo)){
            toggleActionButtons(true,'‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ');
            alert('‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ');
        }else{
            toggleActionButtons(false);
        }
    });

    // ‡∏î‡∏π‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏Ç‡∏≤‡∏ß‡∏î‡∏≥) ‚Äî ‡πÑ‡∏°‡πà finalize
    document.getElementById('invoiceForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const requiredFields = ['companyName', 'companyAddress', 'invoiceNumber', 'invoiceDate', 'payeeName'];
        let hasError = false;
        requiredFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (!field.value.trim()) { field.style.borderColor = '#ff4757'; hasError = true; }
            else { field.style.borderColor = '#e1e5e9'; }
        });
        if (hasError) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô'); return; }

        const invoiceNumber = document.getElementById('invoiceNumber').value.trim();
        if (isNumberUsed(invoiceNumber)) {
            toggleActionButtons(true,'‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ');
            alert('‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ');
            return;
        }

        const isCopyChecked = isCopyOptionChecked();
        if (isCopyChecked) {
            const receiptHtml = generateReceiptHTML(false);
            const receiptWindow = window.open('', '_blank', 'width=900,height=700');
            receiptWindow.document.write(receiptHtml);
            receiptWindow.document.close();

            const copyHtml = generateReceiptHTML(true);
            const copyWindow = window.open('', '_blank', 'width=900,height=700');
            copyWindow.document.write(copyHtml);
            copyWindow.document.close();
        } else {
            const receiptHtml = generateReceiptHTML(false);
            const receiptWindow = window.open('', '_blank', 'width=900,height=700');
            receiptWindow.document.write(receiptHtml);
            receiptWindow.document.close();
        }
    });

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF (‡∏Ç‡∏≤‡∏ß‡∏î‡∏≥) -> finalize ‡πÄ‡∏•‡∏Ç
    document.getElementById('generatePdfBtn').addEventListener('click', async function() {
        try {
            const requiredFields = ['companyName', 'companyAddress', 'invoiceNumber', 'invoiceDate', 'payeeName'];
            let hasError = false;
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) { field.style.borderColor = '#ff4757'; hasError = true; }
                else { field.style.borderColor = '#e1e5e9'; }
            });
            if (hasError) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô'); return; }

            const isCopyChecked = isCopyOptionChecked();
            const invoiceNumber = document.getElementById('invoiceNumber').value.trim();

            if (isNumberUsed(invoiceNumber)) {
                toggleActionButtons(true,'‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ');
                alert('‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ');
                return;
            }

            saveDraft(getFormData());
            const ref = ensureRefCodeFor(invoiceNumber);

            const btn = this;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span>‚è≥</span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á PDF...';
            btn.disabled = true;
            const dateStr = new Date().toISOString().split('T')[0];

            async function renderAndSavePDF(isCopyFlag){
                const receiptHtml = generateReceiptHTML(isCopyFlag);
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = receiptHtml;
                tempDiv.style.position = 'absolute';
                tempDiv.style.left = '-9999px';
                tempDiv.style.width = '900px';
                document.body.appendChild(tempDiv);
                await document.fonts.ready;
                const receiptElement = tempDiv.querySelector('.receipt-container');
                const canvas = await html2canvas(receiptElement, { scale: 2, useCORS: true, allowTaint: true, backgroundColor: '#ffffff', width: 900, windowWidth: 900 });
                document.body.removeChild(tempDiv);
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 190;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                const fileName = `‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à_${invoiceNumber}${isCopyFlag ? '_‡∏™‡∏≥‡πÄ‡∏ô‡∏≤' : ''}_${dateStr}.pdf`;
                pdf.save(fileName);
            }

            if (isCopyChecked) {
                await renderAndSavePDF(false);
                await renderAndSavePDF(true);
            } else {
                await renderAndSavePDF(false);
            }

            finalizeInvoice(invoiceNumber);
            toggleActionButtons(true,'‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ');

            // ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á + ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            const verifyInput = document.getElementById('verifyRefInput');
            if(verifyInput){ verifyInput.value = ref; }
            const vres = verifyByRef(ref);
            renderVerifyResult(vres);
            try { alert(`‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à\n‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: ${ref}\n‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏≥‡πÑ‡∏õ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ`); } catch(_){}

            btn.innerHTML = originalText; btn.disabled = false;

        } catch (error) {
            console.error('Error generating PDF:', error);
            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
            const btn = document.getElementById('generatePdfBtn');
            btn.innerHTML = '<span>üìÑ</span> ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF';
            btn.disabled = false;
        }
    });

    /* ===== ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß/‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ö‡∏ö‡∏Ç‡∏≤‡∏ß‡∏î‡∏≥) ===== */
    function calcTotal(items){ return (items||[]).reduce((s,it)=> s + (Number(it.quantity)||0)*(Number(it.price)||0), 0); }
    function loadHistoryList() {
        cleanupExpired();
        const keys = [];
        for(let i=0;i<localStorage.length;i++){ keys.push(localStorage.key(i)); }
        const rows = [];
        keys.forEach(k=>{
            if(!k.startsWith(LS_INVOICE_PREFIX)) return;
            try{
                const data = JSON.parse(localStorage.getItem(k));
                if(!data || !data.finalizedAt) return;
                const ageDays = (nowTs() - (data.createdAt||nowTs()))/MS_PER_DAY;
                if(ageDays > KEEP_DAYS) return;
                rows.push({
                    invoiceNumber: data.invoiceNumber,
                    invoiceDate: data.invoiceDate || '',
                    customerName: data.customerName || '',
                    total: calcTotal(data.items),
                    data
                });
            }catch(_){}
        });
        rows.sort((a,b)=> (b.data.finalizedAt||0) - (a.data.finalizedAt||0));
        return rows;
    }

    const historyBtnOpen = () => { historyModal.style.display='flex'; renderHistoryTable(historySearch.value); };
    const closeModal = () => { historyModal.style.display='none'; };
    historyBtn.addEventListener('click', historyBtnOpen);
    historyClose.addEventListener('click', closeModal);
    historyClose2.addEventListener('click', closeModal);
    historyModal.addEventListener('click', (e)=>{ if(e.target===historyModal) closeModal(); });

    function renderHistoryTable(filterText=''){
        const rows = loadHistoryList();
        const q = (filterText||'').toLowerCase().trim();
        historyTbody.innerHTML = '';
        rows
          .filter(r => !q || (r.invoiceNumber||'').toLowerCase().includes(q) || (r.customerName||'').toLowerCase().includes(q))
          .forEach(r=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${r.invoiceNumber}</td>
              <td>${r.invoiceDate||'-'}</td>
              <td>${r.customerName||'-'}</td>
              <td class="text-right">${r.total.toFixed(2)}</td>
              <td>
                <div class="row-actions">
                  <button class="btn-mini btn-view" data-inv="${r.invoiceNumber}"><i class="fa-solid fa-eye"></i> ‡πÄ‡∏õ‡∏¥‡∏î</button>
                  <button class="btn-mini btn-pdf" data-inv="${r.invoiceNumber}"><i class="fa-solid fa-file-pdf"></i> PDF</button>
                </div>
              </td>
            `;
            historyTbody.appendChild(tr);
          });
        if(historyTbody.children.length===0){
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="5" style="text-align:center; color:#777; padding:16px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á 90 ‡∏ß‡∏±‡∏ô</td>`;
            historyTbody.appendChild(tr);
        }
    }
    historySearch.addEventListener('input', ()=> renderHistoryTable(historySearch.value));

    historyTbody.addEventListener('click', async (e)=>{
        const btn = e.target.closest('button'); if(!btn) return;
        const inv = btn.getAttribute('data-inv'); if(!inv) return;
        const data = getInvoice(inv);
        if(!data){ alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ô‡∏µ‡πâ (‡∏≠‡∏≤‡∏à‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß)'); renderHistoryTable(historySearch.value); return; }

        if(btn.classList.contains('btn-view')){
            let total=0;
            const itemsHtml = (data.items||[]).map(it=>{
                const q=Number(it.quantity)||0, p=Number(it.price)||0, a=q*p; total+=a;
                return `<tr><td>${it.description||''}</td><td class="text-right">${q}</td><td class="text-right">${p.toFixed(2)}</td><td class="text-right">${a.toFixed(2)}</td></tr>`;
            }).join('');
            const w = window.open('', '_blank', 'width=900,height=700');
            w.document.write(`
            <!DOCTYPE html><html lang="th"><head><meta charset="UTF-8" />
            <title>‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô (‡∏™‡∏≥‡πÄ‡∏ô‡∏≤)</title>
            <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet" />
            <style>
              body{font-family:'Sarabun',sans-serif;padding:40px;background:#fff;color:#000;line-height:1.4;}
              .receipt-container{max-width:900px;margin:0 auto;background:#fff;padding:40px;position:relative;color:#000;}
              .receipt-header{text-align:center;border-bottom:2px solid #000;padding-bottom:20px;margin-bottom:30px;}
              .receipt-header h3{font-size:2rem;color:#000;margin:0 0 10px;}
              .receipt-title{background:#f2f2f2;color:#000;padding:12px 15px;border-radius:6px;border:1px solid #000;font-size:1.6rem;font-weight:700;text-align:center;margin:18px 0;}
              .receipt-details{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px;padding:16px;background:#fafafa;border:1px solid #000;border-radius:6px;}
              .receipt-table{width:100%;border-collapse:collapse;margin-bottom:24px;border:1px solid #000;border-radius:6px;overflow:hidden;}
              .receipt-table th{background:#e6e6e6;color:#000;padding:12px;font-size:1rem;text-align:left;border-bottom:1px solid #000;}
              .receipt-table td{padding:10px 12px;border-bottom:1px solid #ccc;font-size:1rem;color:#000;}
              .receipt-table tr:nth-child(even){background:#fafafa;}
              .text-right{text-align:right;}
              .total-row{font-weight:700;font-size:1.1rem;background:#e0e0e0!important;}
              .ref-code{font-size:.85rem;color:#000;margin-top:6px;text-align:left;}
            </style></head><body>
            <div class="receipt-container">
              <div style="position:absolute;top:30px;right:40px;color:#000;font-size:1.2rem;font-weight:700;">(‡∏™‡∏≥‡πÄ‡∏ô‡∏≤)</div>
              <div class="receipt-header">
                <h3>${data.companyName||''}</h3>
                <p>${data.companyAddress||''}</p>
                <p>‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå: ${data.companyPhone||'-'}</p>
                <p>‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ: ${data.companyTaxId||'-'}</p>
              </div>
              <div class="receipt-title">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</div>
              <div class="receipt-details">
                <div>
                  <p><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</strong> ${data.customerName||'-'}</p>
                  <p><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</strong> ${data.customerAddress||'-'}</p>
                  <p><strong>‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</strong> ${data.customerTaxId||'-'}</p>
                </div>
                <div>
                  <p><strong>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à:</strong> ${data.invoiceNumber||''}</p>
                  <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à:</strong> ${data.invoiceDate||''}</p>
                  <p><strong>‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞:</strong> ${data.dueDate||'-'}</p>
                </div>
              </div>
              <table class="receipt-table"><thead>
                <tr><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</th><th style="width:80px;text-align:right;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th style="width:120px;text-align:right;">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢ (‡∏ö‡∏≤‡∏ó)</th><th style="width:140px;text-align:right;">‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</th></tr>
              </thead><tbody>
                ${itemsHtml}
                <tr class="total-row"><td colspan="3" class="text-right">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</td><td class="text-right">${calcTotal(data.items).toFixed(2)}</td></tr>
              </tbody></table>
              ${data.refCode ? `<div class="ref-code">‡∏£‡∏´‡∏±‡∏™‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: ${data.refCode}</div>` : ''}
            </div></body></html>`);
            w.document.close();
        }

        if(btn.classList.contains('btn-pdf')){
            try{
                let total=0;
                const itemsHtml = (data.items||[]).map(it=>{
                    const q=Number(it.quantity)||0, p=Number(it.price)||0, a=q*p; total+=a;
                    return `<tr><td>${it.description||''}</td><td class="text-right">${q}</td><td class="text-right">${p.toFixed(2)}</td><td class="text-right">${a.toFixed(2)}</td></tr>`;
                }).join('');
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = `
                  <div class="receipt-container" style="font-family:'Sarabun',sans-serif;padding:40px;width:900px;background:#fff;position:relative;color:#000;">
                    <div style="position:absolute;top:30px;right:40px;color:#000;font-size:1.2rem;font-weight:700;">(‡∏™‡∏≥‡πÄ‡∏ô‡∏≤)</div>
                    <div style="text-align:center;border-bottom:2px solid #000;padding-bottom:20px;margin-bottom:30px;">
                      <h3 style="font-size:2rem;color:#000;margin:0 0 10px;">${data.companyName||''}</h3>
                      <p style="margin:5px 0;color:#000;">${data.companyAddress||''}</p>
                      <p style="margin:5px 0;color:#000;">‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå: ${data.companyPhone||'-'}</p>
                      <p style="margin:5px 0;color:#000;">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ: ${data.companyTaxId||'-'}</p>
                    </div>
                    <div style="background:#f2f2f2;color:#000;padding:12px 15px;border:1px solid #000;border-radius:6px;font-size:1.6rem;font-weight:700;text-align:center;margin:18px 0;">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px;padding:16px;background:#fafafa;border:1px solid #000;border-radius:6px;">
                      <div>
                        <p><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</strong> ${data.customerName||'-'}</p>
                        <p><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</strong> ${data.customerAddress||'-'}</p>
                        <p><strong>‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</strong> ${data.customerTaxId||'-'}</p>
                      </div>
                      <div>
                        <p><strong>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à:</strong> ${data.invoiceNumber||''}</p>
                        <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à:</strong> ${data.invoiceDate||''}</p>
                        <p><strong>‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞:</strong> ${data.dueDate||'-'}</p>
                      </div>
                    </div>
                    <table style="width:100%;border-collapse:collapse;margin-bottom:24px;border:1px solid #000;border-radius:6px;overflow:hidden;">
                      <thead>
                        <tr style="background:#e6e6e6;color:#000;border-bottom:1px solid #000;">
                          <th style="padding:12px;text-align:left;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</th>
                          <th style="padding:12px;text-align:right;width:80px;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                          <th style="padding:12px;text-align:right;width:120px;">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢ (‡∏ö‡∏≤‡∏ó)</th>
                          <th style="padding:12px;text-align:right;width:140px;">‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${itemsHtml}
                        <tr style="background:#e0e0e0;font-weight:700;">
                          <td colspan="3" style="text-align:right;padding:12px;">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</td>
                          <td style="text-align:right;padding:12px;">${total.toFixed(2)}</td>
                        </tr>
                      </tbody>
                    </table>
                    ${data.refCode ? `<div style="font-size:.85rem;color:#000;margin-top:6px;text-align:left;">‡∏£‡∏´‡∏±‡∏™‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: ${data.refCode}</div>` : ''}
                  </div>
                `;
                document.body.appendChild(tempDiv);
                await document.fonts.ready;
                const receiptEl = tempDiv.querySelector('.receipt-container');
                const canvas = await html2canvas(receiptEl, { scale:2, useCORS:true, allowTaint:true, backgroundColor:'#ffffff', width:900, windowWidth:900 });
                document.body.removeChild(tempDiv);
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ orientation:'portrait', unit:'mm', format:'a4' });
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 190;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                const dateStr = new Date().toISOString().split('T')[0];
                pdf.save(`‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à_${inv}_‡∏™‡∏≥‡πÄ‡∏ô‡∏≤_${dateStr}.pdf`);
            }catch(err){
                console.error(err);
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
            }
        }
    });

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
    verifyRefBtn.addEventListener('click', ()=>{
      const raw = document.getElementById('verifyRefInput').value;
      const val = normalizeRef(raw);
      const res = verifyByRef(val);
      renderVerifyResult(res);
    });
    verifyRefInput.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){ e.preventDefault(); document.getElementById('verifyRefBtn').click(); }
    });
});
</script>

</body>
</html>
