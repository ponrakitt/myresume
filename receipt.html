<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>สร้างใบเสร็จรับเงิน</title>
<style>
    * { box-sizing: border-box; }
    body { font-family: 'Sarabun', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin: 0; padding: 20px; min-height: 100vh; }
    .container { max-width: 1000px; margin: 0 auto; }
    h1 { text-align: center; color: white; font-size: 2.5rem; margin-bottom: 30px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); font-weight: 700; }
    .form-container { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; padding: 40px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.2); }
    fieldset { border: 2px solid #e3f2fd; border-radius: 15px; padding: 25px; margin-bottom: 25px; background: linear-gradient(145deg, #ffffff, #f8f9ff); box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); }
    legend { font-weight: 700; font-size: 1.3rem; color: #1976d2; padding: 0 15px; background: white; border-radius: 25px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    label { display:block; margin-top:15px; font-weight:600; color:#333; font-size:1.1rem; margin-bottom:8px; }
    input[type=text], input[type=number], input[type=date], input[type=password]{ width:100%; padding:12px 16px; border-radius:12px; border:2px solid #e1e5e9; font-size:1rem; transition:all .3s ease; background:white; }
    input[type=text]:focus, input[type=number]:focus, input[type=date]:focus, input[type=password]:focus{ outline:none; border-color:#1976d2; box-shadow:0 0 0 3px rgba(25,118,210,.1); transform: translateY(-2px); }
    #itemsContainer{ margin-top:20px; border:2px solid #e3f2fd; border-radius:15px; background:linear-gradient(145deg,#fafbff,#f0f4ff); padding:20px; }
    .items-header{ display:grid; grid-template-columns:5fr 1fr 2fr 2fr 1fr; gap:12px; margin-bottom:15px; font-weight:700; color:#1976d2; font-size:1rem; text-align:center; }
    .item-row{ display:grid; grid-template-columns:5fr 1fr 2fr 2fr 1fr; gap:12px; align-items:center; margin-bottom:15px; padding:15px; background:white; border-radius:12px; box-shadow:0 4px 8px rgba(0,0,0,.08); transition: transform .2s ease, box-shadow .2s ease; }
    .item-row:hover{ transform: translateY(-2px); box-shadow:0 8px 16px rgba(0,0,0,.12); }
    .item-row input{ font-size:1rem; padding:10px 12px; border-radius:8px; border:1px solid #ddd; transition:all .2s ease; }
    .item-total{ background:#f8f9fa !important; font-weight:600; color:#1976d2; }
    .remove-item-btn{ background:linear-gradient(145deg,#ff4757,#ff3742); border:none; color:white; font-weight:700; padding:10px; border-radius:50%; cursor:pointer; transition:all .3s ease; width:40px; height:40px; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 8px rgba(255,71,87,.3); }
    #addItemBtn{ margin-top:15px; background:linear-gradient(145deg,#2ed573,#2cb865); color:white; font-weight:700; padding:12px 24px; border:none; border-radius:12px; cursor:pointer; transition:all .3s ease; font-size:1.1rem; box-shadow:0 6px 12px rgba(46,213,115,.3); display:flex; align-items:center; gap:8px; }
    .button-container{ display:flex; gap:20px; justify-content:center; margin-top:40px; flex-wrap:wrap; }
    .btn-primary{ background:linear-gradient(145deg,#1976d2,#1565c0); color:white; font-weight:700; font-size:1.2rem; padding:15px 30px; border:none; border-radius:15px; cursor:pointer; transition:all .3s ease; box-shadow:0 8px 16px rgba(25,118,210,.3); display:flex; align-items:center; gap:10px; }
    .btn-secondary{ background:linear-gradient(145deg,#ff6b6b,#ee5253); color:white; font-weight:700; font-size:1.2rem; padding:15px 30px; border:none; border-radius:15px; cursor:pointer; transition:all .3s ease; box-shadow:0 8px 16px rgba(255,107,107,.3); display:flex; align-items:center; gap:10px; }

    /* ===== ใบเสร็จ "ขาวดำ" ===== */
    .receipt-container{ max-width:900px; margin:0 auto; background:#fff; padding:40px; border-radius:0; font-family:'Sarabun',sans-serif; color:#000; position:relative; }
    .receipt-header{ text-align:center; border-bottom:2px solid #000; padding-bottom:20px; margin-bottom:30px; }
    .receipt-header h3{ font-size:2rem; color:#000; margin:0 0 10px 0; }
    .receipt-header p{ margin:5px 0; font-size:1.05rem; color:#000; }
    .receipt-title{ background:#f2f2f2; color:#000; padding:12px 15px; border-radius:6px; border:1px solid #000; font-size:1.6rem; font-weight:700; text-align:center; margin:18px 0; }
    .receipt-details{ display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:24px; padding:16px; background:#fafafa; border:1px solid #000; border-radius:6px; }
    .receipt-details p{ margin:6px 0; font-size:1.05rem; color:#000; }
    .receipt-table{ width:100%; border-collapse:collapse; margin-bottom:24px; border:1px solid #000; border-radius:6px; overflow:hidden; }
    .receipt-table th{ background:#e6e6e6; color:#000; padding:12px; font-size:1rem; font-weight:700; text-align:left; border-bottom:1px solid #000; }
    .receipt-table td{ padding:10px 12px; border-bottom:1px solid #ccc; font-size:1rem; color:#000; }
    .receipt-table tr:nth-child(even){ background:#fafafa; }
    .text-right{ text-align:right; }
    .total-row{ font-weight:700; font-size:1.1rem; background:#e0e0e0 !important; }
    .total-text{ font-weight:700; padding:14px; font-size:1.15rem; background:#f6f6f6; border-radius:6px; text-align:center; border:1px solid #000; color:#000; }
    .footer-note{ text-align:center; font-size:1.05rem; color:#000; border-top:1px dashed #000; padding-top:16px; margin-top:22px; font-style:italic; }

    .signature-section{ display:flex; justify-content:flex-end; margin-top:36px; padding-top:18px; border-top:1px dashed #000; }
    .signature-box{ text-align:center; width:45%; color:#000; }
    .signature-line{ border-bottom:1px solid #000; width:80%; margin:0 auto 8px auto; height:1px; }
    .signature-label{ font-size:1rem; font-weight:600; color:#000; }
    .ref-code { font-size:.85rem; color:#000; margin-top:6px; text-align:left; }
    .thankyou-line{ text-align:center; font-size:1.05rem; color:#000; margin-top:10px; font-weight:600; }

    /* ลายเซ็นในฟอร์ม */
    .sig-controls{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .sig-preview-wrap{ margin-top:10px; }
    .sig-preview{ display:inline-block; border:1px solid #d1d5db; background:#fff; padding:6px; border-radius:6px; }
    .sig-preview img{ max-width:280px; max-height:120px; filter: grayscale(100%); }

    /* Modal */
    .modal-backdrop{ position: fixed; inset: 0; background: rgba(0,0,0,.4); display:none; align-items:center; justify-content:center; z-index:9999; }
    .modal{ width:min(920px,95vw); background:#fff; border-radius:16px; box-shadow:0 20px 40px rgba(0,0,0,.25); overflow:hidden; }
    .modal-header{ background: linear-gradient(145deg,#1976d2,#1565c0); color:#fff; padding:16px 20px; display:flex; align-items:center; justify-content:space-between; }
    .modal-body{ padding:16px 20px; max-height:70vh; overflow:auto; background:#f7f9ff; }
    .modal-footer{ padding:12px 20px; display:flex; justify-content:flex-end; gap:8px; background:#f1f4fb; }
    .close-btn{ background:transparent; color:#fff; border:none; font-size:1.1rem; cursor:pointer; }
    .btn-mini{ border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
    .btn-grey{ background:#374151; color:#fff; }
    .btn-light{ background:#e5e7eb; color:#111827; }
    .canvas-wrap{ background:#fff; border:1px solid #d1d5db; border-radius:10px; padding:10px; }
    .sig-canvas{ width:100%; height:240px; touch-action:none; cursor: crosshair; background:#fff; }

    /* ตารางประวัติ / verify */
    .table{ width:100%; border-collapse:collapse; background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 1px 4px rgba(0,0,0,.08); }
    .table th,.table td{ padding:12px 10px; border-bottom:1px solid #e9eff8; font-size:.95rem; }
    .table th{ background:#e9f2ff; text-align:left; font-weight:700; color:#245fae; }
    .row-actions{ display:flex; gap:8px; }
    .search-row{ display:flex; gap:8px; margin-bottom:12px; }
    .search-row input{ flex:1; border:1px solid #d6deeb; border-radius:10px; padding:10px 12px; }

    .verify-row{ display:flex; gap:10px; align-items:center; }
    .verify-result{ margin-top:12px; }
    .verify-box{ border-radius:10px; padding:12px 14px; border:1px solid #e5e7eb; background:#fff; box-shadow:0 1px 3px rgba(0,0,0,.06); }
    .verify-box.success{ border-color:#16a34a; background:#f0fdf4; }
    .verify-box.fail{ border-color:#dc2626; background:#fef2f2; }
    .verify-box.warn{ border-color:#d97706; background:#fffbeb; }
    .verify-box p{ margin:.2rem 0; }
    .tag{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:.85rem; font-weight:700; }
    .tag.ok{ background:#16a34a; color:#fff; }
    .tag.no{ background:#dc2626; color:#fff; }
    .tag.warn{ background:#d97706; color:#fff; }

    /* BARCODE (Serial Number 15 หลัก) */
    .barcode-head{ position:absolute; top:20px; right:20px; text-align:right; }
    .barcode-head img{ display:block; height:28px; }
    .barcode-text{ font-size:.70rem; letter-spacing:.06em; color:#000; margin-top:2px; }
    .copy-mark{ color:#000; font-size:1.0rem; font-weight:700; margin-top:6px; }

    /* inline field ใกล้เลขที่ใบเสร็จ */
    .inline-field{ display:flex; gap:8px; align-items:center; }
    .inline-field input{ flex:1; }
    .hint{ color:#6b7280; font-size:.9rem; margin-top:6px; display:block; }

    @media (max-width: 768px){
        .form-container{ padding:20px; }
        .item-row, .items-header{ grid-template-columns:1fr; gap:8px; }
        .receipt-details{ grid-template-columns:1fr; gap:15px; }
        .button-container{ flex-direction:column; }
        .signature-section{ justify-content:center; }
        .signature-box{ width:100%; }
    }
</style>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<!-- pdfmake สำหรับ PDF ใส่รหัสผ่าน -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.9/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.9/vfs_fonts.min.js"></script>
<!-- BARCODE: JsBarcode CDN -->
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
</head>
<body>

<div class="container">
    <h1><i class="fa-solid fa-file-invoice"></i> สร้างใบเสร็จรับเงิน</h1>

    <div class="form-container">
        <form id="invoiceForm">
            <fieldset>
                <legend><i class="fa-solid fa-building"></i> ข้อมูลบริษัท</legend>
                <label for="companyName">ชื่อบริษัท</label>
                <input type="text" id="companyName" required value="wanflorist.net" />
                <label for="companyAddress">ที่อยู่บริษัท</label>
                <input type="text" id="companyAddress" required value="698 ถนน บางแค แขวงบางแค บางแค กรุงเทพมหานคร 10160" />
                <label for="companyPhone">เบอร์โทรศัพท์</label>
                <input type="text" id="companyPhone" value="02-455-4747" />
                <label for="companyTaxId">เลขประจำตัวผู้เสียภาษี</label>
                <input type="text" id="companyTaxId" value="-" />
            </fieldset>

            <fieldset>
                <legend><i class="fa-solid fa-user"></i> ข้อมูลลูกค้า</legend>
                <label for="customerName">ชื่อลูกค้า</label>
                <input type="text" id="customerName" placeholder="ชื่อลูกค้า" />
                <label for="customerAddress">ที่อยู่ลูกค้า</label>
                <input type="text" id="customerAddress" placeholder="ที่อยู่ลูกค้า" />
                <label for="customerTaxId">เลขประจำตัวผู้เสียภาษี (ถ้ามี)</label>
                <input type="text" id="customerTaxId" placeholder="เลขประจำตัวผู้เสียภาษี" />
            </fieldset>

            <fieldset>
                <legend><i class="fa-solid fa-file-invoice"></i> ข้อมูลใบเสร็จ</legend>

                <label for="invoiceNumber">เลขที่ใบเสร็จ</label>
                <div class="inline-field">
                  <input type="text" id="invoiceNumber" required placeholder="เช่น INV-2025-000001" />
                  <button type="button" id="autoGenInvoiceBtn" class="btn-mini btn-light" title="สร้างเลขอัตโนมัติ"><i class="fa-solid fa-hashtag"></i> เลขอัตโนมัติ</button>
                </div>
                <span class="hint">รูปแบบ: <b>INV-ปี-เลขที่</b> (เช่น <code>INV-2025-000001</code>) เลขจะไม่ซ้ำเมื่อสร้าง PDF</span>

                <label for="invoiceDate">วันที่ออกใบเสร็จ</label>
                <input type="date" id="invoiceDate" required />
                <label for="dueDate">ครบกำหนดชำระ (ถ้ามี)</label>
                <input type="date" id="dueDate" />
                <label for="payeeName">ชื่อผู้รับเงิน</label>
                <input type="text" id="payeeName" placeholder="ชื่อผู้รับเงิน" required />
            </fieldset>

            <!-- ลายเซ็นผู้รับเงิน -->
            <fieldset>
                <legend><i class="fa-solid fa-signature"></i> ลายเซ็นผู้รับเงิน</legend>
                <div class="sig-controls">
                    <button type="button" id="openSigPad" class="btn-mini btn-grey"><i class="fa-solid fa-pen"></i> วาดลายเซ็น</button>
                    <button type="button" id="pickSigFile" class="btn-mini btn-light"><i class="fa-solid fa-upload"></i> อัปโหลดรูป</button>
                    <button type="button" id="clearSig" class="btn-mini btn-light"><i class="fa-solid fa-eraser"></i> ล้างลายเซ็น</button>
                </div>
                <div class="sig-preview-wrap">
                    <div class="sig-preview" id="sigPreview" style="display:none;">
                        <img id="sigImg" alt="Signature preview"/>
                    </div>
                </div>
                <input type="hidden" id="payeeSignatureDataUrl" />
                <input type="file" id="signatureFile" accept="image/*" style="display:none" />
            </fieldset>

            <!-- ตั้งรหัสผ่าน PDF (ตัวเลือก) -->
            <fieldset>
                <legend><i class="fa-solid fa-lock"></i> ตั้งรหัสผ่าน PDF (ถ้าต้องการ)</legend>
                <label style="display:flex;align-items:center;gap:8px;">
                    <input type="checkbox" id="usePdfPassword" />
                    ใช้รหัสผ่านเปิดไฟล์ PDF
                </label>
                <div id="passwordFields" style="display:none; margin-top:10px;">
                    <label for="pdfPassword">รหัสผ่าน</label>
                    <input type="password" id="pdfPassword" placeholder="อย่างน้อย 4 ตัวอักษร" />
                    <label for="pdfPasswordConfirm">ยืนยันรหัสผ่าน</label>
                    <input type="password" id="pdfPasswordConfirm" placeholder="พิมพ์รหัสผ่านอีกครั้ง" />
                </div>
            </fieldset>

            <fieldset>
                <legend><i class="fa-solid fa-cart-shopping"></i> รายการสินค้า/บริการ</legend>
                <div class="items-header">
                    <div>รายละเอียด</div>
                    <div>จำนวน</div>
                    <div>ราคาต่อหน่วย</div>
                    <div>รวม</div>
                    <div>ลบ</div>
                </div>
                <div id="itemsContainer">
                    <div class="item-row">
                        <input type="text" class="item-description" placeholder="รายละเอียดสินค้า/บริการ" required />
                        <input type="number" class="item-quantity" min="1" step="1" value="1" required />
                        <input type="number" class="item-price" min="0" step="0.01" value="0.00" required />
                        <input type="text" class="item-total" readonly placeholder="0.00" />
                        <button type="button" class="remove-item-btn" title="ลบรายการ"><i class="fa-solid fa-times"></i></button>
                    </div>
                </div>
                <button type="button" id="addItemBtn"><i class="fa-solid fa-plus"></i> เพิ่มรายการ</button>
            </fieldset>

            <div class="button-container">
                <button type="submit" class="btn-primary"><i class="fa-solid fa-eye"></i> ดูใบเสร็จ</button>
                <button type="button" id="generatePdfBtn" class="btn-secondary"><i class="fa-solid fa-file-pdf"></i> สร้าง PDF</button>
                <button type="button" id="historyBtn" class="btn-primary" style="background:linear-gradient(145deg,#0ea5e9,#0284c7);"><i class="fa-solid fa-clock-rotate-left"></i> ใบเสร็จที่ผ่านมา</button>
            </div>
            <div style="margin-top: 20px; text-align: right;">
                <label style="font-size: 1.05rem; color: #1976d2; font-weight: 600;">
                    <input type="checkbox" id="copyReceipt" style="transform: scale(1.2); margin-right: 8px;" /> สร้างสำเนาใบเสร็จ
                </label>
            </div>

            <!-- ตรวจสอบเอกสาร -->
            <fieldset>
                <legend><i class="fa-solid fa-shield-check"></i> ตรวจสอบเอกสารด้วยเลขอ้างอิง</legend>
                <label for="verifyRefInput">เลขอ้างอิงเอกสาร (15 ตัวอักษร-ตัวเลข)</label>
                <div class="verify-row">
                    <input type="text" id="verifyRefInput" placeholder="เช่น 2A9F4Q7H3K8MD1" maxlength="32" />
                    <button type="button" id="verifyRefBtn" class="btn-primary"><i class="fa-solid fa-magnifying-glass"></i> ตรวจสอบ</button>
                </div>
                <div id="verifyResult" class="verify-result"></div>
                <div style="color:#6b7280;font-size:.95rem;margin-top:8px;">ตรวจสอบได้เฉพาะเอกสารที่ <b>สร้าง PDF แล้ว</b> และ <b>อายุไม่เกิน 90 วัน</b></div>
            </fieldset>
        </form>
    </div>
</div>

<!-- Modal: ประวัติ -->
<div id="historyModal" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="historyTitle">
    <div class="modal-header">
      <h3 id="historyTitle"><i class="fa-solid fa-clock-rotate-left"></i> ใบเสร็จที่เคยทำ (ภายใน 90 วัน)</h3>
      <button class="close-btn" id="historyClose"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="modal-body">
      <div class="search-row"><input type="text" id="historySearch" placeholder="ค้นหาเลขที่ใบเสร็จ / ชื่อลูกค้า..." /></div>
      <table class="table" id="historyTable">
        <thead><tr><th>เลขที่</th><th>วันที่ออก</th><th>ลูกค้า</th><th class="text-right">ยอดรวม (บาท)</th><th>การทำงาน</th></tr></thead>
        <tbody id="historyTbody"></tbody>
      </table>
    </div>
    <div class="modal-footer"><button class="btn-mini" id="historyClose2">ปิด</button></div>
  </div>
</div>

<!-- Modal: วาดลายเซ็น -->
<div id="sigModal" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="sigTitle">
    <div class="modal-header">
      <h3 id="sigTitle"><i class="fa-solid fa-pen"></i> วาดลายเซ็นผู้รับเงิน</h3>
      <button class="close-btn" id="sigClose"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="modal-body">
      <div class="canvas-wrap"><canvas id="sigCanvas" class="sig-canvas"></canvas></div>
      <div style="margin-top:10px; display:flex; gap:8px;">
        <button type="button" id="sigClearBtn" class="btn-mini btn-light"><i class="fa-solid fa-eraser"></i> ล้าง</button>
        <button type="button" id="sigSaveBtn" class="btn-mini btn-grey"><i class="fa-solid fa-check"></i> ใช้ลายเซ็นนี้</button>
      </div>
      <div style="margin-top:8px;color:#6b7280;font-size:.9rem;">เคล็ดลับ: ใช้นิ้วหรือสไตลัสบนมือถือได้</div>
    </div>
    <div class="modal-footer"><button class="btn-mini" id="sigClose2">ปิด</button></div>
  </div>
</div>

<!-- BARCODE: แคนวาสซ่อนสำหรับเรนเดอร์บาร์โค้ด -->
<canvas id="barcodeCanvas" style="display:none"></canvas>

<script>
/* ===== utils ===== */
function isCopyOptionChecked(){ const el=document.getElementById('copyReceipt'); return !!(el && el.checked); }
function convertNumberToThaiText(amount) {
  const txtnum=["ศูนย์","หนึ่ง","สอง","สาม","สี่","ห้า","หก","เจ็ด","แปด","เก้า"]; const txtdigit=["","สิบ","ร้อย","พัน","หมื่น","แสน","ล้าน"];
  if (typeof amount !== 'number') amount = parseFloat(amount); if (isNaN(amount)) return ""; amount = amount.toFixed(2);
  const [integerPart, decimalPart] = amount.split('.'); let bahtText=""; let len=integerPart.length;
  for (let i=0;i<len;i++){ const digit=parseInt(integerPart.charAt(i)); const position=len-i-1;
    if(digit!==0){ if(position===0 && digit===1 && len>1) bahtText+="เอ็ด"; else if(position===1 && digit===2) bahtText+="ยี่"; else if(position===1 && digit===1) bahtText+=""; else bahtText+=txtnum[digit]; bahtText+=txtdigit[position]||""; } }
  if(bahtText==="") bahtText=txtnum[0]; bahtText+="บาท";
  if(decimalPart==="00"){ bahtText+="ถ้วน"; }else{ let sat=""; const d1=parseInt(decimalPart.charAt(0)); const d2=parseInt(decimalPart.charAt(1));
    if(d1!==0){ if(d1===1) sat+="สิบ"; else if(d1===2) sat+="ยี่สิบ"; else sat+=txtnum[d1]+"สิบ"; } if(d2!==0){ if(d2===1 && d1!==0) sat+="เอ็ด"; else sat+=txtnum[d2]; } bahtText+=sat+"สตางค์"; }
  return bahtText;
}

/* ===== localStorage keys/const ===== */
const LS_REGISTRY_KEY='invoice_registry_v1';       // เก็บเลขที่ใบเสร็จที่ถูกใช้แล้ว (finalize)
const LS_INVOICE_PREFIX='invoice_v1_';             // เก็บข้อมูลใบเสร็จฉบับเต็ม
const LS_REF_INDEX_KEY='invoice_ref_index_v1';     // index รหัสอ้างอิง -> เลขที่ใบเสร็จ
const LS_AUTONUM_KEY='invoice_autonum_v1';         // เก็บเลขลำดับล่าสุดต่อปีสำหรับเลขอัตโนมัติ
const KEEP_DAYS=90; const MS_PER_DAY=24*60*60*1000;
const nowTs=()=>Date.now();

/* ===== registry/ref index helpers ===== */
const loadRegistry=()=>{ try{ return JSON.parse(localStorage.getItem(LS_REGISTRY_KEY))||{used:{}}; }catch(_){ return {used:{}}; } };
const saveRegistry=(reg)=> localStorage.setItem(LS_REGISTRY_KEY, JSON.stringify(reg));
const refIndexLoad=()=>{ try{ return JSON.parse(localStorage.getItem(LS_REF_INDEX_KEY))||{}; }catch(_){ return {}; } };
const refIndexSave=(m)=> localStorage.setItem(LS_REF_INDEX_KEY, JSON.stringify(m));
const refIndexSet=(ref,inv)=>{ if(!ref||!inv) return; const idx=refIndexLoad(); idx[ref]=inv; refIndexSave(idx); };
const refIndexRemove=(ref)=>{ if(!ref) return; const idx=refIndexLoad(); if(idx[ref]){ delete idx[ref]; refIndexSave(idx);} };

/* ===== Auto-number helpers ===== */
const loadAutoNum=()=>{ try{ return JSON.parse(localStorage.getItem(LS_AUTONUM_KEY))||{}; }catch(_){ return {}; } };
const saveAutoNum=(m)=> localStorage.setItem(LS_AUTONUM_KEY, JSON.stringify(m));
const isNumberUsed=(invNo)=> !!loadRegistry().used[invNo];
function pad(n, w){ return String(n).padStart(w, '0'); }
function formatInvoiceNumber(year, seq){ return `INV-${year}-${pad(seq,6)}`; }
function getInvoiceYear(){
  const val=document.getElementById('invoiceDate')?.value;
  if(val){ const y=new Date(val).getFullYear(); if(!isNaN(y)) return y; }
  return new Date().getFullYear();
}
function findNextFreeInvoiceNumber(){
  const year = getInvoiceYear().toString();
  const state = loadAutoNum();
  let seq = Number(state[year]||0);
  let candidate='';
  do{
    seq += 1;
    candidate = formatInvoiceNumber(year, seq);
  }while( isNumberUsed(candidate) || localStorage.getItem(LS_INVOICE_PREFIX+candidate) );
  state[year]=seq; saveAutoNum(state);
  return candidate;
}

/* ===== random code generators ===== */
function genRefCode(len=15){ const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; let o=''; for(let i=0;i<len;i++){ o += chars[Math.floor(Math.random()*chars.length)]; } return o; }
function genSerial(len=15){
  const exists=(sn)=>{ for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); if(k && k.startsWith(LS_INVOICE_PREFIX)){ try{ const d=JSON.parse(localStorage.getItem(k)); if(d && d.serial===sn) return true; }catch(_){}} } return false; };
  let s=''; do{ s=''; for(let i=0;i<len;i++){ s += Math.floor(Math.random()*10); } }while(exists(s));
  return s;
}

/* ===== read/write invoice ===== */
function getInvoice(invNo){ try{ return JSON.parse(localStorage.getItem(LS_INVOICE_PREFIX+invNo)); }catch(_){ return null; } }
function ensureRefCodeFor(invNo){
  if(!invNo) return ''; const key=LS_INVOICE_PREFIX+invNo; const d=getInvoice(invNo)||{invoiceNumber:invNo,createdAt:nowTs()};
  if(!d.refCode){ d.refCode=genRefCode(15); d.updatedAt=nowTs(); } localStorage.setItem(key, JSON.stringify(d)); if(d.refCode) refIndexSet(d.refCode, invNo); return d.refCode;
}
function ensureSerialFor(invNo){
  if(!invNo) return ''; const key=LS_INVOICE_PREFIX+invNo; const d=getInvoice(invNo)||{invoiceNumber:invNo,createdAt:nowTs()};
  if(!d.serial){ d.serial=genSerial(15); d.updatedAt=nowTs(); } localStorage.setItem(key, JSON.stringify(d)); return d.serial;
}
function saveDraft(data){
  if(!data.invoiceNumber) return; const key=LS_INVOICE_PREFIX+data.invoiceNumber; const prev=getInvoice(data.invoiceNumber);
  const payload={...prev,...data,createdAt:prev?.createdAt||nowTs(),updatedAt:nowTs(),finalizedAt:prev?.finalizedAt||null};
  if(!payload.refCode) payload.refCode=genRefCode(15);
  if(!payload.serial)  payload.serial =genSerial(15);
  localStorage.setItem(key, JSON.stringify(payload));
  refIndexSet(payload.refCode, data.invoiceNumber);
}
function finalizeInvoice(invNo){
  if(!invNo) return; const key=LS_INVOICE_PREFIX+invNo; const d=getInvoice(invNo)||{invoiceNumber:invNo,createdAt:nowTs()}; const finalizedAt=nowTs();
  if(!d.refCode) d.refCode=genRefCode(15);
  if(!d.serial)  d.serial =genSerial(15);
  d.finalizedAt=finalizedAt; localStorage.setItem(key, JSON.stringify(d));
  const reg=loadRegistry(); reg.used[invNo]=reg.used[invNo]||finalizedAt; saveRegistry(reg); refIndexSet(d.refCode, invNo);
}
function cleanupExpired(){
  const reg=loadRegistry(); const keys=[]; for(let i=0;i<localStorage.length;i++){ keys.push(localStorage.key(i)); }
  keys.forEach(k=>{ if(!k||!k.startsWith(LS_INVOICE_PREFIX)) return; try{ const d=JSON.parse(localStorage.getItem(k)); if(!d||!d.createdAt) return;
    const age=(nowTs()-(d.createdAt))/MS_PER_DAY; if(age>KEEP_DAYS){ if(d.invoiceNumber){ reg.used[d.invoiceNumber]=reg.used[d.invoiceNumber]||d.finalizedAt||d.createdAt||nowTs(); }
      if(d.refCode){ refIndexRemove(d.refCode); } localStorage.removeItem(k); } }catch(_){}}); saveRegistry(reg);
}

/* ===== BARCODE (Serial Number) ===== */
function getBarcodeDataUrl(code){
  try{
    const canvas=document.getElementById('barcodeCanvas');
    if(!canvas || typeof JsBarcode === 'undefined') return '';
    JsBarcode(canvas, (code||''), { format:'CODE128', width: 1, height: 28, displayValue:false, margin:0 });
    return canvas.toDataURL('image/png');
  }catch(e){ console.warn('Barcode render failed', e); return ''; }
}

/* ===== ฟอร์ม & ใบเสร็จ ===== */
function getFormData(){
  const items=[]; document.querySelectorAll('.item-row').forEach(r=>{
    items.push({ description:r.querySelector('.item-description')?.value?.trim()||'', quantity:parseFloat(r.querySelector('.item-quantity')?.value||'0')||0, price:parseFloat(r.querySelector('.item-price')?.value||'0')||0 });
  });
  return {
    companyName:document.getElementById('companyName').value.trim(),
    companyAddress:document.getElementById('companyAddress').value.trim(),
    companyPhone:document.getElementById('companyPhone').value.trim(),
    companyTaxId:document.getElementById('companyTaxId').value.trim(),
    customerName:document.getElementById('customerName').value.trim(),
    customerAddress:document.getElementById('customerAddress').value.trim(),
    customerTaxId:document.getElementById('customerTaxId').value.trim(),
    invoiceNumber:document.getElementById('invoiceNumber').value.trim(),
    invoiceDate:document.getElementById('invoiceDate').value,
    dueDate:document.getElementById('dueDate').value,
    payeeName:document.getElementById('payeeName').value.trim(),
    payeeSignatureDataUrl:document.getElementById('payeeSignatureDataUrl').value||'',
    items
  };
}
function setFormFromData(d){
  if(!d) return;
  document.getElementById('companyName').value=d.companyName||'';
  document.getElementById('companyAddress').value=d.companyAddress||'';
  document.getElementById('companyPhone').value=d.companyPhone||'';
  document.getElementById('companyTaxId').value=d.companyTaxId||'';
  document.getElementById('customerName').value=d.customerName||'';
  document.getElementById('customerAddress').value=d.customerAddress||'';
  document.getElementById('customerTaxId').value=d.customerTaxId||'';
  document.getElementById('invoiceNumber').value=d.invoiceNumber||'';
  document.getElementById('invoiceDate').value=d.invoiceDate||'';
  document.getElementById('dueDate').value=d.dueDate||'';
  document.getElementById('payeeName').value=d.payeeName||'';
  document.getElementById('payeeSignatureDataUrl').value=d.payeeSignatureDataUrl||''; updateSigPreview();
  const itemsContainer=document.getElementById('itemsContainer'); itemsContainer.innerHTML='';
  (d.items&&d.items.length?d.items:[{description:'',quantity:1,price:0}]).forEach(it=>{
    const row=document.createElement('div'); row.className='item-row';
    row.innerHTML=`<input type="text" class="item-description" placeholder="รายละเอียดสินค้า/บริการ" required value="${it.description??''}"/>
    <input type="number" class="item-quantity" min="1" step="1" value="${it.quantity??1}" required />
    <input type="number" class="item-price" min="0" step="0.01" value="${(typeof it.price==='number'?it.price.toFixed(2):it.price||0)}" required />
    <input type="text" class="item-total" readonly placeholder="0.00" />
    <button type="button" class="remove-item-btn" title="ลบรายการ"><i class="fa-solid fa-times"></i></button>`;
    itemsContainer.appendChild(row);
  });
}
function toggleActionButtons(dis, reason=''){ const submitBtn=document.querySelector('button[type="submit"].btn-primary'); const pdfBtn=document.getElementById('generatePdfBtn');
  submitBtn.disabled=!!dis; pdfBtn.disabled=!!dis; submitBtn.title=dis?reason:''; pdfBtn.title=dis?reason:''; }

/* ===== HTML ใบเสร็จ (ขาวดำ) + BARCODE(SERIAL) + ขอบคุณ + ref code ===== */
function generateReceiptHTML(isCopy=false){
  const companyNameVal=document.getElementById('companyName').value.trim();
  const companyAddressVal=document.getElementById('companyAddress').value.trim();
  const companyPhoneVal=document.getElementById('companyPhone').value.trim();
  const companyTaxIdVal=document.getElementById('companyTaxId').value.trim();
  const customerNameVal=document.getElementById('customerName').value.trim()||'-';
  const customerAddressVal=document.getElementById('customerAddress').value.trim()||'-';
  const customerTaxIdVal=document.getElementById('customerTaxId').value.trim()||'-';
  const invoiceNumberVal=document.getElementById('invoiceNumber').value.trim();
  const invoiceDateVal=document.getElementById('invoiceDate').value;
  const dueDateVal=document.getElementById('dueDate').value||'-';
  const payeeNameVal=document.getElementById('payeeName').value.trim()||'-';
  const refSig=document.getElementById('payeeSignatureDataUrl').value||'';

  const serialNo = invoiceNumberVal ? ensureSerialFor(invoiceNumberVal) : '';
  const refCode  = invoiceNumberVal ? ensureRefCodeFor(invoiceNumberVal)  : '';

  const barcodeUrl = serialNo ? getBarcodeDataUrl(serialNo) : '';
  const now=new Date(); const printDate=now.toLocaleDateString('th-TH',{year:'numeric',month:'2-digit',day:'2-digit'});

  let itemsHtml=''; let totalAmount=0;
  document.querySelectorAll('.item-row').forEach(row=>{
    const desc=(row.querySelector('.item-description').value||'').trim();
    const qty=parseFloat(row.querySelector('.item-quantity').value)||0;
    const price=parseFloat(row.querySelector('.item-price').value)||0;
    const amt=qty*price; totalAmount+=amt;
    itemsHtml += `<tr><td>${desc}</td><td class="text-right">${qty}</td><td class="text-right">${price.toFixed(2)}</td><td class="text-right">${amt.toFixed(2)}</td></tr>`;
  });

  return `<!DOCTYPE html><html lang="th"><head><meta charset="UTF-8" />
  <title>ใบเสร็จรับเงิน${isCopy?' (สำเนา)':''}</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    body{font-family:'Sarabun',sans-serif;padding:40px;background:#fff;color:#000;line-height:1.4;}
    .receipt-container{max-width:900px;margin:0 auto;background:#fff;padding:40px;position:relative;color:#000;}
    .receipt-header{text-align:center;border-bottom:2px solid #000;padding-bottom:20px;margin-bottom:30px;}
    .receipt-header h3{font-size:2rem;color:#000;margin:0 0 10px;}
    .receipt-title{background:#f2f2f2;color:#000;padding:12px 15px;border:1px solid #000;border-radius:6px;font-size:1.6rem;font-weight:700;text-align:center;margin:18px 0;}
    .receipt-details{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px;padding:16px;background:#fafafa;border:1px solid #000;border-radius:6px;}
    .receipt-table{width:100%;border-collapse:collapse;margin-bottom:24px;border:1px solid #000;border-radius:6px;overflow:hidden;}
    .receipt-table th{background:#e6e6e6;color:#000;padding:12px;font-size:1rem;font-weight:700;text-align:left;border-bottom:1px solid #000;}
    .receipt-table td{padding:10px 12px;border-bottom:1px solid #ccc;font-size:1rem;color:#000;}
    .receipt-table tr:nth-child(even){background:#fafafa;}
    .text-right{text-align:right;}
    .total-row{font-weight:700;font-size:1.1rem;background:#e0e0e0!important;}
    .sig-img{max-width:80%;max-height:120px;display:block;margin:0 auto 6px auto;filter:grayscale(100%);}
    .ref-code{font-size:.85rem;color:#000;margin-top:6px;text-align:left;}
    .thankyou-line{ text-align:center; font-size:1.05rem; color:#000; margin-top:10px; font-weight:600; }
    .barcode-head{ position:absolute; top:20px; right:20px; text-align:right; }
    .barcode-head img{ display:block; height:28px; }
    .barcode-text{ font-size:.70rem; letter-spacing:.06em; color:#000; margin-top:2px; }
    .copy-mark{ color:#000; font-size:1.0rem; font-weight:700; margin-top:6px; }
  </style></head><body>
  <div class="receipt-container">
    <div class="barcode-head">
      ${barcodeUrl?`<img src="${barcodeUrl}" alt="barcode">`:''}
      ${serialNo?`<div class="barcode-text"> ${serialNo}</div>`:''}
      ${isCopy?`<div class="copy-mark">(สำเนา)</div>`:''}
    </div>

    <div class="receipt-header">
      <h3>${companyNameVal}</h3>
      <p>${companyAddressVal}</p>
      <p>โทรศัพท์: ${companyPhoneVal||'-'}</p>
      <p>เลขประจำตัวผู้เสียภาษี: ${companyTaxIdVal||'-'}</p>
    </div>

    <div class="receipt-title">ใบเสร็จรับเงิน</div>

    <div class="receipt-details">
      <div>
        <p><strong>ชื่อลูกค้า:</strong> ${customerNameVal}</p>
        <p><strong>ที่อยู่ลูกค้า:</strong> ${customerAddressVal}</p>
        <p><strong>เลขประจำตัวผู้เสียภาษีลูกค้า:</strong> ${customerTaxIdVal}</p>
      </div>
      <div>
        <p><strong>เลขที่ใบเสร็จ:</strong> ${invoiceNumberVal}</p>
        <p><strong>วันที่ออกใบเสร็จ:</strong> ${invoiceDateVal}</p>
        <p><strong>ครบกำหนดชำระ:</strong> ${dueDateVal}</p>
      </div>
    </div>

    <table class="receipt-table"><thead>
      <tr><th>รายการสินค้า/บริการ</th><th style="width:80px;text-align:right;">จำนวน</th><th style="width:120px;text-align:right;">ราคาต่อหน่วย (บาท)</th><th style="width:140px;text-align:right;">รวม (บาท)</th></tr>
    </thead><tbody>
      ${itemsHtml}
      <tr class="total-row"><td colspan="3" class="text-right">ยอดรวมทั้งสิ้น</td><td class="text-right">${totalAmount.toFixed(2)}</td></tr>
    </tbody></table>

    <div style="font-weight:700;padding:14px;font-size:1.15rem;background:#f6f6f6;border-radius:6px;text-align:center;border:1px solid #000;color:#000;">จำนวนเงิน: ${convertNumberToThaiText(totalAmount)}</div>

    <div style="display:flex;justify-content:flex-end;margin-top:36px;padding-top:18px;border-top:1px dashed #000;">
      <div style="text-align:center;width:45%;color:#000;">
        ${refSig?`<img class="sig-img" src="${refSig}" alt="payee signature">`:''}
        <div style="border-bottom:1px solid #000;width:80%;margin:0 auto 8px auto;height:1px;"></div>
        <p style="font-weight:600;">(ลงชื่อผู้รับเงิน ${payeeNameVal})</p>
        <p style="font-weight:600;">วันที่: ${invoiceDateVal}</p>
      </div>
    </div>

    <div class="thankyou-line">ขอบคุณที่อุดหนุนและไว้วางใจเรา</div>

    <div style="text-align:right;color:#000;font-size:.95rem;margin-top:10px;">พิมพ์เมื่อ: ${printDate} • พิมพ์โดย ${payeeNameVal||'-'}</div>
    <div style="text-align:right;color:#000;font-size:.95rem;margin-top:10px;">(Designed by Ponrakit)</div>
    ${refCode?`<div class="ref-code">รหัสอ้างอิงเอกสาร: ${refCode}</div>`:''}
  </div></body></html>`;
}

/* ===== ตรวจสอบเอกสารด้วยเลขอ้างอิง ===== */
const normalizeRef=(s)=> (s||'').toUpperCase().replace(/[^A-Z0-9]/g,'').trim();
function verifyByRef(ref){
  const code=normalizeRef(ref); if(!code) return {ok:false,reason:'empty'};
  const idx=refIndexLoad(); let inv=idx[code]||null; let data=null; if(inv){ data=getInvoice(inv); }
  if(!data){ for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); if(k&&k.startsWith(LS_INVOICE_PREFIX)){ try{ const d=JSON.parse(localStorage.getItem(k)); if(d && normalizeRef(d.refCode)===code){ data=d; inv=d.invoiceNumber; break; } }catch(_){}}}}
  if(!data) return {ok:false,reason:'notfound'};
  const age=(nowTs()-(data.createdAt||nowTs()))/MS_PER_DAY; if(age>KEEP_DAYS) return {ok:false,reason:'expired'};
  if(!data.finalizedAt) return {ok:false,reason:'notfinal'};
  return {ok:true,data};
}
function renderVerifyResult(res){
  const box=document.getElementById('verifyResult'); const searchedAt=new Date().toLocaleString('th-TH',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'});
  if(res.ok){
    const d=res.data;
    box.innerHTML=`<div class="verify-box success"><p><strong>ผลการตรวจสอบ:</strong> <span class="tag ok">เอกสารถูกต้อง</span></p>
    <p>เลขที่ใบเสร็จ: <b>${d.invoiceNumber||'-'}</b></p><p>วันที่ออกใบเสร็จ: <b>${d.invoiceDate||'-'}</b></p><p>วันที่ค้นหา: <b>${searchedAt}</b></p></div>`;
  }else{
    let tag='<span class="tag no">ไม่พบเอกสาร</span>', cls='fail', note='';
    if(res.reason==='empty'){ note='กรุณากรอกเลขอ้างอิงก่อน'; }
    if(res.reason==='expired'){ tag='<span class="tag warn">หมดอายุเกิน 90 วัน</span>'; cls='warn'; note='เอกสารถูกลบตามรอบเก็บข้อมูล'; }
    if(res.reason==='notfinal'){ tag='<span class="tag warn">ยังไม่สร้าง PDF (ไม่ถือว่าออกโดยระบบ)</span>'; cls='warn'; }
    box.innerHTML=`<div class="verify-box ${cls}"><p><strong>ผลการตรวจสอบ:</strong> ${tag}</p><p>วันที่ค้นหา: <b>${searchedAt}</b></p>${note?`<p style="color:#6b7280;">${note}</p>`:''}</div>`;
  }
}

/* ===== ลายเซ็น ===== */
function updateSigPreview(){ const v=document.getElementById('payeeSignatureDataUrl').value||''; const wrap=document.getElementById('sigPreview'); const img=document.getElementById('sigImg'); if(v){ img.src=v; wrap.style.display='inline-block'; } else { img.src=''; wrap.style.display='none'; } }
function setSignatureDataUrl(d){ document.getElementById('payeeSignatureDataUrl').value=d||''; updateSigPreview(); const f=getFormData(); if(f.invoiceNumber) saveDraft(f); }
async function normalizeImageToBW(src){ return new Promise((res)=>{ const img=new Image(); img.onload=()=>{ const targetW=800, ratio=img.width?Math.min(1,targetW/img.width):1; const w=Math.round(img.width*ratio), h=Math.round(img.height*ratio);
  const cvs=document.createElement('canvas'); cvs.width=w; cvs.height=h; const ctx=cvs.getContext('2d'); ctx.fillStyle='#fff'; ctx.fillRect(0,0,w,h); if('filter' in ctx) ctx.filter='grayscale(100%)'; ctx.drawImage(img,0,0,w,h); res(cvs.toDataURL('image/png')); }; img.onerror=()=>res(''); img.src=src; }); }

/* ===== PDF (ใส่รหัสผ่านด้วย pdfmake; fallback jsPDF) ===== */
function getPdfPasswordIfAny(){ const useEl=document.getElementById('usePdfPassword'); if(!useEl || !useEl.checked) return ''; const p1=document.getElementById('pdfPassword')?.value||''; const p2=document.getElementById('pdfPasswordConfirm')?.value||''; if(p1.length<4){ alert('รหัสผ่านต้องอย่างน้อย 4 ตัวอักษร'); return null; } if(p1!==p2){ alert('ยืนยันรหัสผ่านไม่ตรงกัน'); return null; } return p1; }
function pdfMakeDownloadWithPassword(imgData, filename, password){
  return new Promise((resolve,reject)=>{
    try{
      if(typeof pdfMake==='undefined' || !pdfMake.createPdf){ reject(new Error('pdfMake not loaded')); return; }
      const ownerPw = password || (Math.random().toString(36).slice(2)+Math.random().toString(36).slice(2));
      const def={ pageSize:'A4', pageMargins:[10,10,10,10], userPassword:password, ownerPassword:ownerPw,
        permissions:{ printing:'highResolution', modifying:false, copying:false, annotating:false, fillingForms:false, contentAccessibility:true, documentAssembly:false },
        content:[{ image: imgData, width: 555 }] };
      const doc=pdfMake.createPdf(def);
      doc.getBlob(function(blob){ const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click();
        setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); resolve(); },0); });
    }catch(err){ reject(err); }
  });
}

/* ===== MAIN ===== */
document.addEventListener('DOMContentLoaded', function(){
  cleanupExpired();
  document.getElementById('invoiceDate').value=new Date().toISOString().split('T')[0];

  const itemsContainer=document.getElementById('itemsContainer');
  const addItemBtn=document.getElementById('addItemBtn');
  function updateItemTotal(row){ const qty=parseFloat(row.querySelector('.item-quantity').value)||0; const price=parseFloat(row.querySelector('.item-price').value)||0; row.querySelector('.item-total').value=(qty*price).toFixed(2); }
  function removeItemRow(e){ const btn=e.target.closest('.remove-item-btn')||e.target; if(itemsContainer.children.length>1) btn.closest('.item-row').remove(); else alert('ต้องมีรายการอย่างน้อย 1 รายการ'); const d=getFormData(); if(d.invoiceNumber) saveDraft(d); }
  function createItemRow(){ const div=document.createElement('div'); div.className='item-row';
    div.innerHTML=`<input type="text" class="item-description" placeholder="รายละเอียดสินค้า/บริการ" required />
      <input type="number" class="item-quantity" min="1" step="1" value="1" required />
      <input type="number" class="item-price" min="0" step="0.01" value="0.00" required />
      <input type="text" class="item-total" readonly placeholder="0.00" />
      <button type="button" class="remove-item-btn" title="ลบรายการ"><i class="fa-solid fa-times"></i></button>`; return div; }
  function attachRowListeners(row){ row.querySelector('.item-quantity').addEventListener('input',()=>{updateItemTotal(row); const d=getFormData(); if(d.invoiceNumber) saveDraft(d);});
    row.querySelector('.item-price').addEventListener('input',()=>{updateItemTotal(row); const d=getFormData(); if(d.invoiceNumber) saveDraft(d);});
    row.querySelector('.remove-item-btn').addEventListener('click', removeItemRow); updateItemTotal(row); }
  itemsContainer.querySelectorAll('.item-row').forEach(attachRowListeners);
  addItemBtn.addEventListener('click',()=>{ const row=createItemRow(); itemsContainer.appendChild(row); attachRowListeners(row); const d=getFormData(); if(d.invoiceNumber) saveDraft(d); });

  // autosave ฟิลด์
  ['companyName','companyAddress','companyPhone','companyTaxId','customerName','customerAddress','customerTaxId','invoiceNumber','invoiceDate','dueDate','payeeName']
    .forEach(id=>{ const el=document.getElementById(id); el.addEventListener('input',()=>{ const d=getFormData(); if(d.invoiceNumber) saveDraft(d); }); });

  // ปุ่มสร้างเลขอัตโนมัติ
  document.getElementById('autoGenInvoiceBtn').addEventListener('click', ()=>{
    const next = findNextFreeInvoiceNumber();
    const invoiceNumberEl=document.getElementById('invoiceNumber');
    invoiceNumberEl.value = next;
    toggleActionButtons(false);
    ensureSerialFor(next); ensureRefCodeFor(next);
    saveDraft(getFormData());
  });

  // เมื่อเปลี่ยน "วันที่ออกใบเสร็จ" แล้วเลขยังว่าง ให้เดางวดเลขปีใหม่ตอนกดปุ่มเลขอัตโนมัติ (ทำใน findNextFreeInvoiceNumber อยู่แล้ว)

  // เลขซ้ำเมื่อ finalize + preload draft + ensure serial/ref เมื่อกรอกเอง
  const invoiceNumberEl=document.getElementById('invoiceNumber');
  invoiceNumberEl.addEventListener('blur',()=>{ const inv=invoiceNumberEl.value.trim(); if(!inv){ toggleActionButtons(false); return; }
    ensureSerialFor(inv); ensureRefCodeFor(inv);
    const stored=getInvoice(inv); if(stored){ setFormFromData(stored); }
    if(isNumberUsed(inv)){ toggleActionButtons(true,'เลขนี้ถูกใช้แล้ว'); alert('เลขที่ใบเสร็จนี้ถูกใช้ไปแล้ว ไม่สามารถใช้ซ้ำได้'); } else { toggleActionButtons(false); }
  });

  /* ลายเซ็น */
  const sigModal=document.getElementById('sigModal'), sigCanvas=document.getElementById('sigCanvas'); const signatureFile=document.getElementById('signatureFile');
  const openSigPad=document.getElementById('openSigPad'), sigClose=document.getElementById('sigClose'), sigClose2=document.getElementById('sigClose2'), sigClearBtn=document.getElementById('sigClearBtn'), sigSaveBtn=document.getElementById('sigSaveBtn');
  function openModal(){ sigModal.style.display='flex'; resizeCanvas(); } function closeModal(){ sigModal.style.display='none'; }
  openSigPad.addEventListener('click',openModal); sigClose.addEventListener('click',closeModal); sigClose2.addEventListener('click',closeModal); sigModal.addEventListener('click',(e)=>{ if(e.target===sigModal) closeModal(); });
  let drawing=false,lastX=0,lastY=0; function resizeCanvas(){ const ratio=Math.max(window.devicePixelRatio||1,1); const w=sigCanvas.clientWidth,h=sigCanvas.clientHeight; sigCanvas.width=Math.round(w*ratio); sigCanvas.height=Math.round(h*ratio);
    const ctx=sigCanvas.getContext('2d'); ctx.scale(ratio,ratio); ctx.fillStyle='#fff'; ctx.fillRect(0,0,w,h); ctx.lineJoin='round'; ctx.lineCap='round'; ctx.lineWidth=2; ctx.strokeStyle='#000'; }
  window.addEventListener('resize',()=>{ if(sigModal.style.display==='flex') resizeCanvas(); });
  const pos=(e)=>{ const r=sigCanvas.getBoundingClientRect(); const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left; const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top; return {x,y}; };
  function start(e){ e.preventDefault(); drawing=true; const p=pos(e); lastX=p.x; lastY=p.y; } function move(e){ if(!drawing) return; e.preventDefault(); const p=pos(e); const ctx=sigCanvas.getContext('2d'); ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(p.x,p.y); ctx.stroke(); lastX=p.x; lastY=p.y; } function end(){ drawing=false; }
  sigCanvas.addEventListener('mousedown',start); sigCanvas.addEventListener('mousemove',move); sigCanvas.addEventListener('mouseup',end); sigCanvas.addEventListener('mouseleave',end);
  sigCanvas.addEventListener('touchstart',start,{passive:false}); sigCanvas.addEventListener('touchmove',move,{passive:false}); sigCanvas.addEventListener('touchend',end);
  sigClearBtn.addEventListener('click',resizeCanvas); sigSaveBtn.addEventListener('click',()=>{ const dataUrl=sigCanvas.toDataURL('image/png'); setSignatureDataUrl(dataUrl); closeModal(); });
  document.getElementById('pickSigFile').addEventListener('click',()=> signatureFile.click());
  signatureFile.addEventListener('change', async (e)=>{ const f=e.target.files&&e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=async ()=>{ const mono=await normalizeImageToBW(r.result); setSignatureDataUrl(mono||r.result); }; r.readAsDataURL(f); e.target.value=''; });
  document.getElementById('clearSig').addEventListener('click',()=> setSignatureDataUrl(''));
  updateSigPreview();

  /* toggle ฟิลด์รหัสผ่าน */
  const usePdfPasswordEl=document.getElementById('usePdfPassword'), passwordFields=document.getElementById('passwordFields');
  usePdfPasswordEl.addEventListener('change', ()=>{ passwordFields.style.display = usePdfPasswordEl.checked ? 'block' : 'none'; });

  /* ดูใบเสร็จ (ไม่ finalize) — ถ้าช่องเลขว่าง จะออกเลขให้อัตโนมัติ */
  document.getElementById('invoiceForm').addEventListener('submit', function(e){
    e.preventDefault();

    // ออกเลขให้อัตโนมัติหากว่าง
    const invEl=document.getElementById('invoiceNumber');
    if(!invEl.value.trim()){
      invEl.value = findNextFreeInvoiceNumber();
      ensureSerialFor(invEl.value); ensureRefCodeFor(invEl.value);
      saveDraft(getFormData());
    }

    const req=['companyName','companyAddress','invoiceNumber','invoiceDate','payeeName']; let err=false; 
    req.forEach(id=>{ const f=document.getElementById(id); if(!f.value.trim()){ f.style.borderColor='#ff4757'; err=true; } else { f.style.borderColor='#e1e5e9'; } });
    if(err){ alert('กรุณากรอกข้อมูลที่จำเป็นให้ครบถ้วน'); return; }

    const inv=invEl.value.trim(); if(isNumberUsed(inv)){ toggleActionButtons(true,'เลขนี้ถูกใช้แล้ว'); alert('เลขที่ใบเสร็จนี้ถูกใช้ไปแล้ว'); return; }

    const isCopy=isCopyOptionChecked();
    const html=generateReceiptHTML(false); const w=window.open('','_blank','width=900,height=700'); w.document.write(html); w.document.close();
    if(isCopy){ const html2=generateReceiptHTML(true); const w2=window.open('','_blank','width=900,height=700'); w2.document.write(html2); w2.document.close(); }
  });

  /* สร้าง PDF (finalize) — ถ้าเลขว่างจะออกให้อัตโนมัติ */
  document.getElementById('generatePdfBtn').addEventListener('click', async function(){
    try{
      // ออกเลขให้อัตโนมัติหากว่าง
      const invEl=document.getElementById('invoiceNumber');
      if(!invEl.value.trim()){
        invEl.value = findNextFreeInvoiceNumber();
        ensureSerialFor(invEl.value); ensureRefCodeFor(invEl.value);
        saveDraft(getFormData());
      }

      const req=['companyName','companyAddress','invoiceNumber','invoiceDate','payeeName']; let err=false; 
      req.forEach(id=>{ const f=document.getElementById(id); if(!f.value.trim()){ f.style.borderColor='#ff4757'; err=true; } else { f.style.borderColor='#e1e5e9'; } });
      if(err){ alert('กรุณากรอกข้อมูลที่จำเป็นให้ครบถ้วน'); return; }

      const inv=invEl.value.trim(); if(isNumberUsed(inv)){ toggleActionButtons(true,'เลขนี้ถูกใช้แล้ว'); alert('เลขที่ใบเสร็จนี้ถูกใช้ไปแล้ว'); return; }

      const pw=getPdfPasswordIfAny(); if(pw===null) return;

      saveDraft(getFormData()); ensureSerialFor(inv); const ref=ensureRefCodeFor(inv);

      const btn=this, old=btn.innerHTML; btn.innerHTML='⏳ กำลังสร้าง PDF...'; btn.disabled=true;
      const dateStr=new Date().toISOString().split('T')[0];

      async function renderImg(isCopy){
        const tmp=document.createElement('div'); tmp.innerHTML=generateReceiptHTML(isCopy); tmp.style.position='absolute'; tmp.style.left='-9999px'; tmp.style.width='900px'; document.body.appendChild(tmp);
        await document.fonts.ready; const el=tmp.querySelector('.receipt-container'); const canvas=await html2canvas(el,{scale:2,useCORS:true,allowTaint:true,backgroundColor:'#fff',width:900,windowWidth:900}); document.body.removeChild(tmp); return canvas.toDataURL('image/png');
      }
      async function saveOne(isCopy){
        const img=await renderImg(isCopy); const fileName=`ใบเสร็จ_${inv}${isCopy?'_สำเนา':''}_${dateStr}.pdf`;
        if(pw){ try{ await pdfMakeDownloadWithPassword(img, fileName, pw); } catch(_){ const { jsPDF }=window.jspdf; const pdf=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'}); const imgEl=new Image(); imgEl.src=img; await new Promise(r=>{ imgEl.onload=r; imgEl.onerror=r; }); const imgW=190, imgH=(imgEl.height*imgW)/imgEl.width; pdf.addImage(img,'PNG',10,10,imgW,imgH); pdf.save(fileName); } }
        else{ const { jsPDF }=window.jspdf; const pdf=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'}); const imgEl=new Image(); imgEl.src=img; await new Promise(r=>{ imgEl.onload=r; imgEl.onerror=r; }); const imgW=190, imgH=(imgEl.height*imgW)/imgEl.width; pdf.addImage(img,'PNG',10,10,imgW,imgH); pdf.save(fileName); }
      }

      if(isCopyOptionChecked()){ await saveOne(false); await saveOne(true); } else { await saveOne(false); }

      finalizeInvoice(inv); toggleActionButtons(true,'เลขนี้ถูกใช้แล้ว');
      const verifyInput=document.getElementById('verifyRefInput'); if(verifyInput){ verifyInput.value=ref; } renderVerifyResult(verifyByRef(ref));
      alert(`สร้าง PDF สำเร็จ${pw?' (ตั้งรหัสผ่านแล้ว)':''}\nเลขอ้างอิง: ${ref}`);

      btn.innerHTML=old; btn.disabled=false;
    }catch(err){
      console.error(err); alert('เกิดข้อผิดพลาดในการสร้าง PDF'); const btn=document.getElementById('generatePdfBtn'); btn.innerHTML='<i class="fa-solid fa-file-pdf"></i> สร้าง PDF'; btn.disabled=false;
    }
  });

  /* ประวัติ */
  const historyBtn=document.getElementById('historyBtn'), historyModal=document.getElementById('historyModal'), historyClose=document.getElementById('historyClose'), historyClose2=document.getElementById('historyClose2'), historyTbody=document.getElementById('historyTbody'), historySearch=document.getElementById('historySearch');
  function calcTotal(items){ return (items||[]).reduce((s,it)=> s+(Number(it.quantity)||0)*(Number(it.price)||0),0); }
  function loadHistoryList(){ cleanupExpired(); const keys=[]; for(let i=0;i<localStorage.length;i++){ keys.push(localStorage.key(i)); } const rows=[];
    keys.forEach(k=>{ if(!k.startsWith(LS_INVOICE_PREFIX)) return; try{ const d=JSON.parse(localStorage.getItem(k)); if(!d||!d.finalizedAt) return; const age=(nowTs()-(d.createdAt||nowTs()))/MS_PER_DAY; if(age>KEEP_DAYS) return;
      rows.push({ invoiceNumber:d.invoiceNumber, invoiceDate:d.invoiceDate||'', customerName:d.customerName||'', total:calcTotal(d.items), data:d }); }catch(_){ } }); rows.sort((a,b)=>(b.data.finalizedAt||0)-(a.data.finalizedAt||0)); return rows; }
  function renderHistoryTable(q=''){ const rows=loadHistoryList(); const s=(q||'').toLowerCase().trim(); historyTbody.innerHTML=''; rows.filter(r=>!s||(r.invoiceNumber||'').toLowerCase().includes(s)||(r.customerName||'').toLowerCase().includes(s)).forEach(r=>{
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.invoiceNumber}</td><td>${r.invoiceDate||'-'}</td><td>${r.customerName||'-'}</td><td class="text-right">${r.total.toFixed(2)}</td>
      <td><div class="row-actions"><button class="btn-mini btn-grey btn-view" data-inv="${r.invoiceNumber}"><i class="fa-solid fa-eye"></i> เปิด</button>
      <button class="btn-mini btn-grey btn-pdf" data-inv="${r.invoiceNumber}"><i class="fa-solid fa-file-pdf"></i> PDF</button></div></td>`; historyTbody.appendChild(tr); });
    if(historyTbody.children.length===0){ const tr=document.createElement('tr'); tr.innerHTML=`<td colspan="5" style="text-align:center;color:#777;padding:16px;">ไม่พบรายการในช่วง 90 วัน</td>`; historyTbody.appendChild(tr); } }
  const openHistory=()=>{ historyModal.style.display='flex'; renderHistoryTable(historySearch.value); }; const closeHistory=()=>{ historyModal.style.display='none'; };
  historyBtn.addEventListener('click', openHistory); historyClose.addEventListener('click', closeHistory); historyClose2.addEventListener('click', closeHistory); historyModal.addEventListener('click',(e)=>{ if(e.target===historyModal) closeHistory(); });
  historySearch.addEventListener('input', ()=> renderHistoryTable(historySearch.value));

  // เปิดดู/สำเนา PDF จากประวัติ (ไม่กระทบสถานะใช้เลข)
  historyTbody.addEventListener('click', async (e)=>{
    const btn=e.target.closest('button'); if(!btn) return; const inv=btn.getAttribute('data-inv'); if(!inv) return; const data=getInvoice(inv); if(!data){ alert('ไม่พบข้อมูล (อาจหมดอายุแล้ว)'); renderHistoryTable(historySearch.value); return; }
    let total=0; const itemsHtml=(data.items||[]).map(it=>{ const q=Number(it.quantity)||0,p=Number(it.price)||0,a=q*p; total+=a; return `<tr><td>${it.description||''}</td><td class="text-right">${q}</td><td class="text-right">${p.toFixed(2)}</td><td class="text-right">${a.toFixed(2)}</td></tr>`; }).join('');
    const serial=(data.serial||''); const barcodeUrl=serial?getBarcodeDataUrl(serial):''; const printDateNow = new Date().toLocaleDateString('th-TH', {year:'numeric',month:'2-digit',day:'2-digit'});
    const refCode=(data.refCode||'').toUpperCase();

    if(btn.classList.contains('btn-view')){
      const w=window.open('','_blank','width=900,height=700'); w.document.write(`<!DOCTYPE html><html lang="th"><head><meta charset="UTF-8" />
      <title>ใบเสร็จรับเงิน (สำเนา)</title><link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet" />
      <style>body{font-family:'Sarabun',sans-serif;padding:40px;background:#fff;color:#000;line-height:1.4;}
      .receipt-container{max-width:900px;margin:0 auto;background:#fff;padding:40px;position:relative;color:#000;}
      .receipt-header{text-align:center;border-bottom:2px solid #000;padding-bottom:20px;margin-bottom:30px;}
      .receipt-title{background:#f2f2f2;color:#000;padding:12px 15px;border:1px solid #000;border-radius:6px;font-size:1.6rem;font-weight:700;text-align:center;margin:18px 0;}
      .receipt-details{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px;padding:16px;background:#fafafa;border:1px solid #000;border-radius:6px;}
      .receipt-table{width:100%;border-collapse:collapse;margin-bottom:24px;border:1px solid #000;border-radius:6px;overflow:hidden;}
      .receipt-table th{background:#e6e6e6;color:#000;padding:12px;font-size:1rem;text-align:left;border-bottom:1px solid #000;}
      .receipt-table td{padding:10px 12px;border-bottom:1px solid #ccc;font-size:1rem;color:#000;}
      .text-right{text-align:right;}.total-row{font-weight:700;font-size:1.1rem;background:#e0e0e0!important;}
      .sig-img{max-width:80%;max-height:120px;display:block;margin:0 auto 6px auto;filter:grayscale(100%);}
      .ref-code{font-size:.85rem;color:#000;margin-top:6px;text-align:left;}
      .barcode-head{ position:absolute; top:20px; right:20px; text-align:right; }
      .barcode-head img{ display:block; height:28px; }
      .barcode-text{ font-size:.70rem; letter-spacing:.06em; color:#000; margin-top:2px; }
      .copy-mark{ color:#000; font-size:1.0rem; font-weight:700; margin-top:6px; }
      </style></head><body>
      <div class="receipt-container">
        <div class="barcode-head">
          ${barcodeUrl?`<img src="${barcodeUrl}" alt="barcode">`:''}
          ${serial?`<div class="barcode-text"> ${serial}</div>`:''}
          <div class="copy-mark">(สำเนา)</div>
        </div>
        <div class="receipt-header"><h3>${data.companyName||''}</h3><p>${data.companyAddress||''}</p><p>โทรศัพท์: ${data.companyPhone||'-'}</p><p>เลขประจำตัวผู้เสียภาษี: ${data.companyTaxId||'-'}</p></div>
        <div class="receipt-title">ใบเสร็จรับเงิน</div>
        <div class="receipt-details"><div><p><strong>ชื่อลูกค้า:</strong> ${data.customerName||'-'}</p><p><strong>ที่อยู่ลูกค้า:</strong> ${data.customerAddress||'-'}</p><p><strong>เลขประจำตัวผู้เสียภาษีลูกค้า:</strong> ${data.customerTaxId||'-'}</p></div>
        <div><p><strong>เลขที่ใบเสร็จ:</strong> ${data.invoiceNumber||''}</p><p><strong>วันที่ออกใบเสร็จ:</strong> ${data.invoiceDate||''}</p><p><strong>ครบกำหนดชำระ:</strong> ${data.dueDate||'-'}</p></div></div>
        <table class="receipt-table"><thead><tr><th>รายการสินค้า/บริการ</th><th style="width:80px;text-align:right;">จำนวน</th><th style="width:120px;text-align:right;">ราคาต่อหน่วย (บาท)</th><th style="width:140px;text-align:right;">รวม (บาท)</th></tr></thead>
        <tbody>${itemsHtml}<tr class="total-row"><td colspan="3" class="text-right">ยอดรวมทั้งสิ้น</td><td class="text-right">${total.toFixed(2)}</td></tr></tbody></table>
        <div style="display:flex;justify-content:flex-end;margin-top:36px;padding-top:18px;border-top:1px dashed #000;">
          <div style="text-align:center;width:45%;color:#000;">
            ${data.payeeSignatureDataUrl?`<img class="sig-img" src="${data.payeeSignatureDataUrl}" alt="payee signature">`:''}
            <div style="border-bottom:1px solid #000;width:80%;margin:0 auto 8px auto;height:1px;"></div>
            <p style="font-weight:600;">(ลงชื่อผู้รับเงิน ${data.payeeName||''})</p>
            <p style="font-weight:600;">วันที่: ${data.invoiceDate||''}</p>
          </div>
        </div>
        <div style="text-align:center;font-size:1.05rem;color:#000;margin-top:10px;font-weight:600;">ขอบคุณที่อุดหนุนและไว้วางใจเรา</div>
        <div style="text-align:right;color:#000;font-size:.95rem;margin-top:10px;">พิมพ์เมื่อ: ${printDateNow} • พิมพ์โดย ${data.payeeName||'-'}</div>
        ${refCode?`<div class="ref-code">รหัสอ้างอิงเอกสาร: ${refCode}</div>`:''}
      </div></body></html>`); w.document.close();
    }

    if(btn.classList.contains('btn-pdf')){
      try{
        const tmp=document.createElement('div'); tmp.innerHTML=`
          <div class="receipt-container" style="font-family:'Sarabun',sans-serif;padding:40px;width:900px;background:#fff;position:relative;color:#000;">
            <div class="barcode-head" style="position:absolute;top:20px;right:20px;text-align:right;">
              ${barcodeUrl?`<img src="${barcodeUrl}" style="display:block;height:28px;" alt="barcode">`:''}
              ${serial?`<div class="barcode-text" style="font-size:.70rem;letter-spacing:.06em;color:#000;margin-top:2px;">${serial}</div>`:''}
              <div class="copy-mark" style="color:#000;font-size:1.0rem;font-weight:700;margin-top:6px;">(สำเนา)</div>
            </div>
            <div style="text-align:center;border-bottom:2px solid #000;padding-bottom:20px;margin-bottom:30px;">
              <h3 style="font-size:2rem;color:#000;margin:0 0 10px;">${data.companyName||''}</h3>
              <p style="margin:5px 0;color:#000;">${data.companyAddress||''}</p>
              <p style="margin:5px 0;color:#000;">โทรศัพท์: ${data.companyPhone||'-'}</p>
              <p style="margin:5px 0;color:#000;">เลขประจำตัวผู้เสียภาษี: ${data.companyTaxId||'-'}</p>
            </div>
            <div style="background:#f2f2f2;color:#000;padding:12px 15px;border:1px solid #000;border-radius:6px;font-size:1.6rem;font-weight:700;text-align:center;margin:18px 0;">ใบเสร็จรับเงิน</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px;padding:16px;background:#fafafa;border:1px solid #000;border-radius:6px;">
              <div><p><strong>ชื่อลูกค้า:</strong> ${data.customerName||'-'}</p><p><strong>ที่อยู่ลูกค้า:</strong> ${data.customerAddress||'-'}</p><p><strong>เลขประจำตัวผู้เสียภาษีลูกค้า:</strong> ${data.customerTaxId||'-'}</p></div>
              <div><p><strong>เลขที่ใบเสร็จ:</strong> ${data.invoiceNumber||''}</p><p><strong>วันที่ออกใบเสร็จ:</strong> ${data.invoiceDate||''}</p><p><strong>ครบกำหนดชำระ:</strong> ${data.dueDate||'-'}</p></div>
            </div>
            <table style="width:100%;border-collapse:collapse;margin-bottom:24px;border:1px solid #000;border-radius:6px;overflow:hidden;">
              <thead><tr style="background:#e6e6e6;color:#000;border-bottom:1px solid #000;">
                <th style="padding:12px;text-align:left;">รายการสินค้า/บริการ</th>
                <th style="padding:12px;text-align:right;width:80px;">จำนวน</th>
                <th style="padding:12px;text-align:right;width:120px;">ราคาต่อหน่วย (บาท)</th>
                <th style="padding:12px;text-align:right;width:140px;">รวม (บาท)</th></tr></thead>
              <tbody>${itemsHtml}<tr style="background:#e0e0e0;font-weight:700;"><td colspan="3" style="text-align:right;padding:12px;">ยอดรวมทั้งสิ้น</td><td style="text-align:right;padding:12px;">${total.toFixed(2)}</td></tr></tbody></table>
            <div style="display:flex;justify-content:flex-end;margin-top:36px;padding-top:18px;border-top:1px dashed #000;">
              <div style="text-align:center;width:45%;color:#000;">
                ${data.payeeSignatureDataUrl?`<img src="${data.payeeSignatureDataUrl}" style="max-width:80%;max-height:120px;display:block;margin:0 auto 6px auto;filter:grayscale(100%);" alt="payee signature">` : ''}
                <div style="border-bottom:1px solid #000;width:80%;margin:0 auto 8px auto;height:1px;"></div>
                <p style="font-weight:600;">(ลงชื่อผู้รับเงิน ${data.payeeName||''})</p>
                <p style="font-weight:600;">วันที่: ${data.invoiceDate||''}</p>
              </div>
            </div>
            <div style="text-align:center;font-size:1.05rem;color:#000;margin-top:10px;font-weight:600;">ขอบคุณที่อุดหนุนและไว้วางใจเรา</div>
            ${refCode?`<div style="font-size:.85rem;color:#000;margin-top:6px;text-align:left;">รหัสอ้างอิงเอกสาร: ${refCode}</div>`:''}
          </div>`;
        document.body.appendChild(tmp); await document.fonts.ready;
        const el=tmp.querySelector('.receipt-container'); const canvas=await html2canvas(el,{scale:2,useCORS:true,allowTaint:true,backgroundColor:'#ffffff',width:900,windowWidth:900}); document.body.removeChild(tmp);
        const img=canvas.toDataURL('image/png'); const filename=`ใบเสร็จ_${inv}_สำเนา_${new Date().toISOString().split('T')[0]}.pdf`;
        const pw=getPdfPasswordIfAny();
        if(pw){ try{ await pdfMakeDownloadWithPassword(img, filename, pw); } catch(_){ const { jsPDF }=window.jspdf; const pdf=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'}); const imgW=190, imgH=(canvas.height*imgW)/canvas.width; pdf.addImage(img,'PNG',10,10,imgW,imgH); pdf.save(filename); } }
        else{ const { jsPDF }=window.jspdf; const pdf=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'}); const imgW=190, imgH=(canvas.height*imgW)/canvas.width; pdf.addImage(img,'PNG',10,10,imgW,imgH); pdf.save(filename); }
      }catch(err){ console.error(err); alert('ไม่สามารถสร้าง PDF ได้'); }
    }
  });

  /* verify */
  document.getElementById('verifyRefBtn').addEventListener('click',()=>{ const val=normalizeRef(document.getElementById('verifyRefInput').value); renderVerifyResult(verifyByRef(val)); });
  document.getElementById('verifyRefInput').addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); document.getElementById('verifyRefBtn').click(); } });
});
</script>
</body>
</html>
