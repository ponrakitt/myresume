<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Happy New Year from Ponrakit</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Kanit:wght@300;400;600&family=Sarabun:wght@300;400;500&family=Charm:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root {
            --primary: #FF9A9E;
            --secondary: #FECFEF;
            --accent: #a18cd1;
            --paper: #fffdf0;
            --glass: rgba(255, 255, 255, 0.9);
            --shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0; padding: 0;
            background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);
            font-family: 'Sarabun', sans-serif;
            overflow: hidden;
            height: 100dvh; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            user-select: none;
            position: relative;
        }

        /* --- Scenery --- */
        .scenery { position: absolute; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        .cloud {
            position: absolute; background: white; border-radius: 50px; opacity: 0.6;
            animation: floatCloud 25s linear infinite;
        }
        .c1 { width: 100px; height: 40px; top: 15%; left: -20%; }
        .c2 { width: 150px; height: 60px; top: 25%; left: -20%; animation-duration: 30s; animation-delay: 5s; }
        @keyframes floatCloud { 100% { left: 110%; } }

        /* --- Bird & Mailbox --- */
        .mailbox-container {
            position: absolute; 
            bottom: 30%; 
            left: 50%;
            transform: translateX(-50%); 
            z-index: 5; 
            text-align: center;
            width: 100%;
        }
        .bird-wrapper {
            font-size: 80px; 
            color: #fff;
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2));
            transition: transform 0.3s; 
            cursor: pointer;
            position: relative;
            display: inline-block;
        }
        .bird-wrapper:active { transform: scale(0.95); }
        
        .bird-fly { animation: flyIn 2s ease-out forwards, hoverBird 3s ease-in-out infinite 2s; }
        .bird-stand { animation: hoverBird 4s ease-in-out infinite; }
        .bird-sleep { transform: rotate(5deg) scale(0.9); color: #ddd; }
        
        .letter-icon {
            position: absolute; font-size: 30px; color: #ff6b6b;
            bottom: 5px; right: -5px; background: white;
            border-radius: 8px; padding: 4px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        @keyframes flyIn { 0% { transform: translate(-100vw, -20vh) scale(0.5); } 100% { transform: translate(0, 0) scale(1); } }
        @keyframes hoverBird { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* --- Menu Bar --- */
        .menu-bar {
            position: absolute; 
            bottom: 30px; 
            width: 100%;
            display: flex; 
            justify-content: center; 
            gap: 10px; 
            z-index: 10;
            padding: 0 20px;
        }
        .action-btn {
            padding: 12px 20px; 
            border: none; 
            border-radius: 50px;
            background: rgba(255,255,255,0.95); 
            color: #555;
            font-family: 'Kanit', sans-serif; 
            font-size: 0.95rem; 
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
            transition: all 0.2s;
            display: flex; align-items: center; gap: 6px;
            white-space: nowrap;
        }
        .action-btn:active { transform: scale(0.95); }
        .btn-siamsi { color: #d35400; font-weight: bold; }
        .btn-collection { color: #2980b9; }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
            z-index: 100; display: none; justify-content: center; align-items: center;
            padding: 15px;
        }

        /* --- Siamsi Paper Layout --- */
        .siamsi-scroll-container {
            max-height: 85vh; 
            overflow-y: auto; 
            width: 100%; 
            display: flex; 
            justify-content: center; 
            perspective: 1000px;
            padding-bottom: 80px; 
        }
        
        .siamsi-paper {
            background: var(--paper); 
            width: 100%; 
            max-width: 400px; 
            padding: 20px 15px; 
            margin: 10px 0; 
            border-radius: 4px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            background-image: url('https://www.transparenttextures.com/patterns/cream-paper.png');
            position: relative; 
            border: 1px solid #e0d0b0;
            overflow: hidden;
        }
        .siamsi-paper::before, .siamsi-paper::after {
            content: ''; position: absolute; left: 10px; right: 10px; height: 2px;
            background: #d35400; opacity: 0.3;
        }
        .siamsi-paper::before { top: 10px; } .siamsi-paper::after { bottom: 10px; }

        /* Fire Animation */
        .fire-overlay {
            position: absolute; top: 100%; left: 0; width: 100%; height: 120%;
            background: linear-gradient(to top, rgba(255,69,0,0.8) 0%, rgba(255,165,0,0.6) 40%, transparent 80%);
            mix-blend-mode: hard-light; pointer-events: none; z-index: 10; opacity: 0;
        }
        @keyframes consumeFire { 0% { top: 100%; opacity: 1; } 100% { top: -120%; opacity: 0; } }
        @keyframes turnToAsh {
            0% { filter: brightness(1); transform: scale(1); }
            30% { filter: brightness(1.2) sepia(0.5) contrast(1.2); background-color: #ffecb3; }
            60% { filter: brightness(0.7) sepia(1) contrast(2) hue-rotate(-20deg); background-color: #5d4037; color: #ccc; }
            100% { filter: brightness(0) grayscale(1); transform: scale(0.9) translateY(-50px); opacity: 0; }
        }
        .burning .fire-overlay { animation: consumeFire 1.8s forwards ease-in-out; }
        .burning { animation: turnToAsh 1.8s forwards ease-in-out; pointer-events: none; }

        /* Typography */
        .siamsi-header { text-align: center; border-bottom: 2px double #d35400; padding-bottom: 10px; margin-bottom: 15px; }
        .siamsi-no { font-family: 'Charm', cursive; font-size: 2.2rem; color: #d35400; font-weight: bold; line-height: 1; }
        .siamsi-title { font-family: 'Kanit'; color: #555; font-size: 0.9rem; }
        .section-title { font-family: 'Kanit'; font-weight: bold; color: #8e44ad; font-size: 0.95rem; margin-bottom: 2px; border-left: 3px solid #8e44ad; padding-left: 6px; }
        .section-text { font-size: 0.85rem; line-height: 1.5; color: #333; text-align: justify; margin-bottom: 12px; }
        .luck-stat { text-align: center; margin-top: 15px; padding: 10px; background: rgba(255,235,59,0.2); border-radius: 10px; border: 1px dashed #f1c40f; }
        .luck-percent { font-size: 1.8rem; color: #d35400; font-weight: bold; font-family: 'Kanit'; }

        /* Footer Buttons */
        .modal-footer {
            position: fixed; bottom: 20px; width: 100%; 
            display: flex; justify-content: center; gap: 8px; z-index: 200; pointer-events: none;
            padding: 0 15px;
        }
        .modal-footer button { pointer-events: auto; padding: 10px 15px; font-size: 0.85rem; box-shadow: 0 4px 10px rgba(0,0,0,0.2); flex-shrink: 0; }
        .btn-burn { background: #c0392b; color: white; }
        .btn-keep { background: #27ae60; color: white; }
        .btn-download { background: #2980b9; color: white; }

        /* Toast Notification */
        .status-toast {
            position: fixed; top: 15px; left: 15px; right: 15px; max-width: 300px; margin: 0 auto; 
            background: rgba(0, 0, 0, 0.9); color: white; padding: 12px 20px;
            border-radius: 50px; display: flex; align-items: center; justify-content: center; gap: 10px;
            z-index: 2000; transform: translateY(-150%); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-family: 'Kanit', sans-serif; box-shadow: 0 5px 15px rgba(0,0,0,0.2); font-size: 0.9rem;
        }
        .status-toast.show { transform: translateY(0); }

        /* Collection Grid */
        .collection-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 20px; max-height: 60vh; overflow-y: auto; padding-right: 2px; }
        .col-item { background: white; padding: 8px; border-radius: 6px; text-align: center; cursor: pointer; border: 1px solid #eee; position: relative; }
        .col-no { font-size: 1.2rem; font-weight: bold; color: #d35400; font-family: 'Charm'; }
        .col-date { font-size: 0.65rem; color: #999; margin-top: 2px; }

        @media (min-width: 768px) {
            .bird-wrapper { font-size: 100px; }
            .collection-grid { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); }
            .status-toast { left: 20px; right: auto; transform: translateX(-200%); }
            .status-toast.show { transform: translateX(0); }
            .action-btn { font-size: 1rem; padding: 12px 25px; }
            .siamsi-paper { padding: 30px; }
            .siamsi-no { font-size: 3rem; }
            .section-text { font-size: 1rem; }
        }
    </style>
</head>
<body>

    <div class="status-toast" id="statusToast">
        <i id="statusIcon" class="fa-solid fa-circle-notch fa-spin"></i>
        <span id="statusText">กำลังโหลด...</span>
    </div>

    <div class="scenery">
        <div class="cloud c1"></div>
        <div class="cloud c2"></div>
    </div>

    <div class="mailbox-container">
        <div class="bird-wrapper" id="bird" onclick="handleBirdClick()">
            </div>
    </div>

    <div class="menu-bar">
        <button class="action-btn btn-siamsi" onclick="openShakeModal()">
            <i class="fa-solid fa-dice-d20"></i> เสี่ยงเซียมซี
        </button>
        <button class="action-btn btn-collection" onclick="openCollection()">
            <i class="fa-solid fa-book-bookmark"></i> กระเป๋า
        </button>
    </div>

    <div class="modal-overlay" id="browserWarningModal" style="z-index: 9999;">
        <div class="siamsi-paper" style="text-align: center; max-width: 350px;">
            <i class="fa-solid fa-triangle-exclamation" style="font-size: 3rem; color: #f1c40f; margin-bottom: 15px;"></i>
            <h3 style="font-family: 'Kanit'; margin: 0 0 10px 0;">แนะนำให้เปิดใน Browser หลัก</h3>
            <p style="font-size: 0.9rem; color: #555; line-height: 1.5;">
                เพื่อประสบการณ์ที่ดีที่สุด โปรดเปิดผ่าน<br>
                <i class="fa-brands fa-chrome" style="color:#4285F4"></i> Chrome, 
                <i class="fa-brands fa-firefox" style="color:#FF7139"></i> Firefox หรือ 
                <i class="fa-brands fa-safari" style="color:#00ACED"></i> Safari
            </p>
            
            <div style="background: #eee; padding: 10px; border-radius: 8px; margin: 15px 0; word-break: break-all; font-family: monospace; font-size: 0.85rem; user-select: all; border: 1px dashed #ccc;">
                https://ponrakitt.site/new-year
            </div>

            <button class="action-btn" onclick="copyLink()" style="width: 100%; justify-content: center; background: #2c3e50; color: white; margin-bottom: 8px;">
                <i class="fa-solid fa-copy"></i> คัดลอกลิ้งก์
            </button>
            <button class="action-btn" onclick="closeModal('browserWarningModal')" style="width: 100%; justify-content: center; background: transparent; color: #999; border: 1px solid #ddd; box-shadow: none;">
                ปิดคำเตือน
            </button>
        </div>
    </div>

    <div class="modal-overlay" id="letterModal">
        <div class="siamsi-paper">
            <div style="text-align: center; margin-bottom: 15px; color:#ff6b6b; font-size: 1.8rem;">
                <i class="fa-solid fa-envelope-open-text"></i>
            </div>
            <h2 style="text-align: center; font-family: 'Kanit'; color: #333; font-size: 1.5rem; margin-top:0;">สวัสดีปีใหม่ 2569</h2>
            <div class="letter-content" id="letterText" style="font-size: 1rem; line-height: 1.6; color: #444;"></div>
            <div class="signature" style="font-size: 1.5rem;">จาก Ponrakit</div>
            <div style="text-align: center; margin-top: 25px;">
                <button class="action-btn" onclick="closeModal('letterModal')" style="background:#555; color:white; width:100%; justify-content:center;">เก็บใส่กระเป๋า</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="shakeModal">
        <div style="background: white; padding: 30px 20px; border-radius: 15px; text-align: center; width: 90%; max-width: 300px;">
            <h2 style="font-family: 'Kanit'; margin-top:0;">ตั้งจิตอธิษฐาน</h2>
            <div id="shakeIcon" style="font-size: 70px; color: #d35400; margin: 20px 0;">
                <i class="fa-solid fa-prescription-bottle"></i>
            </div>
            <p style="color:#666; font-size: 0.9rem;">เขย่าเพื่อดูคำทำนายประจำปีนี้</p>
            <div style="display:flex; gap:10px; justify-content:center; margin-top: 20px;">
                <button class="action-btn" onclick="shakeSiamsi()" style="background:#d35400; color:white; flex:1; justify-content:center;">เขย่าเลย!</button>
                <button class="action-btn" onclick="closeModal('shakeModal')" style="flex:1; justify-content:center;">ยกเลิก</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="resultModal">
        <div class="siamsi-scroll-container">
            <div class="siamsi-paper" id="siamsiCard">
                <div class="fire-overlay"></div>
                <div id="siamsiContent"></div>
            </div>
        </div>
        <div class="modal-footer" id="resultButtons"></div>
    </div>

    <div class="modal-overlay" id="collectionModal">
        <div class="siamsi-paper" style="height: 70vh; display: flex; flex-direction: column;">
            <h2 style="font-family: 'Kanit'; text-align: center; margin-top:0; font-size:1.4rem;">กระเป๋าเก็บเซียมซี</h2>
            <div style="text-align:center; font-size:0.75rem; color:#999; margin-bottom:10px;">
                <i class="fa-solid fa-clock-rotate-left"></i> หมดอายุใน 90 วัน
            </div>
            <div id="collectionList" class="collection-grid"></div>
            <div style="margin-top: auto; text-align: center; padding-top: 15px;">
                <button class="action-btn" onclick="closeModal('collectionModal')" style="width:100%; justify-content:center;">ปิด</button>
            </div>
        </div>
    </div>

    <script>
        // --- Configurations ---
        const CURRENT_YEAR = new Date().getFullYear(); 
        const LETTER_CONTENT_KEY = `ponrakit_letter_content_${CURRENT_YEAR}`;
        const COLLECTION_KEY = `ponrakit_siamsi_collection_${CURRENT_YEAR}`;
        const EXPIRY_DAYS = 90; 

        // --- Browser Detection & Copy Link ---
        function checkBrowser() {
            const ua = navigator.userAgent;
            const isChrome = ua.indexOf("Chrome") > -1;
            const isFirefox = ua.indexOf("Firefox") > -1;
            const isSafari = ua.indexOf("Safari") > -1 && ua.indexOf("Chrome") === -1;
            
            // Detect In-App Browsers (Line, FB, IG)
            const isLine = ua.indexOf("Line") > -1;
            const isFB = ua.indexOf("FB") > -1 || ua.indexOf("Instagram") > -1;

            // Logic: ถ้าเป็น Line/FB หรือ ไม่ใช่ Chrome/Firefox/Safari ให้เตือน
            // (Note: Edge/Opera มักจะมี Chrome ติดมาใน UA ทำให้ผ่านเงื่อนไข Chrome ซึ่ง OK)
            if (isLine || isFB || (!isChrome && !isFirefox && !isSafari)) {
                document.getElementById('browserWarningModal').style.display = 'flex';
            }
        }

        function copyLink() {
            const url = "https://ponrakitt.site/new-year";
            
            // Modern API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(url).then(() => {
                    showToast("คัดลอกลิ้งก์แล้ว", "success");
                    hideToast(2000);
                }).catch(err => fallbackCopy(url));
            } else {
                fallbackCopy(url);
            }
        }

        function fallbackCopy(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";  // Avoid scrolling to bottom
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showToast("คัดลอกลิ้งก์แล้ว", "success");
                hideToast(2000);
            } catch (err) {
                showToast("ไม่สามารถคัดลอกได้", "error");
                hideToast(2000);
            }
            document.body.removeChild(textArea);
        }

        // --- Data Banks ---
        const phrases = {
            work: [
                ["การงานปีนี้เหมือนเรือแล่นตามน้ำ", "อุปสรรคที่มีจะคลี่คลายอย่างน่าอัศจรรย์", "ผู้ใหญ่จะให้ความเมตตาเอ็นดูเป็นพิเศษ", "ระวังเรื่องเอกสารสัญญาให้รอบคอบ"],
                ["ต้นปีงานหนักหน่อยแต่ปลายปีสดใส", "ผลลัพธ์ที่ได้จะคุ้มค่าความเหนื่อย", "มีเกณฑ์เลื่อนขั้นหรือได้โปรเจกต์ใหม่", "เพื่อนร่วมงานช่วยแบ่งเบาภาระได้ดี"],
                ["ปีแห่งการเริ่มต้นใหม่ที่ดีเยี่ยม", "ใครคิดย้ายงานหรือทำธุรกิจถือเป็นฤกษ์ดี", "ระวังขัดแย้งกับหุ้นส่วนเล็กน้อย", "ใช้สติเจรจาแล้วทุกอย่างจะราบรื่น"],
                ["งานมั่นคงแต่คู่แข่งกำลังจ้องมอง", "ต้องขยันพัฒนาทักษะใหม่ๆ เพิ่มเติม", "ความละเอียดคือหัวใจสู่ความสำเร็จ", "อย่าประมาทในเรื่องเล็กๆ น้อยๆ"],
                ["ภาระดูหนักเกินตัวในช่วงแรก", "จัดลำดับความสำคัญให้ดีจะผ่านไปได้", "มีโอกาสเดินทางไกลเพราะเรื่องงาน", "การเจรจาต่อรองจะสำเร็จเกินคาด"]
            ],
            finance: [
                ["การเงินคล่องตัวดีมาก", "มีเกณฑ์ได้โชคลาภลอยมาไม่ทันตั้งตัว", "ระวังการใช้จ่ายตามใจปาก", "ควรแบ่งเก็บออมเพื่ออนาคต"],
                ["รายรับเข้ามาเรื่อยๆ ไม่ขาดสาย", "แต่รายจ่ายก็มีมารอเป็นเงาตามตัว", "งดให้คนยืมเงินเด็ดขาด", "ศึกษาข้อมูลก่อนลงทุนให้ดี"],
                ["มีเกณฑ์เสียเงินก้อนใหญ่ซื้อทรัพย์สิน", "เป็นการสร้างความมั่นคงระยะยาว", "โชคลาภมาจากเลขใกล้ตัว", "ระวังของมีค่าสูญหาย"],
                ["สภาพคล่องดีกว่าปีก่อนมาก", "เคลียร์หนี้สินได้บางส่วนหรือทั้งหมด", "มีช่องทางทำรายได้เสริมใหม่ๆ", "เหมาะแก่การเก็บออมสร้างตัว"],
                ["ระวังใช้จ่ายฟุ่มเฟือยเกินจำเป็น", "อาจมีรายจ่ายฉุกเฉินเรื่องรถ/บ้าน", "ภาพรวมยังประคองตัวได้ดี", "เสี่ยงโชคพอหอมปากหอมคอ"]
            ],
            love: [
                ["คนโสดจะพบรักกับคนอายุน้อยกว่า", "เริ่มจากเพื่อนแล้วค่อยๆ พัฒนา", "คนมีคู่ระวังหึงหวงเกินเหตุ", "เชื่อใจกันแล้วรักจะยืนยาว"],
                ["ความรักสดใสเหมือนดอกไม้ยามเช้า", "คนโสดเจอคนถูกใจในงานสังคม", "คนมีคู่มีเกณฑ์วางแผนอนาคต", "หมั่นเติมความหวานอย่าให้ขาด"],
                ["มีเรื่องพ่อแง่แม่งอนบ้างเล็กน้อย", "ปรับความเข้าใจกันได้ด้วยดี", "คนโสดให้รักตัวเองไปก่อน", "เนื้อคู่ยังเดินทางมาไม่ถึง"],
                ["เสน่ห์แรงมาก มีคนมาจีบเยอะ", "ดูให้ดีว่าใครจริงใจหรือแค่ผ่านมา", "คนมีคู่ระวังมือที่สาม", "หนักแน่นแล้วจะผ่านไปได้"],
                ["ความรักราบรื่น เข้าใจกันดี", "คู่รักช่วยส่งเสริมเรื่องงานเงิน", "คนโสดมีลุ้นพบรักต่างแดน", "ความรักนำพาความสุขมาให้"]
            ],
            health: [
                ["สุขภาพแข็งแรงดีไม่มีน่าห่วง", "ระวังพักผ่อนไม่เพียงพอ", "อาจปวดเมื่อยจากการทำงาน", "หาเวลาออกกำลังกายบ้าง"],
                ["ระวังภูมิแพ้หรือหวัดกำเริบ", "อากาศเปลี่ยนต้องดูแลตัวเอง", "เลี่ยงที่แออัดและฝุ่นควัน", "ทานอาหารที่มีประโยชน์ช่วยได้"],
                ["ระวังอุบัติเหตุจากความซุ่มซ่าม", "ขับรถอย่าประมาทเด็ดขาด", "สุขภาพจิตดีเพราะปล่อยวางเก่ง", "นั่งสมาธิช่วยให้จิตใจสงบ"],
                ["ระวังน้ำหนักตัวเพิ่มเร็ว", "คุมอาหาร ลดหวานมันเค็ม", "ตรวจสุขภาพประจำปีบ้าง", "ภาพรวมยังแข็งแรงดี"],
                ["เครียดสะสมทำให้นอนไม่หลับ", "หากิจกรรมผ่อนคลายก่อนนอน", "ระวังสายตาจากจอคอม", "ไปพักผ่อนตากอากาศบ้าง"]
            ],
            study: [
                ["หัวสมองแล่นไว จำแม่น", "เข้าใจเนื้อหาได้ง่ายขึ้น", "สอบผ่านหรือได้รับคัดเลือก", "ขยันทบทวนสม่ำเสมอ"],
                ["กดดันบ้างแต่จะทำได้ดี", "ตั้งสติและพยายามให้เต็มที่", "คุ้มค่ากับความเหนื่อยแน่นอน", "เพื่อนคอยช่วยติวให้ผ่านได้"],
                ["เหมาะแก่การเรียนรู้สิ่งใหม่", "ไปดูงานหรือแลกเปลี่ยนดีมาก", "ระวังขี้เกียจงานจะค้าง", "จัดตารางอ่านหนังสือให้ดี"],
                ["ผลการเรียนน่าพอใจ", "มีลุ้นทุนการศึกษาหรือรางวัล", "อย่าหลงระเริงจนประมาท", "รักษามาตรฐานความขยันไว้"],
                ["มีอุปสรรคช่วงแรกแต่จะผ่านได้", "ความมุมานะช่วยให้สำเร็จ", "ระวังขัดแย้งตอนทำงานกลุ่ม", "รับฟังคนอื่นงานจะราบรื่น"]
            ]
        };

        const letterGreetings = [
             "สวัสดีปีใหม่! ขอให้ปีนี้ใจดีกับคุณมากๆ \nขอให้โลกเหวี่ยงแต่คนดีๆ เข้ามา \nการงานก้าวหน้า การเงินมั่งคั่ง \nและยิ้มได้กว้างๆ ในทุกๆ วัน",
            "Happy New Year! เริ่มต้นใหม่อย่างสดใส \nทิ้งความทุกข์ไว้ปีเก่า \nขอให้สุขภาพแข็งแรงทั้งกายใจ \nร่ำรวยความสุขและเงินทอง",
            "ขอให้ปีนี้เป็นปีทองของคุณ \nหยิบจับอะไรก็เป็นเงินเป็นทอง \nความรักหวานชื่น ครอบครัวอบอุ่น \nสมความปรารถนาทุกประการ",
            "แด่คนเก่ง... ปีนี้ขอให้เก่งและแกร่งกว่าเดิม \nอุปสรรคทำอะไรคุณไม่ได้ \nประสบความสำเร็จในสิ่งที่ตั้งใจ \nเหนื่อยก็พัก แล้วลุยต่อนะ!",
            "สุขสันต์วันปีใหม่! \nขอให้มีอิสระทางการเงิน \nได้ไปเที่ยวที่อยากไป \nกินของอร่อยๆ \nมีความสุขกับเรื่องเรียบง่าย",
            "ปีใหม่นี้ ขอให้ค้นพบเวอร์ชันที่ดีที่สุด \nมั่นใจ มีสติ และมีปัญญา \nทุกการตัดสินใจนำไปสู่สิ่งดีๆ \nเป็นกำลังใจให้เสมอครับ",
            "ขอสิ่งศักดิ์สิทธิ์คุ้มครอง \nแคล้วคลาดปลอดภัยจากภยันตราย \nโรคภัยไข้เจ็บอย่าได้แผ้วพาน \nชีวิตราบรื่นดั่งสายน้ำเย็น",
            "ปีแห่งโอกาสและการเติบโต \nโอกาสในการรักและสร้างสรรค์ \nขอให้คว้ามันไว้ได้ทั้งหมด \nมีความสุขตลอดปีตลอดไป",
            "ยิ้มรับปีใหม่ด้วยใจเบิกบาน \nหนี้สินลดลง เงินเก็บเพิ่มพูน \nเจอแต่มิตรแท้ เพื่อนร่วมงานดี \nหัวหน้าเมตตา ลูกน้องเคารพ",
            "ส่งท้ายปีเก่า ต้อนรับสิ่งดีๆ \nขอให้ฝันเป็นจริงในปีนี้ \nไม่ว่าจะบ้าน รถ หรือความสำเร็จ \nคุณทำได้แน่นอน สู้ๆ!"
        ];

        let currentSiamsi = null;
        let viewingIndex = -1;

        // --- Toast System ---
        function showToast(message, type = 'loading') {
            const toast = document.getElementById('statusToast');
            const text = document.getElementById('statusText');
            const icon = document.getElementById('statusIcon');
            text.innerText = message;
            icon.className = "fa-solid";
            if(type === 'loading') icon.classList.add('fa-circle-notch', 'fa-spin');
            else if (type === 'success') icon.classList.add('fa-circle-check');
            else if (type === 'error') icon.classList.add('fa-circle-exclamation');
            toast.classList.add('show');
        }
        function hideToast(delay = 0) {
            setTimeout(() => { document.getElementById('statusToast').classList.remove('show'); }, delay);
        }

        // --- Core Functions ---
        function generateFullSiamsi() {
            const id = Math.floor(Math.random() * 50) + 1;
            const luck = Math.floor(Math.random() * 41) + 60; 
            const luckyNum = Math.floor(Math.random() * 100).toString().padStart(2, '0');
            const w = phrases.work[Math.floor(Math.random() * 5)].join(" ");
            const f = phrases.finance[Math.floor(Math.random() * 5)].join(" ");
            const l = phrases.love[Math.floor(Math.random() * 5)].join(" ");
            const h = phrases.health[Math.floor(Math.random() * 5)].join(" ");
            const s = phrases.study[Math.floor(Math.random() * 5)].join(" ");
            return { id: id, luckPercent: luck, luckyNum: luckyNum, work: w, finance: f, love: l, health: h, study: s, timestamp: new Date().toLocaleDateString('th-TH'), createdAt: Date.now() };
        }

        function checkDateAndState() {
            checkBrowser(); // Run Browser Check First
            cleanupCollection();
            const today = new Date();
            // const isPromo = (today.getMonth() === 0 && today.getDate() >= 1 && today.getDate() <= 5);
            const isPromo = true; 

            const bird = document.getElementById('bird');
            const savedContent = localStorage.getItem(LETTER_CONTENT_KEY);

            if (isPromo) {
                if (savedContent) {
                    bird.innerHTML = `<i class="fa-solid fa-dove"></i>`;
                    bird.className = 'bird-wrapper bird-stand';
                } else {
                    bird.innerHTML = `<i class="fa-solid fa-dove"></i><div class="letter-icon"><i class="fa-solid fa-envelope"></i></div>`;
                    bird.className = 'bird-wrapper bird-fly';
                }
                bird.onclick = openLetter;
            } else {
                bird.innerHTML = `<i class="fa-solid fa-crow bird-sleep"></i><div style="position:absolute; top:-20px; right:-20px; font-size:1rem;">Zzz..</div>`;
                bird.className = 'bird-wrapper';
                bird.onclick = () => alert(`ขออภัย จดหมายหมดแล้วจ้า\nจะส่งอีกครั้ง 1 ม.ค. ${CURRENT_YEAR + 1}`);
            }
        }

        function cleanupCollection() {
            const raw = localStorage.getItem(COLLECTION_KEY);
            if(!raw) return;
            let collection = JSON.parse(raw);
            const now = Date.now();
            const expiryTime = EXPIRY_DAYS * 24 * 60 * 60 * 1000;
            const validCollection = collection.filter(item => {
                if(!item.createdAt) return true; 
                return (now - item.createdAt) < expiryTime;
            });
            if(collection.length !== validCollection.length) {
                localStorage.setItem(COLLECTION_KEY, JSON.stringify(validCollection));
            }
        }

        // --- Interaction Logic ---
        function openLetter() {
            const modal = document.getElementById('letterModal');
            const textEl = document.getElementById('letterText');
            let content = localStorage.getItem(LETTER_CONTENT_KEY);
            if (!content) {
                content = letterGreetings[Math.floor(Math.random() * letterGreetings.length)];
                localStorage.setItem(LETTER_CONTENT_KEY, content);
                checkDateAndState();
            }
            textEl.innerText = content;
            modal.style.display = 'flex';
        }

        function openShakeModal() { document.getElementById('shakeModal').style.display = 'flex'; }

        function shakeSiamsi() {
            const icon = document.getElementById('shakeIcon');
            icon.style.animation = 'hoverBird 0.5s ease-in-out infinite';
            setTimeout(() => {
                icon.style.animation = '';
                closeModal('shakeModal');
                showResult(null, -1); 
            }, 1500);
        }

        function showResult(savedData = null, index = -1) {
            viewingIndex = index;
            currentSiamsi = savedData || generateFullSiamsi();
            const content = document.getElementById('siamsiContent');
            content.innerHTML = `
                <div class="siamsi-header"><div class="siamsi-title">ใบเซียมซีที่</div><div class="siamsi-no">${currentSiamsi.id}</div></div>
                <div class="siamsi-section"><div class="section-title">การงาน</div><div class="section-text">${currentSiamsi.work}</div></div>
                <div class="siamsi-section"><div class="section-title">การเงิน</div><div class="section-text">${currentSiamsi.finance}</div></div>
                <div class="siamsi-section"><div class="section-title">ความรัก</div><div class="section-text">${currentSiamsi.love}</div></div>
                <div class="siamsi-section"><div class="section-title">สุขภาพ</div><div class="section-text">${currentSiamsi.health}</div></div>
                <div class="siamsi-section"><div class="section-title">การเรียน</div><div class="section-text">${currentSiamsi.study}</div></div>
                <div class="luck-stat"><div>ความโชคดีโดยรวม</div><div class="luck-percent">${currentSiamsi.luckPercent}%</div><div style="font-size:0.8rem; color:#666; margin-top:5px;">เลขนำโชค: <strong>${currentSiamsi.luckyNum}</strong></div></div>
                <div style="text-align:center; margin-top:15px; font-size:0.75rem; color:#aaa;">คำทำนายจาก Ponrakit | ${currentSiamsi.timestamp}</div>
            `;
            const card = document.getElementById('siamsiCard');
            card.classList.remove('burning');
            
            const btnContainer = document.getElementById('resultButtons');
            if (viewingIndex >= 0) {
                btnContainer.innerHTML = `
                    <button class="action-btn btn-download" onclick="downloadImageOnly()"><i class="fa-solid fa-download"></i> โหลดรูป</button>
                    <button class="action-btn btn-burn" onclick="deleteFromCollection(${viewingIndex})"><i class="fa-solid fa-trash"></i> ลบ</button>
                    <button class="action-btn" onclick="closeModal('resultModal')" style="width: 50px; justify-content: center;"><i class="fa-solid fa-xmark"></i></button>
                `;
            } else {
                btnContainer.innerHTML = `
                    <button class="action-btn btn-keep" onclick="saveAndDownload()"><i class="fa-solid fa-download"></i> รับใบนี้</button>
                    <button class="action-btn btn-burn" onclick="burnSiamsi()"><i class="fa-solid fa-fire"></i> เผา</button>
                    <button class="action-btn" onclick="closeModal('resultModal')" style="width: 50px; justify-content: center;"><i class="fa-solid fa-xmark"></i></button>
                `;
            }
            document.getElementById('resultModal').style.display = 'flex';
        }

        // --- Actions ---
        function saveAndDownload() {
            let collection = JSON.parse(localStorage.getItem(COLLECTION_KEY) || "[]");
            collection.unshift(currentSiamsi); 
            localStorage.setItem(COLLECTION_KEY, JSON.stringify(collection));
            downloadImageOnly(true);
        }

        function downloadImageOnly(isSaving = false) {
            const card = document.getElementById('siamsiCard');
            card.querySelector('.fire-overlay').style.display = 'none';
            showToast('กำลังสร้างรูป...', 'loading');
            html2canvas(card, { scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Siamsi_Ponrakit_No${currentSiamsi.id}.jpg`;
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                link.click();
                if(isSaving) {
                    showToast('บันทึกเรียบร้อย!', 'success');
                    setTimeout(() => { closeModal('resultModal'); hideToast(); }, 1500);
                } else {
                    showToast('โหลดเสร็จสิ้น', 'success');
                    hideToast(2000);
                }
                card.querySelector('.fire-overlay').style.display = 'block';
            }).catch(err => {
                showToast('เกิดข้อผิดพลาด', 'error');
                hideToast(3000);
                card.querySelector('.fire-overlay').style.display = 'block';
            });
        }

        function deleteFromCollection(index) {
            if(!confirm("ต้องการลบใบเซียมซีนี้?")) return;
            let collection = JSON.parse(localStorage.getItem(COLLECTION_KEY) || "[]");
            collection.splice(index, 1);
            localStorage.setItem(COLLECTION_KEY, JSON.stringify(collection));
            closeModal('resultModal');
            openCollection();
        }

        function burnSiamsi() {
            const card = document.getElementById('siamsiCard');
            card.classList.add('burning');
            setTimeout(() => { closeModal('resultModal'); }, 1800); 
        }

        // --- Collection View ---
        function openCollection() {
            cleanupCollection();
            const list = document.getElementById('collectionList');
            const collection = JSON.parse(localStorage.getItem(COLLECTION_KEY) || "[]");
            list.innerHTML = '';
            if (collection.length === 0) {
                list.innerHTML = `<div class="empty-msg" style="grid-column: 1/-1;">ยังไม่มีใบเซียมซี</div>`;
            } else {
                collection.forEach((item, index) => {
                    const el = document.createElement('div');
                    el.className = 'col-item';
                    const daysOld = Math.floor((Date.now() - (item.createdAt || Date.now())) / (1000 * 60 * 60 * 24));
                    const daysLeft = EXPIRY_DAYS - daysOld;
                    el.innerHTML = `
                        <div class="col-no">${item.id}</div>
                        <div class="col-date">${item.timestamp}</div>
                        <div style="font-size:0.7rem; color:${item.luckPercent >= 80 ? 'green' : 'orange'};">โชค ${item.luckPercent}%</div>
                        <div style="font-size:0.6rem; color:#ccc; margin-top:2px;">เหลือ ${daysLeft} วัน</div>
                    `;
                    el.onclick = () => { closeModal('collectionModal'); showResult(item, index); };
                    list.appendChild(el);
                });
            }
            document.getElementById('collectionModal').style.display = 'flex';
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function handleBirdClick() { /* Handled in checkState */ }

        window.onload = checkDateAndState;

    </script>
    <!--Start of Tawk.to Script-->
<script type="text/javascript">
var Tawk_API=Tawk_API||{}, Tawk_LoadStart=new Date();
(function(){
var s1=document.createElement("script"),s0=document.getElementsByTagName("script")[0];
s1.async=true;
s1.src='https://embed.tawk.to/6927a795f7575c1961e05edd/1jb1ed81p';
s1.charset='UTF-8';
s1.setAttribute('crossorigin','*');
s0.parentNode.insertBefore(s1,s0);
})();
</script>
<!--End of Tawk.to Script-->
</body>
</html>
